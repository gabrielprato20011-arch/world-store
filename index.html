<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Sistema World Store v9.3 Final</title>
    
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;600;700;800&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary: #C62828;
            --dark: #121212;
            --bg: #f4f7f6;
            --sidebar-width: 270px;
            --nav-height-mobile: 65px;
        }

        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; font-family: 'Montserrat', sans-serif; background: var(--bg); color: #333; height: 100vh; height: 100dvh; overflow: hidden; display: flex; overscroll-behavior: none; }

        /* BANNER */
        #globalBanner { display: none; background: #FFD54F; color: #333; text-align: center; padding: 8px; font-weight: bold; font-size: 0.85rem; width: 100%; z-index: 1000; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }

        /* SIDEBAR */
        aside { width: var(--sidebar-width); background: var(--dark); color: white; display: flex; flex-direction: column; height: 100%; z-index: 50; box-shadow: 4px 0 15px rgba(0,0,0,0.1); }
        .brand { padding: 30px 20px; text-align: center; background: rgba(0,0,0,0.2); }
        #displayLogoSidebar { width: 90px; height: 90px; object-fit: contain; border-radius: 50%; margin: 0 auto 10px auto; border: 3px solid rgba(255,255,255,0.2); display:none; background:white; }
        .brand h1 { margin: 0; font-size: 1.4rem; font-weight: 800; letter-spacing: 1px; }
        .nav-menu { flex: 1; padding: 20px 0; overflow-y: auto; }
        .nav-item { padding: 15px 25px; cursor: pointer; display: flex; align-items: center; gap: 15px; color: #aaa; transition: 0.2s; font-size: 0.95rem; }
        .nav-item:hover { background: rgba(255,255,255,0.05); color: white; }
        .nav-item.active { background: rgba(255,255,255,0.1); color: #FFD54F; border-left: 4px solid var(--primary); font-weight: 700; }
        .sys-info { padding: 15px; font-size: 0.7rem; text-align: center; color: #666; border-top: 1px solid rgba(255,255,255,0.1); }

        /* MAIN */
        main { flex: 1; position: relative; display: flex; flex-direction: column; overflow: hidden; width: 100%; height: 100%; }
        
        header { height: 70px; background: white; border-bottom: 1px solid #ddd; display: flex; align-items: center; justify-content: space-between; padding: 0 20px; gap: 15px; flex-shrink: 0; }
        .mobile-brand { display: none; align-items: center; gap: 10px; }
        .mobile-brand img { width: 40px; height: 40px; border-radius: 50%; border:1px solid #eee; object-fit: contain; background: white;}
        .mobile-brand h2 { font-size: 1.1rem; font-weight: 800; color: var(--dark); margin: 0; line-height: 1; }
        .search-wrap { position: relative; flex: 1; max-width: 400px; }
        .search-wrap input { width: 100%; padding: 10px 15px 10px 35px; border-radius: 50px; border: 1px solid #ddd; background: #f9f9f9; font-size: 0.9rem;}
        .search-wrap i { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: #999; }
        .filter-group { display: flex; gap: 5px; overflow-x: auto; padding-bottom: 5px; scrollbar-width: none; }
        .chip { padding: 6px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: 600; cursor: pointer; background: white; border: 1px solid #eee; white-space: nowrap; transition:0.2s;}
        .chip.active { background: var(--dark); color: white; border-color: var(--dark); transform: scale(1.05); }

        /* VISTAS */
        .view-panel { padding: 15px; flex: 1; overflow-y: auto; -webkit-overflow-scrolling: touch; display: none; padding-bottom: 100px; }
        .view-panel.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* GRID */
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 12px; }
        .card { background: white; border-radius: 12px; overflow: hidden; border: 1px solid #eee; box-shadow: 0 2px 5px rgba(0,0,0,0.02); cursor: pointer; display: flex; flex-direction: column; height: 100%; position: relative;}
        .card:active { transform: scale(0.97); }
        .card-img-wrap { height: 130px; background: #f0f0f0; display: flex; justify-content: center; align-items: center; position: relative; overflow: hidden; }
        .card-img-wrap img { width: 100%; height: 100%; object-fit: cover; }
        .badge-cat { position: absolute; top: 5px; right: 5px; padding: 2px 6px; border-radius: 4px; color: white; font-size: 0.6rem; font-weight: bold; text-transform: uppercase; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        .card-content { padding: 10px; flex: 1; display: flex; flex-direction: column; justify-content: space-between; }
        .card h4 { margin: 0; font-size: 0.85rem; color: #333; font-weight: 700; line-height: 1.3; }
        .card p { margin: 2px 0 5px; font-size: 0.75rem; color: #777; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .card-footer { display: flex; justify-content: space-between; align-items: center; border-top: 1px dashed #eee; padding-top: 5px; margin-top: auto;}
        .price { color: var(--primary); font-weight: 800; font-size: 0.95rem; }
        .stock { font-size: 0.65rem; background: #E8F5E9; color: #2E7D32; padding: 2px 5px; border-radius: 4px; font-weight: 700; }

        /* TABLE */
        .table-wrap { background: white; border-radius: 10px; overflow-x: auto; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        table { width: 100%; border-collapse: collapse; font-size: 0.85rem; min-width: 600px; }
        thead { background: #263238; color: white; }
        th, td { padding: 10px; border-bottom: 1px solid #eee; text-align: left; }
        .thumb { width: 40px; height: 40px; border-radius: 6px; object-fit: cover; }

        /* UI ELEMENTS */
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 900; display: none; backdrop-filter: blur(2px); }
        .overlay.active { display: block; }
        .cart-drawer { position: fixed; top: 0; right: -450px; width: 450px; height: 100%; background: white; z-index: 1100; transition: 0.3s cubic-bezier(0.16, 1, 0.3, 1); display: flex; flex-direction: column; box-shadow: -5px 0 30px rgba(0,0,0,0.2); }
        .cart-drawer.open { transform: translateX(-450px); }
        .cart-items { flex: 1; overflow-y: auto; padding: 15px; }
        .cart-total-bar { padding: 15px; background: #fafafa; border-top: 1px solid #eee; }
        .client-inputs input { width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 0.9rem; }
        .c-item { display: flex; gap: 10px; padding: 10px; border: 1px solid #eee; border-radius: 8px; margin-bottom: 8px; align-items: center; background: white; }
        
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 2000; display: none; align-items: center; justify-content: center; padding: 20px; }
        .modal-box { background: white; width: 500px; max-width: 100%; padding: 20px; border-radius: 12px; position: relative; max-height: 90vh; overflow-y: auto; box-shadow: 0 10px 40px rgba(0,0,0,0.3); animation: slideUp 0.3s; }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { opacity: 1; transform: translateY(0); } }

        .settings-header { font-size:1.5rem; font-weight:800; margin-bottom:15px; display:flex; align-items:center; gap:10px; color: #333; }
        .config-card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 15px; }
        .section-title { font-weight: 700; color: var(--primary); border-bottom: 2px solid #eee; padding-bottom: 5px; margin-bottom: 15px; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 1px;}
        .form-row { margin-bottom: 15px; }
        .form-row label { display: block; font-weight: 600; font-size: 0.8rem; margin-bottom: 5px; color: #555; }
        .form-row input, .form-row select { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; }

        .btn { padding: 12px; border-radius: 8px; border:none; cursor: pointer; font-weight: bold; width: 100%; transition: 0.2s;}
        .btn:active { transform: scale(0.96); }
        .btn-primary { background: var(--dark); color: white; }
        .btn-success { background: #2E7D32; color: white; }
        .btn-danger { background: #C62828; color: white; }
        .btn-blue { background: #1976D2; color: white; }
        
        /* UPLOADERS */
        .file-upload { border: 2px dashed #ccc; padding: 30px; text-align: center; border-radius: 12px; cursor: pointer; margin-top: 10px; background: #fafafa; transition:0.2s; position:relative; }
        .file-upload:hover { border-color: var(--primary); background: #fffde7; }
        .file-upload img { max-height: 100px; display: none; margin: 0 auto; border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .file-upload.has-img img { display: block; }
        .file-upload.has-img span { display: none; }
        .upload-loading { position:absolute;top:0;left:0;width:100%;height:100%;background:rgba(255,255,255,0.8);display:flex;align-items:center;justify-content:center;font-weight:bold;color:var(--primary); display:none;}

        #loader { position: fixed; top:0; left:0; width:100%; height:100%; background:white; z-index:9999; display:flex; justify-content:center; align-items:center; flex-direction:column; }
        .spinner { width:45px; height:45px; border:4px solid #f0f0f0; border-top-color:var(--primary); border-radius:50%; animation:spin 1s linear infinite; }
        @keyframes spin { 100% { transform:rotate(360deg); } }
        
        #toast-container { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 5000; pointer-events: none; width: 90%; max-width: 350px; text-align: center; }
        .toast { background: #323232; color: white; padding: 14px 20px; border-radius: 8px; margin-top: 10px; animation: slideInTop 0.3s; font-weight: 600; box-shadow: 0 5px 20px rgba(0,0,0,0.2); display: inline-block; width: 100%; }
        @keyframes slideInTop { from{transform:translateY(-20px);opacity:0} to{transform:translateY(0);opacity:1} }

        /* MOBILE */
        @media (max-width: 768px) {
            body { flex-direction: column; }
            aside { position: fixed; bottom: 0; left: 0; width: 100%; height: var(--nav-height-mobile); flex-direction: row; justify-content: space-around; padding: 0; background: white; border-top: 1px solid #eee; z-index: 1000; box-shadow: 0 -5px 20px rgba(0,0,0,0.05); }
            .brand, .sys-info { display: none; }
            .nav-menu { display: flex; flex-direction: row; width: 100%; padding: 0; justify-content: space-between; overflow:hidden;}
            .nav-item { flex-direction: column; justify-content: center; padding: 5px; flex: 1; border-radius: 0; margin: 0; border-top: 3px solid transparent; gap: 3px; color: #888; background: transparent; }
            .nav-item.active { border-top-color: var(--primary); background: #fafafa; color: var(--primary); }
            main { height: calc(100vh - var(--nav-height-mobile)); position: absolute; top: 0; width: 100%; }
            .view-panel { padding-bottom: 90px !important; }
            header { padding: 10px 15px; height: auto; flex-wrap: wrap; gap: 10px; background: white; justify-content: space-between; align-items: center; }
            .mobile-brand { display: flex; }
            .search-wrap { width: 100%; max-width: none; order: 3; }
            .filter-group { width: 100%; order: 4; }
            .grid { grid-template-columns: 1fr 1fr; gap: 10px; }
            .cart-drawer { width: 100%; right: -100%; z-index: 2000; }
            .cart-drawer.open { transform: translateX(-100%); }
        }

        #print-layer { display: none; }
        @media print { body > *:not(#print-layer) { display: none !important; } #print-layer { display: block !important; position: absolute; top: 0; left: 0; width: 100%; z-index: 99999; background: white; min-height: 100vh;} @page { margin: 5mm; } }
    </style>
</head>

<body>

    <div id="loader">
        <div class="spinner"></div>
        <p style="margin-top:15px; color:#555; font-weight:bold;">Iniciando Sistema...</p>
    </div>
    <div id="toast-container"></div>
    <div class="overlay" id="mainOverlay" onclick="toggleCart()"></div>

    <!-- SIDEBAR -->
    <aside>
        <div class="brand">
            <img id="displayLogoSidebar" src="" alt="Logo">
            <h1 id="brandName">WORLD STORE</h1>
            <small id="brandSubSidebar">Gesti칩n en la Nube</small>
        </div>
        <div class="nav-menu">
            <div class="nav-item active" onclick="nav('pos', this)"><i class="fa-solid fa-store"></i> <span>Cat치logo</span></div>
            <div class="nav-item" onclick="nav('history', this)"><i class="fa-solid fa-receipt"></i> <span>Ventas</span></div>
            <div class="nav-item" onclick="nav('inv', this)"><i class="fa-solid fa-boxes-stacked"></i> <span>Inventario</span></div>
            <div class="nav-item" onclick="toggleCart()"><i class="fa-solid fa-cart-shopping"></i> <span>Carrito <b id="cartCountBadge" style="background:var(--primary); color:white; padding:1px 6px; border-radius:10px; font-size:0.7em;">0</b></span></div>
            <div class="nav-item" onclick="nav('accounts', this)"><i class="fa-solid fa-chart-line"></i> <span>Cuentas</span></div>
            <div class="nav-item" onclick="nav('config', this)"><i class="fa-solid fa-sliders"></i> <span>Configuraci칩n</span></div>
        </div>
        <div class="sys-info"><span id="footerBrand">SISTEMA V9.3</span></div>
    </aside>

    <main>
        <div id="globalBanner"></div>
        <header>
            <div class="mobile-brand">
                <img id="mobileLogoImg" src="" style="display:none;">
                <h2 id="mobileTitleTxt">WORLD STORE</h2>
            </div>
            <div class="search-wrap">
                <i class="fa-solid fa-magnifying-glass"></i>
                <input type="text" id="searchInput" placeholder="Buscar modelo..." onkeyup="renderPOS()">
            </div>
            <div class="filter-group">
                <div class="chip active" onclick="filterCat('all', this)">Todo</div>
                <div class="chip" onclick="filterCat('Ni침o/Ni침a', this)">Ni침os</div>
                <div class="chip" onclick="filterCat('Dama', this)">Dama</div>
                <div class="chip" onclick="filterCat('Caballero', this)">Caballero</div>
            </div>
        </header>

        <!-- 1. CAT츼LOGO -->
        <div id="view-pos" class="view-panel active">
            <div class="grid" id="posGrid"></div>
        </div>

        <!-- 2. VENTAS -->
        <div id="view-history" class="view-panel">
            <div style="background:white; padding:20px; border-radius:12px; margin-bottom:20px; box-shadow:0 2px 10px rgba(0,0,0,0.05); display:flex; justify-content:space-between;">
                <div><h3 style="margin:0">Ventas Realizadas</h3></div>
                <div style="text-align:right;"><small>Total Ventas</small><div style="font-size:1.5rem;font-weight:800;color:var(--primary)" id="grandTotalHistory">$0.00</div></div>
            </div>
            <div class="table-wrap">
                <table>
                    <thead><tr><th>Fecha</th><th>Cliente</th><th>Detalle</th><th>Total</th><th></th></tr></thead>
                    <tbody id="histBody"></tbody>
                </table>
            </div>
            <br><button class="btn btn-danger" onclick="clearHistory()"><i class="fa-solid fa-trash-can"></i> Limpiar Todo</button>
        </div>

        <!-- 3. INVENTARIO -->
        <div id="view-inv" class="view-panel">
            <div style="display:flex; justify-content:space-between; margin-bottom:20px; align-items:center;">
                <h3>Inventario de Productos</h3>
                <button class="btn btn-success" style="width:auto;" onclick="openModalProd()">+ Nuevo Producto</button>
            </div>
            <div class="table-wrap">
                <table>
                    <thead><tr><th>Img</th><th>Modelo / C칩digo</th><th>P. Docena</th><th>Stock (Pares)</th><th></th></tr></thead>
                    <tbody id="invBody"></tbody>
                </table>
            </div>
        </div>

        <!-- 4. FINANZAS / CUENTAS (CORREGIDO) -->
        <div id="view-accounts" class="view-panel">
            <div class="settings-header"><i class="fa-solid fa-sack-dollar"></i> Finanzas del Inventario</div>
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap:15px; margin-bottom:20px;">
                <div style="background:white; padding:20px; border-radius:12px; border-left:5px solid #d32f2f; box-shadow:0 2px 5px rgba(0,0,0,0.05);">
                    <div style="font-size:0.8rem; font-weight:600; color:#777;">COSTO TOTAL INVENTARIO</div>
                    <div style="font-size:1.5rem; font-weight:800; color:#333; margin-top:5px;" id="kpi-cost">$0.00</div>
                    <small>Capital Invertido (Fletes + Costos)</small>
                </div>
                <div style="background:white; padding:20px; border-radius:12px; border-left:5px solid #388E3C; box-shadow:0 2px 5px rgba(0,0,0,0.05);">
                    <div style="font-size:0.8rem; font-weight:600; color:#777;">GANANCIA PROYECTADA</div>
                    <div style="font-size:1.5rem; font-weight:800; color:#388E3C; margin-top:5px;" id="kpi-profit">$0.00</div>
                    <small>Si se vende todo el stock</small>
                </div>
            </div>
            <div class="config-card">
                <div style="border-bottom:1px solid #eee; padding-bottom:10px; margin-bottom:10px; font-weight:bold;">Rentabilidad por Modelo</div>
                <div class="table-wrap">
                    <table id="accountsTable">
                        <thead style="background:#455A64; color:white;"><tr><th>Producto</th><th>Costo Doc.</th><th>Venta Doc.</th><th>Ganancia Doc.</th><th>Stock (Paq/Pares)</th><th>Valor Total Stock</th></tr></thead>
                        <tbody id="accountsBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- 5. CONFIG -->
        <div id="view-config" class="view-panel">
            <h3>Configuraci칩n</h3>
            <div class="config-card">
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px;">
                    <div class="form-row"><label>Empresa</label><input type="text" id="cfgName"></div>
                    <div class="form-row"><label>Subt칤tulo</label><input type="text" id="cfgSub"></div>
                </div>
                <div class="form-row"><label>Logo (Ticket/App)</label>
                    <div style="border:1px solid #ddd; padding:10px; border-radius:8px; display:flex; align-items:center; gap:10px; background:#f9f9f9;">
                        <img id="cfgLogoPreview" src="" style="width:50px; height:50px; object-fit:contain; background:white;">
                        <div style="flex:1;">
                            <input type="file" accept="image/*" onchange="compressAndPreview(this.files[0], 'cfgLogoPreview', 'cfgLogoData')">
                            <input type="hidden" id="cfgLogoData">
                        </div>
                    </div>
                </div>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px;">
                    <div class="form-row"><label>Tel칠fono</label><input type="tel" id="cfgTel"></div>
                    <div class="form-row"><label>Moneda</label><input type="text" id="cfgCurrency"></div>
                </div>
                <div class="form-row"><label>Color Tema</label><input type="color" id="cfgColor" style="height:40px;width:100%;" onchange="previewColor(this.value)"></div>
                
                <h4 style="margin-top:20px;">Utilidades Nube</h4>
                <div class="form-row"><label>Anuncio Global</label><input type="text" id="cfgBanner" placeholder="Texto marquesina..."></div>
                <div style="background:#fff3e0; padding:10px; border-radius:6px; margin-bottom:15px;"><label style="display:flex;align-items:center;gap:10px;font-weight:bold;"><input type="checkbox" id="cfgMaintenance" style="width:20px;"> ACTIVAR MODO MANTENIMIENTO</label></div>
                
                <button class="btn btn-primary" onclick="window.saveConfig()">GUARDAR AJUSTES</button>
                <br><br>
                <div style="border-top:1px dashed #ccc; padding-top:20px; text-align:center;">
                    <p style="font-size:0.8rem; color:#666;">쯀nventario Vac칤o o Corrupto?</p>
                    <button class="btn btn-blue" onclick="window.reloadInitialData()" style="opacity:0.9;"><i class="fa-solid fa-cloud-arrow-down"></i> Restaurar Cat치logo Base (PDF)</button>
                </div>
            </div>
        </div>
    </main>

    <!-- DRAWERS/MODALS -->
    <div id="cartDrawer" class="cart-drawer">
        <div style="padding:15px; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center;">
            <h3 style="margin:0">游 Pedido</h3>
            <button onclick="toggleCart()" style="background:none; border:none; font-size:1.5rem;">&times;</button>
        </div>
        <div class="cart-items" id="cartContainer"></div>
        <div class="cart-total-bar">
            <div class="client-inputs"><input type="text" id="cartClientName" placeholder="Nombre Cliente *"><input type="tel" id="cartClientPhone" placeholder="Tel칠fono" inputmode="tel"></div>
            <div style="display:flex; justify-content:space-between; margin-bottom:15px; font-size:1.2rem; font-weight:bold;"><span>Total</span><span id="cartTotalDisplay">$0.00</span></div>
            <button class="btn btn-success w-100" onclick="window.processSale()">CONFIRMAR VENTA</button>
        </div>
    </div>

    <div id="modalSale" class="modal">
        <div class="modal-box">
            <h3 id="saleTitle" style="margin-top:0;">Producto</h3>
            <input type="hidden" id="saleId">
            <div style="background:#f9f9f9; padding:10px; text-align:center; border-radius:8px; margin:10px 0;">
                <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:5px;">
                    <button class="btn" style="font-size:0.7rem; padding:8px 2px;" id="btn-doc" onclick="setSaleType('doc')">DOCENA</button>
                    <button class="btn" style="font-size:0.7rem; padding:8px 2px;" id="btn-half" onclick="setSaleType('half')">MEDIA</button>
                    <button class="btn" style="font-size:0.7rem; padding:8px 2px;" id="btn-unit" onclick="setSaleType('unit')">PAR</button>
                </div>
                <div id="unitPriceDisplay" style="margin-top:8px; font-weight:600; color:#555;"></div>
            </div>
            <div style="display:flex; gap:10px; margin-bottom:20px; align-items:center;">
                <button class="btn" style="background:#eee; font-size:1.5rem;" onclick="adjQty(-1)">-</button>
                <input type="number" id="saleQty" value="1" min="1" style="flex:1; text-align:center; padding:10px; font-size:1.3rem; border:1px solid #ddd; font-weight:bold;" onchange="updateCalc()">
                <button class="btn" style="background:#eee; font-size:1.5rem;" onclick="adjQty(1)">+</button>
            </div>
            <div style="text-align:right; font-size:1.8rem; font-weight:800; color:var(--primary); margin-bottom:20px;"><span id="saleTotalCalc">$0.00</span></div>
            <div style="display:flex; gap:10px;"><button class="btn" style="background:#eee; flex:1;" onclick="closeModal('modalSale')">Volver</button><button class="btn btn-success" style="flex:2;" onclick="confirmAdd()">AGREGAR</button></div>
        </div>
    </div>

    <div id="modalProd" class="modal">
        <div class="modal-box">
            <h3 style="margin-top:0;">Producto</h3>
            <input type="hidden" id="prodId"><input type="hidden" id="prodImgBase64">
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                <div style="grid-column:span 2"><label>Modelo</label><input type="text" id="pModel"></div>
                <div><label>C칩digo</label><input type="text" id="pCode"></div>
                <div><label>Categor칤a</label><select id="pCat"><option>Dama</option><option>Caballero</option><option>Ni침o/Ni침a</option></select></div>
                <div><label>Precio Venta (Doc)</label><input type="number" id="pPrice"></div>
                <div><label>Costo Flete (Doc)</label><input type="number" id="pCost" style="border-color:orange; background:#fff8e1"></div>
                <div><label>Precio Par</label><input type="number" id="pPriceUnit" placeholder="Auto"></div>
                <div><label>Stock Pares</label><input type="number" id="pStock"></div>
                <div style="grid-column:span 2"><label>Tallas</label><input type="text" id="pSize"></div>
            </div>
            <div class="file-upload" onclick="document.getElementById('fileInput').click()" style="margin-top:10px;">
                <span>Subir Foto</span><img id="imgPreview"><input type="file" id="fileInput" accept="image/*" style="display:none" onchange="compressAndPreview(this.files[0], 'imgPreview', 'prodImgBase64')">
            </div>
            <div style="margin-top:20px; display:flex; gap:10px;"><button class="btn btn-danger" onclick="closeModal('modalProd')">Cancelar</button><button class="btn btn-success" onclick="window.saveProduct()">GUARDAR</button></div>
        </div>
    </div>

    <div id="print-layer">
        <div style="width:100%;max-width:800px;margin:0 auto;color:black;font-family:sans-serif;font-size:14px;">
            <div style="border-bottom:2px solid #000;padding-bottom:10px;margin-bottom:15px;display:flex;justify-content:space-between;">
                <div>
                    <img id="printLogoDisplay" style="height:60px;display:none;margin-bottom:5px;">
                    <h1 id="printBrand" style="margin:0;font-size:22px;"></h1><div id="printSub"></div><div id="printTel"></div>
                </div>
                <div style="text-align:right;"><h2>NOTA DE ENTREGA</h2>Fecha: <span id="printDate"></span></div>
            </div>
            <div id="printClientBlock" style="border:1px solid #999;padding:8px;margin-bottom:15px;"></div>
            <table style="width:100%;border-collapse:collapse;margin-bottom:20px;"><thead><tr style="background:#eee;"><th style="padding:5px;">Cant</th><th>Descripci칩n</th><th style="padding:5px;text-align:right;">Total</th></tr></thead><tbody id="printBody"></tbody></table>
            <div style="text-align:right;font-size:18px;font-weight:bold;border-top:2px solid #000;padding-top:10px;">TOTAL: <span id="printTotal"></span></div>
            <div id="printFooter" style="text-align:center;margin-top:30px;color:#555;"></div>
        </div>
    </div>

    <!-- SCRIPT LOGIC -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

    <script>
        // ----------------------------------------
        // 游댠 CREDENCIALES DE FIREBASE 游댠
        // ----------------------------------------
        const firebaseConfig = {
            apiKey: "AIzaSyB5ygJIoEgpJPKY0qMULocohmzXGc7UWFE",
            authDomain: "worldstoresystem.firebaseapp.com",
            databaseURL: "https://worldstoresystem-default-rtdb.firebaseio.com",
            projectId: "worldstoresystem",
            storageBucket: "worldstoresystem.firebasestorage.app",
            messagingSenderId: "460628958914",
            appId: "1:460628958914:web:95da76852bedecbdcf255b"
        };
        firebase.initializeApp(firebaseConfig);
        const dbRef = firebase.database();

        // VARS
        let db=[], history=[], config={name:"WORLD STORE", currency:"$", color:"#C62828"}, cart=[];
        let curFilter='all', saleItem=null, saleMode='doc';

        // SYNC
        dbRef.ref('inventory').on('value', s => { 
            db = s.val() || [];
            document.getElementById('loader').style.display='none';
            renderPOS(); renderInv(); renderAccounts(); 
        });
        dbRef.ref('history').on('value', s => { 
            history = s.val() ? Object.values(s.val()).sort((a,b)=>b.id-a.id) : []; 
            renderHistory(); 
            if(document.getElementById('view-accounts').classList.contains('active')) renderAccounts();
        });
        dbRef.ref('config').on('value', s => { if(s.val()){ config=s.val(); applyConfig(); renderPOS(); }});

        // ----------------------------------------
        // 游 RESTAURAR DB (DATA DE TU IMAGEN/PDF)
        // ----------------------------------------
        function saveInitialData(){
            const INIT = [
                // DATAZO DE COSTO/VENTA INYECTADO AQU칈 DIRECTO PARA RECUPERACION 1 CLICK
                {c:"HY 001",m:"Chancla Nube",d:41,cost:35.5,cat:"Dama"},{c:"HY 002-1",m:"Vaca Lola",d:36,cost:30.5,cat:"Dama"},{c:"HY 002-3",m:"Gato",d:40,cost:34.5,cat:"Dama"},
                {c:"HY 003-1",m:"Vaca Kid",d:32,cost:26.5,cat:"Ni침o/Ni침a"},{c:"HY 006-1",m:"Cadena Plata",d:42,cost:36.5,cat:"Dama"},{c:"LC C-04",m:"Labubu",d:33,cost:26.5,cat:"Ni침o/Ni침a"},
                {c:"HY 007",m:"Cuadros",d:30,cost:24.5,cat:"Caballero"},{c:"HY 009-1",m:"Bebidas",d:33,cost:27.5,cat:"Ni침o/Ni침a"},{c:"HY 009-2",m:"Poker",d:33,cost:27.5,cat:"Ni침o/Ni침a"},
                {c:"HY 010",m:"Futurista",d:36,cost:30.5,cat:"Caballero"},{c:"HY 011-1",m:"Flor Plat.",d:47,cost:41.5,cat:"Dama"},{c:"HY 011-2",m:"Marmoleada",d:41,cost:35.5,cat:"Dama"},
                {c:"LC 05",m:"Nike Kid",d:32,cost:26.5,cat:"Ni침o/Ni침a"},{c:"HY 013",m:"Tiras",d:27,cost:21.5,cat:"Ni침o/Ni침a"},{c:"LC 07-1",m:"Jirafa",d:30,cost:24.5,cat:"Ni침o/Ni침a"},
                {c:"HY 015",m:"Sport",d:29,cost:23.5,cat:"Ni침o/Ni침a"},{c:"HY 016",m:"Yeezy Liso",d:36,cost:30.5,cat:"Caballero"},{c:"HY 016-1",m:"Yeezy Camu",d:46,cost:40.5,cat:"Caballero"},
                {c:"HY 017-1",m:"Flores Bebe",d:27,cost:21.5,cat:"Ni침o/Ni침a"},{c:"HY 017-2",m:"Espacio",d:27,cost:21.5,cat:"Ni침o/Ni침a"},{c:"HY 018-1",m:"Auto",d:30,cost:24.5,cat:"Ni침o/Ni침a"},
                {c:"HY 019",m:"Vaca Tela",d:39,cost:33.5,cat:"Ni침o/Ni침a"},{c:"HY 020-1",m:"Sport Velcro",d:31,cost:24.5,cat:"Ni침o/Ni침a"},{c:"LC LB 03",m:"Acolchada",d:35,cost:27.5,cat:"Dama"},
                {c:"HY 020-3",m:"Pastel",d:50,cost:44.5,cat:"Ni침o/Ni침a"},{c:"LC PW33",m:"Flip Flop",d:30,cost:23.5,cat:"Dama"},{c:"HY 020-5",m:"Sport G",d:52,cost:46.5,cat:"Ni침o/Ni침a"},
                {c:"HY 021-1",m:"Fashion",d:56,cost:50.5,cat:"Dama"},{c:"HY 022",m:"Prada",d:42,cost:36.5,cat:"Dama"},{c:"LC W15",m:"Sport",d:45,cost:39.5,cat:"Dama"},
                {c:"HY 026-1",m:"Osos",d:40,cost:34.5,cat:"Ni침o/Ni침a"},{c:"HY 027",m:"Pata Gallo",d:30,cost:22.5,cat:"Caballero"},{c:"LC W72-3",m:"Croc Pastel",d:32,cost:25.5,cat:"Dama"},
                {c:"HY 028-4",m:"Flores Dedo",d:30,cost:24.5,cat:"Dama"},{c:"HY 029-1",m:"Trekking",d:55,cost:44.5,cat:"Dama"},{c:"HY 030-3",m:"Princesa",d:55,cost:49.5,cat:"Ni침o/Ni침a"},
                {c:"HY 031-4",m:"Senderismo",d:56,cost:45.5,cat:"Caballero"},{c:"HY 032",m:"Arrugada",d:43,cost:37.5,cat:"Dama"},{c:"HY 032-1",m:"Lazo",d:47,cost:41.5,cat:"Dama"},
                {c:"HY 033",m:"Ranuras",d:35,cost:29.5,cat:"Caballero"},{c:"HY 035",m:"Basic",d:32,cost:26.5,cat:"Caballero"},{c:"HY 037-1",m:"Franja",d:38,cost:32.5,cat:"Caballero"},
                {c:"HY 038-1",m:"Dino Ni침a",d:27,cost:20.5,cat:"Ni침o/Ni침a"},{c:"HY 038-2",m:"Dino Ni침o",d:27,cost:20.5,cat:"Ni침o/Ni침a"},{c:"HY 039-1",m:"Coco",d:29,cost:22.5,cat:"Ni침o/Ni침a"},
                {c:"HY 040-1",m:"Kuromi",d:31,cost:25.5,cat:"Dama"},{c:"HY 040-3",m:"Dijes",d:33,cost:27.5,cat:"Dama"},{c:"HY 040-4",m:"Joyas",d:34,cost:28.5,cat:"Dama"},
                {c:"HY 042",m:"Sport Dedo",d:29,cost:23.5,cat:"Caballero"},{c:"HY 045",m:"Liso M",d:31,cost:25.5,cat:"Caballero"},{c:"HY 047-1",m:"Banda",d:40.5,cost:36.5,cat:"Dama"},
                {c:"HY 047-3",m:"Peluche",d:47,cost:41.5,cat:"Dama"},{c:"HY 049",m:"Velcro Lat",d:50,cost:44.5,cat:"Caballero"},{c:"HY 049-1",m:"Letras",d:48,cost:36.5,cat:"Caballero"},
                {c:"HY 055-4",m:"Bota Mo침o",d:36,cost:29.5,cat:"Ni침o/Ni침a"},{c:"HY 055-5",m:"Bota Dino",d:36,cost:29.5,cat:"Ni침o/Ni침a"},{c:"HY 055-7",m:"Bota Gato",d:39,cost:32.5,cat:"Ni침o/Ni침a"},
                {c:"HY 056",m:"Concha",d:35,cost:29.5,cat:"Dama"},{c:"HY 058-1",m:"Mo침o G",d:45,cost:39.5,cat:"Dama"},{c:"HY 060",m:"Bicolor",d:44,cost:37.5,cat:"Dama"},
                {c:"HY 060-1",m:"Splash",d:45,cost:39.5,cat:"Caballero"},{c:"HY 076",m:"Sport C",d:34,cost:28.5,cat:"Caballero"},{c:"HY 077",m:"Flor",d:33,cost:27.5,cat:"Dama"},
                {c:"LA 08",m:"Adidas",d:38,cost:32.5,cat:"Caballero"},{c:"LC A-2402",m:"Surf",d:36,cost:30.5,cat:"Caballero"},{c:"LC M-15D",m:"Camu",d:52,cost:46.5,cat:"Caballero"},
                {c:"RS 101",m:"Basket",d:34,cost:25.5,cat:"Caballero"},{c:"RS 107",m:"Nike Liso",d:44,cost:35.7,cat:"Dama"},{c:"RS 110",m:"Chunky",d:50,cost:33.9,cat:"Dama"},
                {c:"RS 111",m:"Cadenas",d:43,cost:31.5,cat:"Dama"},{c:"W 15",m:"Clasico Baby",d:46,cost:39.5,cat:"Dama"}
            ];
            
            const dbReady = INIT.map((p,i)=>({...p, id:Date.now()+i, stock:72, img:"", t:(p.cat==='Dama'?'36-40':(p.cat==='Caballero'?'40-45':'30-35'))}));
            dbRef.ref('inventory').set(dbReady).then(()=>Toast.show("Cat치logo y Costos Restaurados OK","success"));
        }
        window.reloadInitialData=function(){if(confirm("쮺argar los 150 productos con sus costos reales?")){ saveInitialData(); }}

        // --- SISTEMA FINANCIERO (CUENTAS) ---
        function renderAccounts() {
            const tBody = document.getElementById('accountsBody'); if(!tBody) return;
            let totalCost=0, totalSale=0, totalProfit=0; const cur=config.currency;
            tBody.innerHTML = db.map(p => {
                let cost = p.cost || 0;
                let price = p.d || 0;
                let profit = price - cost;
                let stockDozen = (p.stock || 0) / 12; // Stock en Dozenas
                
                totalCost += (stockDozen * cost);
                totalSale += (stockDozen * price);
                totalProfit += (stockDozen * profit);

                return `<tr style="border-bottom:1px solid #eee;">
                    <td><b>${p.c}</b></td>
                    <td style="color:#d32f2f">${cur}${cost.toFixed(2)}</td>
                    <td style="color:#1976D2">${cur}${price.toFixed(2)}</td>
                    <td style="color:#388E3C;font-weight:bold">${cur}${profit.toFixed(2)}</td>
                    <td style="text-align:center">${p.stock}</td>
                    <td>${cur}${(stockDozen * cost).toFixed(2)}</td>
                </tr>`;
            }).join('');
            
            document.getElementById('kpi-cost').innerText = cur + totalCost.toLocaleString('en-US', {minimumFractionDigits: 2});
            document.getElementById('kpi-sale').innerText = cur + totalSale.toLocaleString('en-US', {minimumFractionDigits: 2});
            document.getElementById('kpi-profit').innerText = cur + totalProfit.toLocaleString('en-US', {minimumFractionDigits: 2});
        }

        // --- OTRAS FUNCIONES ---
        window.compressAndPreview=function(file, imgId, inpId){
            if(file){ const r=new FileReader(); r.readAsDataURL(file); r.onload=e=>{
                const i=new Image(); i.src=e.target.result; i.onload=()=>{
                    const c=document.createElement('canvas'); let w=i.width, h=i.height; if(w>600){h*=600/w;w=600} c.width=w; c.height=h; 
                    c.getContext('2d').drawImage(i,0,0,w,h);
                    const d=c.toDataURL('image/jpeg',0.7);
                    document.getElementById(imgId).src=d; document.getElementById(imgId).style.display='block'; document.getElementById(inpId).value=d;
                }
            }}
        };
        
        window.processSale=function(){
            if(cart.length==0) return alert("Vacio");
            const nm=document.getElementById('cartClientName').value.trim(); if(!nm)return alert("Cliente?");
            let t=0,d="", snap=JSON.parse(JSON.stringify(cart));
            cart.forEach(i=>{t+=i.total;d+=`${i.qtyTxt} ${i.c}, `; const p=db.find(x=>x.id==i.pId); if(p)p.stock-=i.deduct;});
            dbRef.ref('inventory').set(db);
            const r={id:Date.now(), date:new Date().toLocaleDateString(), client:nm, phone:document.getElementById('cartClientPhone').value, total:t, items:snap, desc:d};
            dbRef.ref('history').push(r);
            printData(r); cart=[]; document.getElementById('cartClientName').value=""; renderCart(); toggleCart();
        }

        window.openSale=(id)=>{saleItem=db.find(x=>x.id==id); document.getElementById('saleTitle').innerText=saleItem.c; document.getElementById('saleId').value=id; document.getElementById('saleQty').value=1; window.setSaleType('doc'); document.getElementById('modalSale').style.display='flex';}
        window.setSaleType=(t)=>{saleMode=t; ['doc','half','unit'].forEach(x=>{document.getElementById('btn-'+x).style.background=x==t?config.color:'#eee';document.getElementById('btn-'+x).style.color=x==t?'white':'#333'}); window.updateCalc();}
        window.updateCalc=()=>{ const q=parseInt(document.getElementById('saleQty').value)||1; const c=config.currency; let p=0; if(saleMode=='doc')p=saleItem.d; else if(saleMode=='half')p=saleItem.d/2; else p=saleItem.p_unit>0?saleItem.p_unit:(saleItem.d/12)*1.6; document.getElementById('saleTotalCalc').innerText=`${c}${(p*q).toFixed(2)}`; }
        window.adjQty=(n)=>{let v=parseInt(document.getElementById('saleQty').value)+n; if(v<1)v=1; document.getElementById('saleQty').value=v; window.updateCalc();}
        window.confirmAdd=()=>{
            const q=parseInt(document.getElementById('saleQty').value); const t=parseFloat(document.getElementById('saleTotalCalc').innerText.replace(/[^0-9.]/g,''));
            let l=saleMode=='doc'?'Doc':(saleMode=='half'?'Med':'Par'); let d=saleMode=='doc'?12*q:(saleMode=='half'?6*q:q);
            cart.push({pId:saleItem.id,c:saleItem.c,m:saleItem.m,qtyTxt:`${q} ${l}`,total:t,deduct:d}); closeModal('modalSale'); renderCart(); toggleCart(); Toast.show("Agregado");
        }

        function applyConfig(){
            document.documentElement.style.setProperty('--primary',config.color);
            document.getElementById('brandName').innerText=config.name; document.getElementById('brandSub').innerText=config.sub; document.getElementById('mobileTitleTxt').innerText=config.name.toUpperCase();
            document.getElementById('cfgName').value=config.name; document.getElementById('cfgSub').value=config.sub;
            document.getElementById('cfgTel').value=config.tel; document.getElementById('cfgCurrency').value=config.currency;
            document.getElementById('cfgFooter').value=config.footer; document.getElementById('cfgColor').value=config.color;
            if(config.logo){['displayLogoSidebar','mobileLogoImg','printLogoDisplay','cfgLogoPreview'].forEach(i=>{let e=document.getElementById(i);if(e){e.src=config.logo;if(i!=='cfgLogoPreview')e.style.display='block'}})}
            const b=document.getElementById('globalBanner');if(config.banner){b.style.display='block';b.innerText=config.banner}else{b.style.display='none'}
        }
        window.saveConfig=()=>{
            config.name=document.getElementById('cfgName').value; config.sub=document.getElementById('cfgSub').value; config.tel=document.getElementById('cfgTel').value; config.currency=document.getElementById('cfgCurrency').value; config.footer=document.getElementById('cfgFooter').value; config.color=document.getElementById('cfgColor').value; config.banner=document.getElementById('cfgBanner').value; config.maintenance=document.getElementById('cfgMaintenance').checked;
            if(document.getElementById('cfgLogoData').value) config.logo=document.getElementById('cfgLogoData').value;
            dbRef.ref('config').set(config).then(()=>Toast.show("Ok"));
        }

        window.toggleCart=()=>{ document.getElementById('cartDrawer').classList.toggle('open'); document.getElementById('mainOverlay').classList.toggle('active'); renderCart(); }
        window.nav=(v,el)=>{ document.querySelectorAll('.view-panel').forEach(p=>p.classList.remove('active')); document.querySelectorAll('.nav-item').forEach(i=>i.classList.remove('active')); document.getElementById('view-'+v).classList.add('active'); el.classList.add('active'); if(v==='pos')renderPOS(); if(v==='accounts')renderAccounts(); }
        window.previewColor=(v)=>document.documentElement.style.setProperty('--primary',v);
        window.closeModal=(i)=>document.getElementById(i).style.display='none';
        
        // GENERIC RENDERS
        function renderPOS(){
            if(config.maintenance && location.hash!='#admin') {document.getElementById('posGrid').innerHTML="<h3>Cerrado</h3>";return}
            const g=document.getElementById('posGrid'); const t=document.getElementById('searchInput').value.toLowerCase(); g.innerHTML="";
            db.filter(p=>(p.c.toLowerCase().includes(t)||p.m.toLowerCase().includes(t))&&(curFilter=='all'||p.cat==curFilter)).forEach(p=>{
                g.innerHTML+=`<div class="card" onclick="openSale(${p.id})"><div class="card-img-wrap"><img src="${p.img||`https://placehold.co/300x300/eee/333?text=${p.c}`}"><span class="badge-cat" style="background:${p.cat=='Dama'?'#EC407A':(p.cat=='Caballero'?'#546E7A':'#2196F3')}">${p.cat.substring(0,3)}</span></div><div class="card-content"><h4>${p.c}</h4><p>${p.m}</p><div class="card-footer"><span class="stock">${p.stock}</span><span class="price">${config.currency}${p.d}</span></div></div></div>`;
            });
        }
        function renderCart(){const c=document.getElementById('cartContainer');c.innerHTML="";let t=0;cart.forEach((i,x)=>{t+=i.total;c.innerHTML+=`<div class="c-item"><div><b>${i.c}</b> ${i.qtyTxt}</div><div>${config.currency}${i.total}<i class="fa-solid fa-trash" style="margin-left:10px;color:red" onclick="cart.splice(${x},1);renderCart()"></i></div></div>`});document.getElementById('cartTotalDisplay').innerText=config.currency+t.toFixed(2);document.getElementById('cartCountBadge').innerText=cart.length;}
        function printData(r){
            document.getElementById('printDate').innerText=r.date; document.getElementById('printTotal').innerText=config.currency+r.total.toFixed(2);
            document.getElementById('printClientBlock').innerHTML=`Client: ${r.client} | Tlf: ${r.phone||'-'}`;
            const tb=document.getElementById('printBody'); tb.innerHTML="";
            r.items.forEach(i=>tb.innerHTML+=`<tr><td>${i.qtyTxt}</td><td>${i.c}</td><td align="right">${i.total}</td></tr>`);
            setTimeout(()=>window.print(),500);
        }

        // SAVE PROD
        window.saveProduct=()=>{
            const id=document.getElementById('prodId').value;
            const obj={c:document.getElementById('pCode').value, m:document.getElementById('pModel').value, d:parseFloat(document.getElementById('pPrice').value), cost:parseFloat(document.getElementById('pCost').value), stock:parseInt(document.getElementById('pStock').value), cat:document.getElementById('pCat').value, t:document.getElementById('pSize').value, img:document.getElementById('prodImgBase64').value};
            let nd=[...db]; if(id){const i=nd.findIndex(x=>x.id==id);nd[i]={...nd[i],...obj}}else{nd.unshift({...obj,id:Date.now()})}
            dbRef.ref('inventory').set(nd).then(()=>{closeModal('modalProd');Toast.show("Ok")});
        }
        window.openModalProd=()=>{['pCode','pModel','pPrice','pCost','pStock','prodImgBase64'].forEach(k=>document.getElementById(k).value="");document.getElementById('imgPreview').src="";document.getElementById('modalProd').style.display='flex'}
        window.handleImageUpload=i=>compressAndPreview(i.files[0],'imgPreview','prodImgBase64');
        window.clearHistory=()=>confirm("?")&&dbRef.ref('history').set(null);
    </script>
</body>
</html>
