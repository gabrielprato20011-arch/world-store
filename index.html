<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>World Store V9.1 - Logo Update</title>
    
    <!-- Fuentes e Iconos -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;600;700;800&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary: #C62828;
            --dark: #121212;
            --bg: #f0f2f5;
            --sidebar-width: 270px;
            --accent: #FFD54F;
        }

        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; font-family: 'Montserrat', sans-serif; background: var(--bg); color: #333; height: 100vh; overflow: hidden; display: flex; overscroll-behavior: none; }

        /* BANNER GLOBAL */
        #globalBanner {
            display: none; background: #FFD54F; color: #333; text-align: center; 
            padding: 8px; font-weight: 800; font-size: 0.8rem; width: 100%; z-index: 1000;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        /* --- BARRA LATERAL (PC) --- */
        aside { width: var(--sidebar-width); background: var(--dark); color: white; display: flex; flex-direction: column; height: 100%; z-index: 50; box-shadow: 4px 0 15px rgba(0,0,0,0.15); transition: 0.3s; }
        
        .brand { padding: 30px 20px; text-align: center; background: rgba(255,255,255,0.03); border-bottom: 1px solid rgba(255,255,255,0.1); }
        /* Logo PC */
        #displayLogoSidebar { 
            width: 100px; height: 100px; object-fit: contain; border-radius: 50%; 
            margin: 0 auto 15px auto; border: 4px solid rgba(255,255,255,0.2); 
            background: white; display:none; box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }
        .brand h1 { margin: 0; font-size: 1.4rem; font-weight: 900; letter-spacing: 1px; text-transform: uppercase; }
        .brand small { color: #888; font-size: 0.75rem; margin-top: 5px; display: block; font-weight: 400; }
        
        .nav-menu { flex: 1; padding: 20px 10px; overflow-y: auto; }
        .nav-item { 
            padding: 14px 20px; cursor: pointer; display: flex; align-items: center; gap: 15px; 
            color: #bbb; transition: 0.2s; font-size: 0.95rem; border-radius: 8px; margin-bottom: 5px;
        }
        .nav-item:hover { background: rgba(255,255,255,0.08); color: white; transform: translateX(5px); }
        .nav-item.active { background: var(--primary); color: white; font-weight: 600; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
        .nav-item i { width: 25px; text-align: center; font-size: 1.1rem; }
        
        .sys-info { padding: 15px; font-size: 0.7rem; text-align: center; color: #555; background: rgba(0,0,0,0.2); }

        /* --- AREA PRINCIPAL --- */
        main { flex: 1; position: relative; display: flex; flex-direction: column; overflow: hidden; width: 100%; }
        
        header { 
            height: 70px; background: white; border-bottom: 1px solid #e0e0e0; 
            display: flex; align-items: center; justify-content: space-between; 
            padding: 0 25px; gap: 15px; flex-shrink: 0; z-index: 40;
        }

        /* HEADER BRAND (Solo M칩vil) */
        .mobile-brand { display: none; align-items: center; gap: 10px; margin-right: auto; }
        .mobile-brand img { width: 38px; height: 38px; border-radius: 50%; border: 2px solid #eee; object-fit: contain; background: white; }
        .mobile-brand h2 { font-size: 1rem; font-weight: 800; color: #333; margin: 0; }

        .search-wrap { position: relative; flex: 1; max-width: 450px; }
        .search-wrap input { width: 100%; padding: 12px 20px 12px 45px; border-radius: 50px; border: 2px solid #f0f0f0; background: #f9f9f9; font-size: 0.95rem; transition: 0.3s; font-family: inherit; }
        .search-wrap input:focus { background: white; border-color: var(--primary); box-shadow: 0 4px 15px rgba(198, 40, 40, 0.15); }
        .search-wrap i { position: absolute; left: 18px; top: 50%; transform: translateY(-50%); color: #aaa; }
        
        .filter-group { display: flex; gap: 8px; }
        .chip { padding: 6px 14px; border-radius: 20px; font-size: 0.8rem; font-weight: 700; cursor: pointer; background: white; border: 1px solid #e0e0e0; color: #666; transition:0.2s; white-space: nowrap; }
        .chip.active { background: var(--dark); color: white; border-color: var(--dark); transform: scale(1.05); }

        /* --- VISTAS --- */
        .view-panel { padding: 25px; flex: 1; overflow-y: auto; -webkit-overflow-scrolling: touch; display: none; padding-bottom: 100px; }
        .view-panel.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- GRID CATALOGO --- */
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 15px; }
        .card { background: white; border-radius: 12px; overflow: hidden; border: 1px solid #eee; box-shadow: 0 2px 10px rgba(0,0,0,0.03); cursor: pointer; display: flex; flex-direction: column; transition: 0.2s; position: relative; }
        .card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.08); border-color: var(--primary); }
        
        .card-img-wrap { height: 160px; background: #f8f9fa; display: flex; justify-content: center; align-items: center; position: relative; overflow: hidden; }
        .card-img-wrap img { width: 100%; height: 100%; object-fit: cover; transition: 0.3s; }
        .card:hover img { transform: scale(1.05); }
        
        .badge-cat { position: absolute; top: 8px; right: 8px; padding: 3px 8px; border-radius: 4px; color: white; font-size: 0.65rem; font-weight: 800; text-transform: uppercase; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        
        .card-content { padding: 12px; flex: 1; display: flex; flex-direction: column; justify-content: space-between; }
        .card h4 { margin: 0; font-size: 0.95rem; color: #222; font-weight: 800; line-height: 1.3; }
        .card p { margin: 3px 0 10px; font-size: 0.8rem; color: #666; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        
        .card-footer { display: flex; justify-content: space-between; align-items: center; border-top: 1px dashed #eee; padding-top: 8px; margin-top: auto;}
        .price { color: var(--primary); font-weight: 900; font-size: 1.1rem; }
        .stock { font-size: 0.7rem; background: #E8F5E9; color: #2E7D32; padding: 2px 8px; border-radius: 4px; font-weight: 700; border: 1px solid #C8E6C9; }

        /* --- TABLA GENERIC --- */
        .table-wrap { background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 2px 10px rgba(0,0,0,0.05); border: 1px solid #eee; overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; font-size: 0.9rem; min-width: 600px; }
        thead { background: #37474F; color: white; font-weight: 700; }
        th, td { padding: 12px 15px; border-bottom: 1px solid #f0f0f0; text-align: left; vertical-align: middle; }
        tbody tr:hover { background: #fafafa; }
        .thumb { width: 45px; height: 45px; border-radius: 8px; object-fit: cover; border: 1px solid #ddd; }

        /* --- CONFIG FORM --- */
        .config-card { background: white; padding: 25px; border-radius: 15px; box-shadow: 0 5px 20px rgba(0,0,0,0.05); max-width: 800px; margin: 0 auto; }
        .form-row { margin-bottom: 20px; }
        .form-row label { display: block; font-weight: 700; font-size: 0.85rem; margin-bottom: 8px; color: #444; }
        .form-row input, .form-row select { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-family: inherit; font-size: 1rem; transition: 0.2s; }
        .form-row input:focus { border-color: var(--primary); }

        /* --- BOTONES --- */
        .btn { padding: 12px 20px; border-radius: 8px; border:none; cursor: pointer; font-weight: 700; width: 100%; transition: 0.2s; font-family: inherit; display:flex; align-items:center; justify-content:center; gap:8px;}
        .btn:active { transform: scale(0.96); }
        .btn-primary { background: var(--dark); color: white; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        .btn-success { background: #2E7D32; color: white; box-shadow: 0 4px 10px rgba(46, 125, 50, 0.3); }
        .btn-danger { background: #C62828; color: white; }
        .btn-blue { background: #1976D2; color: white; }

        /* --- ESTILOS M칍VIL --- */
        @media (max-width: 768px) {
            body { flex-direction: column; }
            /* Barra Inferior */
            aside { position: fixed; bottom: 0; left: 0; width: 100%; height: var(--nav-height-mobile); flex-direction: row; justify-content: space-around; padding: 0; background: white; border-top: 1px solid #eee; z-index: 1000; box-shadow: 0 -5px 20px rgba(0,0,0,0.05); }
            .brand, .sys-info, .backup-section { display: none; }
            .nav-menu { display: flex; flex-direction: row; width: 100%; padding: 0; justify-content: space-between; overflow:hidden;}
            .nav-item { flex-direction: column; justify-content: center; padding: 5px; flex: 1; border-radius: 0; margin: 0; border-top: 3px solid transparent; gap: 3px; color: #888; background: transparent; }
            .nav-item:hover { background: transparent; }
            .nav-item i { font-size: 1.4rem; color: #777; }
            .nav-item span { font-size: 0.6rem; color: #888; font-weight: 500; }
            .nav-item.active { border-top-color: var(--primary); background: #fafafa; color: var(--primary); }
            .nav-item.active i { color: var(--primary); }

            main { height: calc(100vh - var(--nav-height-mobile)); position: absolute; top: 0; width: 100%; }
            .view-panel { padding: 15px; padding-bottom: 90px !important; }
            
            /* Header M칩vil Modificado: LOGO IZQUIERDA */
            header { 
                padding: 10px 15px; height: auto; flex-wrap: wrap; gap: 10px; background: white; justify-content: space-between; align-items: center; 
            }
            .mobile-brand { display: flex; } /* Activar en m칩vil */
            .search-wrap { width: 100%; max-width: none; order: 3; }
            .filter-group { width: 100%; order: 4; }
            
            .grid { grid-template-columns: 1fr 1fr; gap: 10px; }
            .card-img-wrap { height: 110px; }
            .card h4 { font-size: 0.8rem; }
            
            .cart-drawer { width: 100%; right: -100%; z-index: 2000; }
            .cart-drawer.open { transform: translateX(-100%); }
            
            /* Ajuste teclado num칠rico */
            input[type=number], input[type=tel] { font-size: 18px !important; }
        }

        /* --- CARGADOR --- */
        #loader { position: fixed; top:0; left:0; width:100%; height:100%; background:white; z-index:9999; display:flex; justify-content:center; align-items:center; flex-direction:column; }
        .spinner { width:45px; height:45px; border:4px solid #f0f0f0; border-top-color:var(--primary); border-radius:50%; animation:spin 1s linear infinite; }
        @keyframes spin { 100% { transform:rotate(360deg); } }

        /* --- NOTIFICACIONES --- */
        #toast-container { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 5000; pointer-events: none; width: 90%; max-width: 350px; text-align: center; }
        .toast { background: #323232; color: white; padding: 14px 20px; border-radius: 8px; margin-top: 10px; animation: slideInTop 0.3s; font-weight: 600; box-shadow: 0 5px 20px rgba(0,0,0,0.2); display: inline-block; width: 100%; }
        @keyframes slideInTop { from{transform:translateY(-20px);opacity:0} to{transform:translateY(0);opacity:1} }
        
        /* --- IMPRESION --- */
        #print-layer { display: none; }
        @media print {
            body > *:not(#print-layer) { display: none !important; }
            #print-layer { display: block !important; position: absolute; top: 0; left: 0; width: 100%; z-index: 99999; background: white; min-height: 100vh;}
            @page { margin: 5mm; }
        }
        
        /* FILE UPLOAD BOX */
        .file-upload { border: 2px dashed #ccc; padding: 30px; text-align: center; border-radius: 12px; cursor: pointer; margin-top: 10px; background: #fafafa; transition:0.2s; }
        .file-upload:hover { border-color: var(--primary); background: #fffde7; }
        .file-upload img { max-height: 100px; display: none; margin: 0 auto; border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .file-upload.has-img img { display: block; }
        .file-upload.has-img span { display: none; }
    </style>
</head>

<body>

    <!-- PANTALLA CARGA -->
    <div id="loader">
        <div class="spinner"></div>
        <p style="margin-top:15px; color:#555; font-weight:bold; letter-spacing:1px;">CONECTANDO TIENDA...</p>
    </div>

    <!-- NOTIFICACIONES -->
    <div id="toast-container"></div>

    <!-- FONDO NEGRO MODALES -->
    <div class="overlay" id="mainOverlay" onclick="toggleCart()" style="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:900;display:none;backdrop-filter:blur(3px);"></div>

    <!-- BARRA LATERAL (PC) / NAVEGACION INFERIOR (M칍VIL) -->
    <aside>
        <div class="brand">
            <!-- LOGO PC (Se llena con Config) -->
            <img id="displayLogoSidebar" src="" alt="Logo">
            <h1 id="brandName">WORLD STORE</h1>
            <small>Sistema V9.1 Cloud</small>
        </div>
        <div class="nav-menu">
            <div class="nav-item active" onclick="nav('pos', this)">
                <i class="fa-solid fa-store"></i> <span>Cat치logo</span>
            </div>
            <div class="nav-item" onclick="nav('history', this)">
                <i class="fa-solid fa-receipt"></i> <span>Ventas</span>
            </div>
            <div class="nav-item" onclick="nav('inv', this)">
                <i class="fa-solid fa-boxes-stacked"></i> <span>Inventario</span>
            </div>
            <div class="nav-item" onclick="toggleCart()">
                <i class="fa-solid fa-cart-shopping"></i> <span>Carrito <b id="cartCountBadge" style="background:var(--primary); color:white; padding:1px 6px; border-radius:10px; font-size:0.7em;">0</b></span>
            </div>
            <div class="nav-item" onclick="nav('config', this)">
                <i class="fa-solid fa-sliders"></i> <span>Ajustes</span>
            </div>
        </div>
        <div class="sys-info"><span id="brandSub">ARIANA & GABRIEL</span></div>
    </aside>

    <!-- AREA PRINCIPAL -->
    <main>
        <!-- Banner de anuncios globales -->
        <div id="globalBanner"></div>

        <header>
            <!-- LOGO M칍VIL (Superior Izquierda) -->
            <div class="mobile-brand">
                <img id="mobileLogoImg" src="" style="display:none;">
                <h2 id="mobileTitleTxt">WORLD STORE</h2>
            </div>

            <div class="search-wrap">
                <i class="fa-solid fa-magnifying-glass"></i>
                <input type="text" id="searchInput" placeholder="Buscar modelo o c칩digo..." onkeyup="renderPOS()">
            </div>
            
            <div class="filter-group">
                <div class="chip active" onclick="filterCat('all', this)">Todo</div>
                <div class="chip" onclick="filterCat('Ni침o/Ni침a', this)">Ni침os</div>
                <div class="chip" onclick="filterCat('Dama', this)">Dama</div>
                <div class="chip" onclick="filterCat('Caballero', this)">Hombres</div>
            </div>
        </header>

        <!-- 1. VISTA CAT츼LOGO -->
        <div id="view-pos" class="view-panel active">
            <div class="grid" id="posGrid"></div>
        </div>

        <!-- 2. VISTA VENTAS (HISTORIAL) -->
        <div id="view-history" class="view-panel">
            <div style="background:white; padding:20px; border-radius:12px; box-shadow:0 4px 15px rgba(0,0,0,0.05); margin-bottom:20px; display:flex; justify-content:space-between; align-items:center;">
                <div>
                    <h3 style="margin:0; font-size:1.1rem;">Ventas Registradas</h3>
                    <small style="color:#777;">Sincronizado en Nube</small>
                </div>
                <div style="text-align:right;">
                    <div style="font-size:0.8rem; color:#777;">Total Ingresos</div>
                    <div style="font-size:1.5rem; font-weight:800; color:var(--primary)" id="grandTotalHistory">$0.00</div>
                </div>
            </div>
            
            <div class="table-wrap">
                <table>
                    <thead><tr><th>Fecha</th><th>Cliente</th><th>Detalle</th><th>Total</th><th>Acci칩n</th></tr></thead>
                    <tbody id="histBody"></tbody>
                </table>
            </div>
            <br>
            <button class="btn btn-danger" onclick="clearHistory()"><i class="fa-solid fa-trash-can"></i> Purgar Historial (Solo Admin)</button>
        </div>

        <!-- 3. VISTA INVENTARIO -->
        <div id="view-inv" class="view-panel">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h3 style="margin:0">Gesti칩n de Stock</h3>
                <button class="btn btn-success" style="width:auto; padding:10px 20px;" onclick="openModalProd()">
                    <i class="fa-solid fa-plus"></i> Nuevo
                </button>
            </div>
            <div class="table-wrap">
                <table>
                    <thead><tr><th>Foto</th><th>Producto</th><th>Precios</th><th>Stock</th><th>Editar</th></tr></thead>
                    <tbody id="invBody"></tbody>
                </table>
            </div>
        </div>

        <!-- 4. VISTA CONFIGURACI칍N (Avanzada) -->
        <div id="view-config" class="view-panel">
            <h3 style="margin-top:0">Configuraci칩n del Negocio</h3>
            <div class="config-card">
                <!-- Branding -->
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px; margin-bottom:20px;">
                    <div class="form-row"><label>Nombre Empresa</label><input type="text" id="cfgName"></div>
                    <div class="form-row"><label>Subt칤tulo / Propietario</label><input type="text" id="cfgSub"></div>
                </div>
                
                <div class="form-row">
                    <label>Logo Oficial (JPG/PNG)</label>
                    <div style="border:1px solid #ddd; padding:15px; border-radius:8px; display:flex; align-items:center; gap:15px; background:#f9f9f9;">
                        <img id="cfgLogoPreview" src="" style="width:60px; height:60px; object-fit:contain; background:white; border-radius:50%; border:1px solid #ccc;">
                        <div style="flex:1;">
                            <input type="file" accept="image/*" onchange="encodeLogo(this)">
                            <div style="font-size:0.7rem; color:#777; margin-top:5px;">Se usar치 en la App y Facturas. M치x 300KB.</div>
                            <input type="hidden" id="cfgLogoData">
                        </div>
                    </div>
                </div>

                <!-- Preferencias -->
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;">
                    <div class="form-row"><label>Tel칠fono</label><input type="tel" id="cfgTel"></div>
                    <div class="form-row"><label>Moneda</label><input type="text" id="cfgCurrency"></div>
                </div>
                
                <div class="form-row"><label>Mensaje en Factura</label><input type="text" id="cfgFooter"></div>
                <div class="form-row"><label>Color de Tema</label><input type="color" id="cfgColor" style="height:45px; padding:2px; width:100%; border-radius:8px;" onchange="previewColor(this.value)"></div>
                
                <!-- Extras Cloud -->
                <hr style="border:0; border-top:1px dashed #ddd; margin:20px 0;">
                <h4 style="margin-bottom:10px;">Herramientas Cloud</h4>
                
                <div class="form-row">
                    <label>Anuncio Global (Aparece arriba en todos los equipos)</label>
                    <input type="text" id="cfgBanner" placeholder="Ej: 춰Lleg칩 mercanc칤a nueva!">
                </div>

                <div style="background:#FFF3E0; padding:15px; border-radius:8px; border:1px solid #FFE0B2; margin-bottom:20px;">
                    <label style="display:flex; align-items:center; gap:10px; cursor:pointer; font-weight:700; color:#E65100;">
                        <input type="checkbox" id="cfgMaintenance" style="width:20px; height:20px;">
                        <span>ACTIVAR MODO MANTENIMIENTO (Bloquea Ventas)</span>
                    </label>
                </div>

                <button class="btn btn-primary" onclick="window.saveConfig()">
                    <i class="fa-solid fa-cloud-arrow-up"></i> GUARDAR CAMBIOS GLOBALES
                </button>
                
                <div style="margin-top:30px;">
                    <button class="btn btn-blue" onclick="window.reloadInitialData()" style="opacity:0.8;">
                        <i class="fa-solid fa-rotate-left"></i> Restaurar Cat치logo Base (PDF)
                    </button>
                </div>
            </div>
        </div>
    </main>

    <!-- CAJON CARRITO -->
    <div id="cartDrawer" style="position:fixed;top:0;right:-450px;width:450px;height:100%;background:white;z-index:1100;transition:0.3s;display:flex;flex-direction:column;box-shadow:-5px 0 30px rgba(0,0,0,0.2);">
        <div style="padding:20px; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center;">
            <h3 style="margin:0; font-weight:800;">游 Tu Pedido</h3>
            <button onclick="toggleCart()" style="background:none; border:none; font-size:1.8rem; cursor:pointer;">&times;</button>
        </div>
        <div class="cart-items" id="cartContainer" style="flex:1; overflow-y:auto; padding:20px;"></div>
        <div style="padding:20px; background:#fafafa; border-top:1px solid #eee;">
            <div class="client-inputs">
                <input type="text" id="cartClientName" placeholder="Nombre del Cliente (Obligatorio)" style="width:100%; padding:12px; border:1px solid #ddd; border-radius:6px; margin-bottom:10px;">
                <input type="tel" id="cartClientPhone" placeholder="Tel칠fono" style="width:100%; padding:12px; border:1px solid #ddd; border-radius:6px; margin-bottom:15px;">
            </div>
            <div style="display:flex; justify-content:space-between; font-size:1.4rem; font-weight:900; margin-bottom:20px;">
                <span>Total:</span> <span id="cartTotalDisplay" style="color:var(--primary)">$0.00</span>
            </div>
            <button class="btn btn-success" style="font-size:1.1rem; padding:15px;" onclick="window.processSale()">
                CONFIRMAR VENTA <i class="fa-solid fa-check"></i>
            </button>
        </div>
    </div>

    <!-- MODAL VENTA -->
    <div id="modalSale" class="modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:2000; align-items:center; justify-content:center; padding:20px;">
        <div class="modal-box" style="background:white; width:500px; max-width:100%; padding:25px; border-radius:15px; position:relative; animation:slideUp 0.3s;">
            <h3 id="saleTitle" style="margin-top:0; color:var(--dark);">Producto</h3>
            <input type="hidden" id="saleId">
            <div style="background:#f9f9f9; padding:15px; border-radius:10px; margin:15px 0; text-align:center;">
                <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:8px;">
                    <button class="btn" style="font-size:0.75rem;" id="btn-doc" onclick="setSaleType('doc')">DOCENA</button>
                    <button class="btn" style="font-size:0.75rem;" id="btn-half" onclick="setSaleType('half')">MEDIA</button>
                    <button class="btn" style="font-size:0.75rem;" id="btn-unit" onclick="setSaleType('unit')">PAR</button>
                </div>
                <div id="unitPriceDisplay" style="margin-top:10px; font-weight:700; color:#666;"></div>
            </div>
            <div style="display:flex; gap:10px; margin-bottom:25px; align-items:center;">
                <button class="btn" style="background:#eee; font-size:1.5rem; width:60px;" onclick="adjQty(-1)">-</button>
                <input type="number" id="saleQty" value="1" min="1" style="flex:1; text-align:center; padding:15px; font-size:1.4rem; border:1px solid #ddd; border-radius:8px; font-weight:bold;" onchange="updateCalc()">
                <button class="btn" style="background:#eee; font-size:1.5rem; width:60px;" onclick="adjQty(1)">+</button>
            </div>
            <div style="text-align:right; font-size:2rem; font-weight:900; color:var(--primary); margin-bottom:25px;">
                <span id="saleTotalCalc">$0.00</span>
            </div>
            <div style="display:flex; gap:10px;">
                <button class="btn" style="background:#f0f0f0; flex:1; color:#333;" onclick="closeModal('modalSale')">Volver</button>
                <button class="btn btn-success" style="flex:2;" onclick="confirmAdd()">AGREGAR</button>
            </div>
        </div>
    </div>

    <!-- MODAL PRODUCTO -->
    <div id="modalProd" class="modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:2000; align-items:center; justify-content:center; padding:20px;">
        <div class="modal-box" style="background:white; width:600px; max-width:100%; padding:25px; border-radius:15px; overflow-y:auto; max-height:90vh;">
            <h3 id="modalProdTitle" style="margin-top:0;">Datos del Producto</h3>
            <input type="hidden" id="prodId"><input type="hidden" id="prodImgBase64">
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px;">
                <div style="grid-column:span 2"><label>Modelo</label><input type="text" id="pModel" class="w-100"></div>
                <div><label>C칩digo</label><input type="text" id="pCode" class="w-100"></div>
                <div><label>Categor칤a</label><select id="pCat" class="w-100"><option>Dama</option><option>Caballero</option><option>Ni침o/Ni침a</option></select></div>
                <div><label>Precio Docena</label><input type="number" id="pPrice" class="w-100"></div>
                <div><label>Precio Par (Opc)</label><input type="number" id="pPriceUnit" class="w-100" placeholder="Auto"></div>
                <div><label>Stock Pares</label><input type="number" id="pStock" class="w-100"></div>
                <div><label>Tallas</label><input type="text" id="pSize" class="w-100"></div>
            </div>
            <div class="file-upload" onclick="document.getElementById('fileInput').click()">
                <i class="fa-solid fa-camera fa-2x" style="color:#ccc;"></i><br>
                <span>Tocar para subir imagen</span>
                <img id="imgPreview">
                <input type="file" id="fileInput" accept="image/*" style="display:none" onchange="handleImageUpload(this)">
            </div>
            <div style="margin-top:25px; display:flex; gap:10px;">
                <button class="btn btn-danger" onclick="closeModal('modalProd')">Cancelar</button>
                <button class="btn btn-success" onclick="window.saveProduct()">GUARDAR</button>
            </div>
        </div>
    </div>

    <!-- SCRIPT DE FIREBASE + L칍GICA -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

    <script>
        // CREDENCIALES
        const firebaseConfig = {
            apiKey: "AIzaSyB5ygJIoEgpJPKY0qMULocohmzXGc7UWFE",
            authDomain: "worldstoresystem.firebaseapp.com",
            databaseURL: "https://worldstoresystem-default-rtdb.firebaseio.com",
            projectId: "worldstoresystem",
            storageBucket: "worldstoresystem.firebasestorage.app",
            messagingSenderId: "460628958914",
            appId: "1:460628958914:web:95da76852bedecbdcf255b",
            measurementId: "G-9NQMR0XVHT"
        };

        firebase.initializeApp(firebaseConfig);
        const dbRef = firebase.database();

        let db=[], history=[], config={name:"WORLD STORE", color:"#C62828", currency:"$"};
        let cart=[], curFilter='all', saleItem=null, saleMode='doc';

        // MASTER DATABASE (DEL PDF)
        const MASTER_DB = [
            {c:"W 15",m:"Crocs Cl치sico Baby",d:46,cat:"Dama"},{c:"LC W72-3",m:"Crocs Pastel",d:32,cat:"Dama"},{c:"LC W99-1",m:"Sandalia Peluche",d:48,cat:"Dama"},{c:"LC W-801",m:"Plataforma Barbie",d:35,cat:"Dama"},
            {c:"LC M14-2",m:"Slide Gato/Vaca",d:38,cat:"Dama"},{c:"HY 047-1",m:"Croc Banda",d:42,cat:"Dama"},{c:"HY 047-2",m:"Croc Bicolor",d:42,cat:"Dama"},{c:"HY 047-3",m:"Croc Peluche",d:47,cat:"Dama"},
            {c:"HY 040-1",m:"Croc Kuromi",d:32,cat:"Dama"},{c:"HY 040-3",m:"Croc Dijes",d:33,cat:"Dama"},{c:"HY 040-4",m:"Croc Joyas",d:34,cat:"Dama"},{c:"HY 040-6",m:"Croc Perlas",d:36,cat:"Dama"},
            {c:"HY 077",m:"Croc Flor",d:34,cat:"Dama"},{c:"RS 111",m:"Croc Cadena",d:43,cat:"Dama"},{c:"RS 110",m:"Plat. Chunky",d:50,cat:"Dama"},{c:"RS 109",m:"Croc Diamante",d:39,cat:"Dama"},
            {c:"RS 112",m:"Croc Reptil",d:31,cat:"Dama"},{c:"RS 107",m:"Nike Style Liso",d:44,cat:"Dama"},{c:"RS 202",m:"Hebilla Cuadro",d:35,cat:"Dama"},{c:"HY 056",m:"Concha Shell",d:35,cat:"Dama"},
            {c:"RS 123",m:"Slide Nike",d:35,cat:"Dama"},{c:"HY 032",m:"Plat. Arrugada",d:43,cat:"Dama"},{c:"HY 032-1",m:"Lazo Corona",d:47,cat:"Dama"},{c:"HY 011-2",m:"Marmoleada",d:41,cat:"Dama"},
            {c:"RS A9",m:"Diamante Slide",d:34,cat:"Dama"},{c:"HY 006-1",m:"Cadena Plata",d:42,cat:"Dama"},{c:"LB-03",m:"Chancla Acolchada",d:35,cat:"Dama"},{c:"HY 006-2",m:"Cadena Conejo",d:42,cat:"Dama"},
            {c:"HY 011-1",m:"Flor Plataforma",d:47,cat:"Dama"},{c:"HY 002-1",m:"Vaca Lola",d:36,cat:"Dama"},{c:"HY 002-3",m:"Love Gatos",d:40,cat:"Dama"},{c:"HY 001",m:"Nube Confort",d:41,cat:"Dama"},
            {c:"LC W99",m:"Tornasol",d:48,cat:"Dama"},{c:"RS A2",m:"Nike SB Retro",d:36,cat:"Dama"},{c:"RS A2-1",m:"Lazo Nice",d:34,cat:"Dama"},{c:"LC B-2426-1",m:"Pata Gallo Chunky",d:30,cat:"Dama"},
            {c:"HY 028-4",m:"Pata Gallo Flores",d:30,cat:"Dama"},{c:"PW 33-1",m:"Flip Flop Flora",d:30,cat:"Dama"},{c:"HY 022",m:"Prada Cruzada",d:42,cat:"Dama"},{c:"HY 058-1",m:"Plat. Mo침o G",d:45,cat:"Dama"},
            {c:"HY 029",m:"Trekking",d:56,cat:"Dama"},{c:"LC W-15",m:"Sport Linea",d:46,cat:"Dama"},{c:"W-06",m:"Confort Dedo",d:28,cat:"Dama"},{c:"LC B-2426",m:"Chunky Liso",d:30,cat:"Dama"},{c:"W-99-2",m:"3 Rayas",d:36,cat:"Dama"},
            {c:"LC M-15D",m:"Croc Camuflaje",d:52,cat:"Caballero"},{c:"M-15",m:"Croc Largo",d:50,cat:"Caballero"},{c:"LA-08",m:"Adidas Old",d:38,cat:"Caballero"},{c:"SM 99-3",m:"Trefoil",d:45,cat:"Caballero"},
            {c:"LC M-76",m:"Agnetig Magnet",d:35,cat:"Caballero"},{c:"LC M-75",m:"M Logo Sport",d:34,cat:"Caballero"},{c:"M-60",m:"Adidas Slide",d:38,cat:"Caballero"},{c:"LC M-99-1",m:"Velcro Doble",d:48,cat:"Caballero"},
            {c:"SM 99-8",m:"Adidas Banda",d:45,cat:"Caballero"},{c:"SM 99-5",m:"Sport Label",d:45,cat:"Caballero"},{c:"SM 99-4",m:"Just Do It",d:45,cat:"Caballero"},{c:"M99-2",m:"Adidas Largo",d:38,cat:"Caballero"},
            {c:"RS 108",m:"Nike Cerrado",d:51,cat:"Caballero"},{c:"HY 060-1",m:"Splash Paint",d:45,cat:"Caballero"},{c:"HY 076",m:"Hong Yuan",d:34,cat:"Caballero"},{c:"HY 045",m:"Croc Basico",d:31,cat:"Caballero"},
            {c:"RS A3",m:"Retro Logo",d:41,cat:"Caballero"},{c:"HY 016",m:"Yeezy Liso",d:36,cat:"Caballero"},{c:"HY 049-1",m:"Sport Letras",d:48,cat:"Caballero"},{c:"LC A-2402",m:"Surf Style",d:36,cat:"Caballero"},
            {c:"HY 016-1",m:"Yeezy Camu",d:46,cat:"Caballero"},{c:"HY 037",m:"Franja Malla",d:38,cat:"Caballero"},{c:"HY 010",m:"Futurista",d:36,cat:"Caballero"},{c:"LC AM14-1",m:"Tejido",d:34,cat:"Caballero"},
            {c:"HY 033",m:"Ranuras",d:35,cat:"Caballero"},{c:"LC A-2403",m:"Largo Basic",d:29,cat:"Caballero"},{c:"LC A-2402D",m:"Selva Camu",d:45,cat:"Caballero"},{c:"LC M99",m:"Jordan 23",d:50,cat:"Caballero"},
            {c:"HY 007",m:"Cuadros",d:30,cat:"Caballero"},{c:"HY 049",m:"Velcro Lateral",d:50,cat:"Caballero"},{c:"RS 101",m:"Basket",d:34,cat:"Caballero"},{c:"HY 042",m:"Pata Gallo Gruesa",d:30,cat:"Caballero"},
            {c:"HY 027",m:"Pata Gallo Fina",d:30,cat:"Caballero"},{c:"HY 031-4",m:"Senderismo",d:56,cat:"Caballero"},{c:"B-2404",m:"Magnetig M",d:32,cat:"Caballero"},{c:"HY 040-2",m:"Sport Lines",d:31,cat:"Caballero"},
            {c:"HY 060",m:"Perforado",d:44,cat:"Caballero"},
            {c:"LC C-09D",m:"Animales 3D",d:44,cat:"Ni침o/Ni침a"},{c:"LC C-02-1",m:"Hello/Bear",d:32,cat:"Ni침o/Ni침a"},{c:"LC D-55-1",m:"Peppa Slide",d:32,cat:"Ni침o/Ni침a"},{c:"LC C-55-1",m:"Pizza/Hello",d:33,cat:"Ni침o/Ni침a"},
            {c:"LC C-07-1",m:"Jirafa",d:30,cat:"Ni침o/Ni침a"},{c:"LC C-04",m:"Labubu",d:33,cat:"Ni침o/Ni침a"},{c:"LC 05",m:"Nike Kid",d:32,cat:"Ni침o/Ni침a"},{c:"RS 106",m:"Mickey",d:35,cat:"Ni침o/Ni침a"},
            {c:"RS 133",m:"Kiss",d:31,cat:"Ni침o/Ni침a"},{c:"HY 038-1",m:"Dino/Ni침a",d:27,cat:"Ni침o/Ni침a"},{c:"HY 039-1",m:"Coco",d:29,cat:"Ni침o/Ni침a"},{c:"RS 119",m:"Garra",d:27,cat:"Ni침o/Ni침a"},
            {c:"RS 113",m:"Deportes",d:33,cat:"Ni침o/Ni침a"},{c:"HY 009-1",m:"Bebidas",d:33,cat:"Ni침o/Ni침a"},{c:"HY 017-1",m:"Baby Flores",d:27,cat:"Ni침o/Ni침a"},{c:"HY 018-1",m:"Cohete",d:30,cat:"Ni침o/Ni침a"},
            {c:"HY 003-1",m:"Vaca Kid",d:32,cat:"Ni침o/Ni침a"},{c:"LC D-08-1",m:"Pata Oso",d:29,cat:"Ni침o/Ni침a"},{c:"LO 024",m:"Bob Esponja",d:33,cat:"Ni침o/Ni침a"},{c:"RS A1",m:"Yeezy Kid",d:28,cat:"Ni침o/Ni침a"},
            {c:"LO 020",m:"Kitty Face",d:26,cat:"Ni침o/Ni침a"},{c:"HY 055-4",m:"Bota Lazo",d:36,cat:"Ni침o/Ni침a"},{c:"HY 055-7",m:"Bota Gato",d:40,cat:"Ni침o/Ni침a"},{c:"HY 019",m:"Sand. Vaca",d:39,cat:"Ni침o/Ni침a"},
            {c:"HY 013-1",m:"Croc Fashion",d:27,cat:"Ni침o/Ni침a"},{c:"HY 020-3",m:"Velcro Pastel",d:50,cat:"Ni침o/Ni침a"},{c:"HY 015-1",m:"Hebilla",d:29,cat:"Ni침o/Ni침a"},{c:"HY 030-3",m:"Princesa",d:55,cat:"Ni침o/Ni침a"},
            {c:"HY 020-1",m:"Sport Velcro",d:31,cat:"Ni침o/Ni침a"},{c:"HY 026",m:"Love Osos",d:40,cat:"Ni침o/Ni침a"},{c:"LO 078-5",m:"Cadena Oro",d:35,cat:"Ni침o/Ni침a"},{c:"LC 01",m:"Mario",d:31,cat:"Ni침o/Ni침a"},
            {c:"C-07",m:"Palta",d:29,cat:"Ni침o/Ni침a"},{c:"LC C-09",m:"Borde Color",d:44,cat:"Ni침o/Ni침a"},{c:"LC C-02",m:"Kaws",d:32,cat:"Ni침o/Ni침a"},{c:"LC D-08",m:"Pata Joy",d:29,cat:"Ni침o/Ni침a"},
            {c:"HY 017-2",m:"Baby Star",d:27,cat:"Ni침o/Ni침a"},{c:"HY 018-2",m:"Croc Zanahoria",d:30,cat:"Ni침o/Ni침a"},{c:"HY 038-2",m:"Dino Grey",d:27,cat:"Ni침o/Ni침a"},{c:"HY 009-2",m:"Poker",d:33,cat:"Ni침o/Ni침a"},
            {c:"LO 043",m:"London",d:31,cat:"Ni침o/Ni침a"},{c:"G 008B",m:"Golfer",d:31,cat:"Ni침o/Ni침a"},{c:"LC D-55",m:"Rubik",d:32,cat:"Ni침o/Ni침a"},{c:"LC C-55",m:"Pizza Slide",d:33,cat:"Ni침o/Ni침a"},
            {c:"HY 055-5",m:"Bota Dino",d:36,cat:"Ni침o/Ni침a"},{c:"HY 055-6",m:"Bota Husky",d:40,cat:"Ni침o/Ni침a"},{c:"HY 013",m:"Bucle Baby",d:27,cat:"Ni침o/Ni침a"},{c:"HY 015",m:"Sport F",d:29,cat:"Ni침o/Ni침a"},
            {c:"HY 020-5",m:"Gris Naranja",d:52,cat:"Ni침o/Ni침a"},{c:"HY 030-4",m:"Trekking Boy",d:55,cat:"Ni침o/Ni침a"},{c:"HY 030-5",m:"Sand. Sport",d:55,cat:"Ni침o/Ni침a"}
        ];

        // --- CONEXIONES REALTIME ---
        const invRef = dbRef.ref('inventory');
        const histRef = dbRef.ref('history');
        const cfgRef = dbRef.ref('config');

        // INVENTARIO
        invRef.on('value', snap => {
            const val = snap.val();
            if(val && val.length > 0) {
                db = val;
                renderPOS();
                renderInv();
            } else {
                // RESTAURAR BASE DE DATOS MAESTRA SI EST츼 VAC칈A (PRIMERA VEZ)
                const init = MASTER_DB.map((p,i)=>({
                    ...p, id: Date.now()+i, stock: 72, p_unit: 0, img: "",
                    t: p.cat==='Dama'?'36-40':(p.cat==='Caballero'?'40-45':'30-35')
                }));
                invRef.set(init);
            }
            document.getElementById('loader').style.display='none';
        });

        // HISTORIAL
        histRef.on('value', snap => {
            const v = snap.val();
            history = v ? Object.values(v).sort((a,b)=>b.id-a.id) : [];
            renderHistory();
        });

        // CONFIGURACI칍N
        cfgRef.on('value', snap => {
            const v = snap.val();
            if(v) { config = v; applyConfig(); renderPOS(); }
        });


        // --- LOGICA DE UI Y FUNCIONES ---
        
        // 1. NAV SYSTEM
        function nav(view, el) {
            document.querySelectorAll('.view-panel').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
            document.getElementById('view-'+view).classList.add('active');
            el.classList.add('active');
            if(view==='pos') { renderPOS(); updateMobileTitle("CAT츼LOGO"); }
            if(view==='inv') { updateMobileTitle("INVENTARIO"); }
            if(view==='history') { updateMobileTitle("VENTAS"); }
            if(view==='config') { updateMobileTitle("AJUSTES"); }
        }
        function updateMobileTitle(t){ if(window.innerWidth<=768) document.getElementById('mobileTitleTxt').innerText=t; }

        // 2. POS RENDER
        function renderPOS() {
            if(config.maintenance && window.location.hash !== "#admin") {
                document.getElementById('posGrid').innerHTML=`<div style="width:100%;text-align:center;padding:40px;color:#777;"><i class="fa-solid fa-lock" style="font-size:3rem;margin-bottom:15px;"></i><h3>TIENDA CERRADA POR MANTENIMIENTO</h3></div>`;
                return;
            }
            
            const g = document.getElementById('posGrid');
            const term = document.getElementById('searchInput').value.toLowerCase();
            g.innerHTML = "";
            
            const list = db.filter(p => (p.c.toLowerCase().includes(term)||p.m.toLowerCase().includes(term))&&(curFilter==='all'||p.cat===curFilter));
            const cur = config.currency||"$";

            list.forEach(p => {
                const img = p.img || `https://placehold.co/400x400/f5f5f5/999?text=${p.c}`;
                const bg = p.cat==='Dama'?'#EC407A':(p.cat==='Caballero'?'#607D8B':'#42A5F5');
                
                g.innerHTML += `
                <div class="card" onclick="openSale(${p.id})">
                    <div class="card-img-wrap"><img src="${img}" loading="lazy"><span class="badge-cat" style="background:${bg}">${p.cat.substring(0,3)}</span></div>
                    <div class="card-content">
                        <div><h4>${p.c}</h4><p>${p.m}</p></div>
                        <div class="card-footer"><span class="stock">${p.stock} p.</span><span class="price">${cur}${p.d}</span></div>
                    </div>
                </div>`;
            });
        }

        // 3. VENTA MODAL
        window.openSale = function(id) {
            saleItem = db.find(x => x.id === id);
            document.getElementById('saleTitle').innerText = saleItem.c;
            document.getElementById('saleId').value = id;
            document.getElementById('saleQty').value = 1;
            window.setSaleType('doc');
            document.getElementById('modalSale').style.display='flex';
        }
        
        window.setSaleType = function(t) {
            saleMode = t;
            ['doc','half','unit'].forEach(type => {
                const btn = document.getElementById('btn-'+type);
                if(t === type) { btn.style.background='var(--primary)'; btn.style.color='white'; }
                else { btn.style.background='#eee'; btn.style.color='#333'; }
            });
            window.updateCalc();
        }

        window.updateCalc = function() {
            const q = parseInt(document.getElementById('saleQty').value)||1;
            const cur = config.currency;
            let p=0, txt="";
            
            if(saleMode === 'doc') { p=saleItem.d; txt=`${cur}${p} /paquete`; }
            else if(saleMode === 'half') { p=saleItem.d/2; txt=`${cur}${p.toFixed(2)} /media`; }
            else { p=saleItem.p_unit>0?saleItem.p_unit:(saleItem.d/12)*1.6; txt=`${cur}${p.toFixed(2)} /par`; }

            document.getElementById('unitPriceDisplay').innerText=txt;
            document.getElementById('saleTotalCalc').innerText=`${cur}${(p*q).toFixed(2)}`;
        }
        
        window.adjQty=function(n){ let v=parseInt(document.getElementById('saleQty').value)+n; if(v<1)v=1; document.getElementById('saleQty').value=v; updateCalc(); }
        window.confirmAdd=function(){
            const q=parseInt(document.getElementById('saleQty').value);
            const tot=parseFloat(document.getElementById('saleTotalCalc').innerText.replace(/[^0-9.]/g,''));
            let lbl=saleMode==='doc'?'Doc':(saleMode==='half'?'Med':'Par');
            let ded=saleMode==='doc'?12*q:(saleMode==='half'?6*q:q);
            if(saleItem.stock<ded) if(!confirm("춰Stock Insuficiente! 쮺ontinuar?")) return;
            
            cart.push({pId:saleItem.id,c:saleItem.c,m:saleItem.m,qtyTxt:`${q} ${lbl}`,total:tot,deduct:ded});
            closeModal('modalSale'); renderCart(); toggleCart(); Toast.show("A침adido");
        }

        // 4. CARRITO
        window.toggleCart=function(){ 
            document.getElementById('cartDrawer').classList.toggle('open'); 
            document.getElementById('mainOverlay').classList.toggle('active'); // Fondo oscuro activo
            renderCart(); 
        }

        function renderCart(){
            const c=document.getElementById('cartContainer'); c.innerHTML=""; let t=0; const cur=config.currency;
            if(cart.length===0) c.innerHTML=`<div style="text-align:center;padding-top:40px;color:#aaa;"><i class="fa-solid fa-basket-shopping" style="font-size:2rem;margin-bottom:10px;"></i><p>Carrito Vac칤o</p></div>`;
            cart.forEach((i,idx)=>{
                t+=i.total;
                c.innerHTML+=`<div class="c-item"><div style="flex:1"><b>${i.c}</b> <small>${i.qtyTxt}</small></div><div style="text-align:right"><b>${cur}${i.total.toFixed(2)}</b> <i class="fa-solid fa-trash" style="color:red; margin-left:10px; cursor:pointer;" onclick="cart.splice(${idx},1);renderCart()"></i></div></div>`;
            });
            document.getElementById('cartTotalDisplay').innerText=`${cur}${t.toFixed(2)}`;
            document.getElementById('cartCountBadge').innerText=cart.length;
        }

        window.processSale = function() {
            if(cart.length===0) return Toast.show("Venta Vac칤a","error");
            const nm=document.getElementById('cartClientName').value.trim();
            if(!nm) return alert("Nombre obligatorio");
            
            let tot=0, desc="", snap=JSON.parse(JSON.stringify(cart));
            cart.forEach(i=>{
                tot+=i.total;
                desc+=`${i.qtyTxt} ${i.c}, `;
                const p=db.find(x=>x.id==i.pId);
                if(p) p.stock-=i.deduct;
            });
            
            invRef.set(db); // Guardar inventario actualizado
            const rec={ id:Date.now(), date:new Date().toLocaleDateString(), client:nm, phone:document.getElementById('cartClientPhone').value, total:tot, items:snap, desc:desc };
            histRef.push(rec); // Guardar historial

            printData(rec);
            cart=[]; document.getElementById('cartClientName').value=""; document.getElementById('cartClientPhone').value="";
            renderCart(); toggleCart(); Toast.show("Venta Exitosa");
        }

        // 5. FUNCIONES EXTRAS
        window.reloadInitialData = function() {
            if(confirm("춰CUIDADO! Esto borrar치 cualquier producto nuevo que hayas creado y restaurar치 la lista original del PDF. 쯉eguro?")) {
                 const init = MASTER_DB.map((p,i)=>({...p, id: Date.now()+i, stock: 72, p_unit: 0, img: "", t: p.cat==='Dama'?'36-40':'36-42'}));
                 invRef.set(init);
                 Toast.show("Restauraci칩n Completada");
            }
        }
        
        window.saveConfig=function(){
            config.name = document.getElementById('cfgName').value; config.sub = document.getElementById('cfgSub').value;
            config.tel = document.getElementById('cfgTel').value; config.currency = document.getElementById('cfgCurrency').value;
            config.footer = document.getElementById('cfgFooter').value; config.color = document.getElementById('cfgColor').value;
            config.banner = document.getElementById('cfgBanner').value; config.maintenance = document.getElementById('cfgMaintenance').checked;
            const l=document.getElementById('cfgLogoData').value; if(l) config.logo=l;
            cfgRef.set(config); Toast.show("Configuraci칩n Guardada");
        }

        // UTILS
        function applyConfig(){
            document.documentElement.style.setProperty('--primary', config.color);
            // Header Info
            document.getElementById('brandName').innerText=config.name; document.getElementById('brandSub').innerText=config.sub;
            document.getElementById('mobileTitleTxt').innerText=config.name.toUpperCase();
            
            // Inputs fill
            document.getElementById('cfgName').value=config.name; document.getElementById('cfgSub').value=config.sub;
            document.getElementById('cfgTel').value=config.tel; document.getElementById('cfgCurrency').value=config.currency;
            document.getElementById('cfgFooter').value=config.footer; document.getElementById('cfgColor').value=config.color;
            document.getElementById('cfgBanner').value=config.banner||""; document.getElementById('cfgMaintenance').checked=config.maintenance;
            
            // Banner Global
            const ban = document.getElementById('globalBanner');
            if(config.banner) { ban.innerText=config.banner; ban.style.display='block'; } else { ban.style.display='none'; }
            
            // Logo Logic
            if(config.logo){
                const ls=document.getElementById('displayLogoSidebar'); ls.src=config.logo; ls.style.display='block';
                const lm=document.getElementById('mobileLogoImg'); lm.src=config.logo; lm.style.display='block';
                const lp=document.getElementById('printLogoDisplay'); lp.src=config.logo; lp.style.display='block';
                document.getElementById('cfgLogoPreview').src=config.logo;
            }
        }

        window.previewColor=function(c){ document.documentElement.style.setProperty('--primary', c); }
        window.filterCat=function(c,el){ curFilter=c; document.querySelectorAll('.chip').forEach(e=>e.classList.remove('active')); el.classList.add('active'); renderPOS(); }
        window.openModalProd=function(){ ['prodId','pCode','pModel','pPrice','pPriceUnit','pStock','prodImgBase64'].forEach(x=>document.getElementById(x).value=""); document.getElementById('imgPreview').src=""; document.getElementById('modalProd').style.display='flex'; }
        window.closeModal=function(id){ document.getElementById(id).style.display='none'; }
        
        window.saveProduct=function(){
            const id=document.getElementById('prodId').value;
            const obj={ c:document.getElementById('pCode').value, m:document.getElementById('pModel').value, cat:document.getElementById('pCat').value, d:parseFloat(document.getElementById('pPrice').value)||0, p_unit:parseFloat(document.getElementById('pPriceUnit').value)||0, stock:parseInt(document.getElementById('pStock').value), t:document.getElementById('pSize').value, img:document.getElementById('prodImgBase64').value };
            let newDb=[...db]; if(id){const i=newDb.findIndex(x=>x.id==id); newDb[i]={...newDb[i],...obj}}else{newDb.unshift({...obj,id:Date.now()})}
            invRef.set(newDb); closeModal('modalProd'); Toast.show("Guardado");
        }
        window.encodeLogo=function(i){if(i.files[0]){const r=new FileReader(); r.onload=e=>{document.getElementById('cfgLogoData').value=e.target.result; document.getElementById('cfgLogoPreview').src=e.target.result;}; r.readAsDataURL(i.files[0]);}}
        window.handleImageUpload=function(i){if(i.files[0]){if(i.files[0].size>250000) return alert("M치x 250kb"); const r=new FileReader(); r.onload=e=>{document.getElementById('imgPreview').src=e.target.result; document.getElementById('prodImgBase64').value=e.target.result;}; r.readAsDataURL(i.files[0]);}}
        
        function renderInv(){ const t=document.getElementById('invBody'); t.innerHTML=""; const cur=config.currency; db.forEach(p=>{ t.innerHTML+=`<tr><td><img src="${p.img||'https://placehold.co/50'}" class="thumb"></td><td><b>${p.c}</b></td><td>${cur}${p.d}</td><td>${p.stock}</td><td><i class="fa-solid fa-pen" style="color:#1976D2; cursor:pointer;" onclick="editProd(${p.id})"></i></td></tr>`; }); }
        window.editProd=function(id){ const p=db.find(x=>x.id==id); document.getElementById('prodId').value=p.id; document.getElementById('pCode').value=p.c; document.getElementById('pModel').value=p.m; document.getElementById('pPrice').value=p.d; document.getElementById('pPriceUnit').value=p.p_unit||""; document.getElementById('pStock').value=p.stock; document.getElementById('pSize').value=p.t; document.getElementById('pCat').value=p.cat; if(p.img) document.getElementById('imgPreview').src=p.img; document.getElementById('modalProd').style.display='flex'; }
        
        function renderHistory(){ const t=document.getElementById('histBody'); t.innerHTML=""; let gt=0; const cur=config.currency; history.forEach(h=>{ gt+=h.total; t.innerHTML+=`<tr><td style="font-size:0.7rem">${h.date.split(' ')[0]}</td><td><b>${h.client}</b></td><td><button class="btn" style="padding:2px 8px;font-size:0.7rem;background:#eee" onclick="alert('${h.desc}')">Ver</button></td><td>${cur}${h.total.toFixed(2)}</td><td><i class="fa-solid fa-print" style="color:blue;margin-right:10px;" onclick="reprint(${h.id})"></i></td></tr>`; }); document.getElementById('grandTotalHistory').innerText=`${cur}${gt.toFixed(2)}`; }
        window.clearHistory=function(){ if(confirm("쮼LIMINAR TODO?")) histRef.set(null); }
        window.reprint=function(id){ const h=history.find(x=>x.id==id); if(h) printData(h,true); }
        
        function printData(rec,cp=false){
            document.getElementById('printBrand').innerText=config.name; document.getElementById('printSub').innerText=config.sub; document.getElementById('printTel').innerText=config.tel; document.getElementById('printDate').innerText=rec.date; document.getElementById('printFooter').innerText=config.footer;
            document.getElementById('printClientBlock').innerHTML=`<strong>Cliente:</strong> ${rec.client}<br><strong>Tel:</strong> ${rec.phone||'--'} ${cp?'<span style="float:right">COPIA</span>':''}`;
            if(config.logo) document.getElementById('printLogoDisplay').src=config.logo;
            const tb=document.getElementById('printBody'); tb.innerHTML="";
            if(rec.items){ rec.items.forEach(i=>{ tb.innerHTML+=`<tr><td>${i.qtyTxt}</td><td>${i.c} ${i.m}</td><td style="text-align:right">${config.currency}${i.total.toFixed(2)}</td></tr>`; }); }
            document.getElementById('printTotal').innerText=`${config.currency}${rec.total.toFixed(2)}`;
            setTimeout(()=>window.print(),500);
        }

        // UI Toast
        const Toast={ show:(m,t='s')=>{ const d=document.createElement('div'); d.className=`toast ${t}`; d.innerHTML=m; document.getElementById('toast-container').appendChild(d); setTimeout(()=>d.remove(),3000); }}

        // Click Outside Modal
        window.onclick = e => { if(e.target.className==='modal') e.target.style.display='none'; }
    </script>
</body>
</html>
