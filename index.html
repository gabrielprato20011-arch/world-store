<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>World Store V9.3 - Architect Secured</title>

    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;600;700;800&display=swap" rel="stylesheet">

   <style>
        :root {
            /* Colores Refinados */
            --primary: #D32F2F; 
            --primary-light: #FFEBEE;
            --dark: #1e1e2d;
            --dark-light: #2d2d44;
            --bg: #f3f5f9;
            --text-main: #3F4254;
            --text-muted: #B5B5C3;
            --white: #ffffff;

            --sidebar-width: 270px;
            --nav-height-mobile: 70px;
            --radius: 12px;
            --shadow-soft: 0 5px 20px rgba(0,0,0,0.03);
            --shadow-hover: 0 10px 25px rgba(0,0,0,0.06);
        }

        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }

        body { 
            margin: 0; 
            font-family: 'Montserrat', sans-serif; 
            background: var(--bg); 
            color: var(--text-main); 
            height: 100vh; height: 100dvh; 
            overflow: hidden; 
            display: flex; 
            overscroll-behavior: none; 
        }

        /* --- SIDEBAR --- */
        aside { 
            width: var(--sidebar-width); 
            background: var(--dark); 
            color: white; 
            display: flex; 
            flex-direction: column; 
            height: 100%; 
            z-index: 50; 
            box-shadow: 5px 0 20px rgba(0,0,0,0.05); 
            transition: 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
        }

        .brand { padding: 35px 20px; text-align: center; }
        #displayLogoSidebar { 
            width: 80px; height: 80px; 
            object-fit: contain; 
            border-radius: 50%; 
            margin: 0 auto 15px auto; 
            background: white; 
            border: 4px solid rgba(255,255,255,0.1); 
            display: none; 
            padding: 5px;
        }

        .brand h1 { margin: 0; font-size: 1.3rem; font-weight: 800; letter-spacing: 0.5px; text-transform: uppercase;}
        .brand small { color: rgba(255,255,255,0.5); font-weight: 500; font-size: 0.75rem; letter-spacing: 1px;}

        .nav-menu { flex: 1; padding: 20px 10px; overflow-y: auto; }

        .nav-item { 
            padding: 16px 20px; 
            cursor: pointer; 
            display: flex; 
            align-items: center; 
            gap: 15px; 
            color: #8c8c9e; 
            transition: all 0.2s; 
            font-size: 0.9rem; 
            border-radius: var(--radius);
            margin-bottom: 5px;
            font-weight: 500;
        }

        .nav-item i { font-size: 1.1rem; width: 25px; text-align: center; }

        .nav-item:hover { background: rgba(255,255,255,0.03); color: white; }

        .nav-item.active { 
            background: var(--primary); 
            color: white; 
            font-weight: 600; 
            box-shadow: 0 4px 15px rgba(211, 47, 47, 0.3);
        }

        .sys-info { padding: 20px; font-size: 0.7rem; text-align: center; color: rgba(255,255,255,0.3); border-top: 1px solid rgba(255,255,255,0.05); }

        /* --- MAIN AREA --- */
        main { flex: 1; position: relative; display: flex; flex-direction: column; overflow: hidden; width: 100%; height: 100%; }

        #globalBanner {
            display: none; background: #fff8e1; color: #8d6e16; text-align: center; 
            padding: 10px; font-weight: 700; font-size: 0.85rem; width: 100%; 
            border-bottom: 1px solid #ffeeba;
        }

        header { 
            height: 80px; background: rgba(255,255,255,0.9); 
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(0,0,0,0.05); 
            display: flex; align-items: center; justify-content: space-between; 
            padding: 0 30px; gap: 20px; flex-shrink: 0; z-index: 40;
        }

        .mobile-brand { display: none; align-items: center; gap: 10px; }
        .mobile-brand img { width: 40px; height: 40px; border-radius: 50%; object-fit: contain; background: white; box-shadow: 0 2px 5px rgba(0,0,0,0.1);}

        /* SEARCH BAR */
        .search-wrap { position: relative; flex: 1; max-width: 450px; }
        .search-wrap input { 
            width: 100%; padding: 12px 20px 12px 45px; 
            border-radius: 50px; border: 2px solid transparent; 
            background: #eef0f8; font-size: 0.9rem; font-weight: 500;
            color: var(--dark); transition: 0.2s;
        }
        .search-wrap input:focus { background: white; border-color: var(--primary); box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .search-wrap input::placeholder { color: #a1a5b7; }
        .search-wrap i { position: absolute; left: 18px; top: 50%; transform: translateY(-50%); color: #a1a5b7; }

        /* FILTERS */
        .filter-group { display: flex; gap: 8px; overflow-x: auto; scrollbar-width: none; align-items: center; }
        .chip { 
            padding: 8px 18px; border-radius: 50px; font-size: 0.8rem; font-weight: 600; cursor: pointer; 
            background: white; border: 1px solid #e1e3ea; color: #7e8299; transition:0.2s;
        }
        .chip:hover { border-color: var(--text-muted); }
        .chip.active { background: var(--dark); color: white; border-color: var(--dark); box-shadow: 0 4px 10px rgba(0,0,0,0.15); }

        /* --- VISTAS --- */
        .view-panel { padding: 25px 30px; flex: 1; overflow-y: auto; display: none; padding-bottom: 100px; }
        .view-panel.active { display: block; animation: fadeIn 0.4s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- GRID DE PRODUCTOS (Modern Card) --- */
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 20px; }
        .card { 
            background: white; border-radius: 16px; overflow: hidden; 
            border: none; box-shadow: var(--shadow-soft); cursor: pointer; 
            display: flex; flex-direction: column; height: 100%; position: relative;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .card:hover { transform: translateY(-5px); box-shadow: var(--shadow-hover); }

        .card-img-wrap { 
            height: 160px; background: #f9f9f9; display: flex; 
            justify-content: center; align-items: center; position: relative; overflow: hidden; 
        }
        .card-img-wrap img { width: 100%; height: 100%; object-fit: cover; transition: transform 0.4s;}
        .card:hover .card-img-wrap img { transform: scale(1.05); }

        .badge-cat { 
            position: absolute; top: 10px; right: 10px; padding: 4px 10px; 
            border-radius: 20px; color: white; font-size: 0.65rem; font-weight: 700; 
            text-transform: uppercase; box-shadow: 0 3px 8px rgba(0,0,0,0.15); 
            backdrop-filter: blur(4px); z-index: 2;
        }

        .card-content { padding: 15px; flex: 1; display: flex; flex-direction: column; justify-content: space-between; gap: 8px;}
        .card h4 { margin: 0; font-size: 0.95rem; color: var(--text-main); font-weight: 700; line-height: 1.3; }
        .card p { margin: 0; font-size: 0.8rem; color: #7e8299; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; }

        .card-footer { display: flex; justify-content: space-between; align-items: flex-end; margin-top: auto; padding-top: 10px; border-top: 1px dashed #eff2f5;}
        .price { color: var(--primary); font-weight: 800; font-size: 1.1rem; }
        .stock { 
            font-size: 0.65rem; background: #E8F5E9; color: #2E7D32; 
            padding: 4px 8px; border-radius: 6px; font-weight: 700; letter-spacing: 0.5px; 
        }

        /* --- TABLES (Clean Style) --- */
        .table-wrap { 
            background: white; 
            border-radius: 16px; 
            overflow-x: auto; 
            -webkit-overflow-scrolling: touch; 
            box-shadow: var(--shadow-soft); 
            border: 1px solid rgba(0,0,0,0.02);
            width: 100%; 
        }
        table { width: 100%; border-collapse: collapse; font-size: 0.9rem; min-width: 600px; }
        thead { background: #f9f9f9; color: var(--text-muted); text-transform: uppercase; font-size: 0.75rem; letter-spacing: 1px; font-weight: 700; }
        th { padding: 15px 20px; text-align: left; }
        td { padding: 15px 20px; border-bottom: 1px solid #f0f0f0; color: var(--text-main); font-weight: 500;}
        tr:last-child td { border-bottom: none; }
        tr:hover td { background: #fbfbfb; }

        .thumb { width: 45px; height: 45px; border-radius: 8px; object-fit: cover; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }

        /* --- BOTONES Y FORMULARIOS --- */
        .btn { padding: 12px 20px; border-radius: 10px; border:none; cursor: pointer; font-weight: 700; width: 100%; transition: all 0.2s; display: inline-flex; justify-content: center; align-items: center; gap: 8px; font-size: 0.9rem; letter-spacing: 0.3px;}
        .btn:hover { transform: translateY(-2px); filter: brightness(110%); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .btn:active { transform: scale(0.97); }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; box-shadow: none; }

        .btn-primary { background: linear-gradient(145deg, var(--dark), #2c2c3e); color: white; }
        .btn-success { background: linear-gradient(145deg, #2E7D32, #43A047); color: white; box-shadow: 0 5px 15px rgba(46, 125, 50, 0.3); }
        .btn-danger { background: linear-gradient(145deg, #C62828, #E53935); color: white; box-shadow: 0 5px 15px rgba(198, 40, 40, 0.3);}
        .btn-blue { background: linear-gradient(145deg, #1565C0, #1E88E5); color: white; }

        input, select { 
            width: 100%; padding: 12px 15px; border: 1px solid #e1e3ea; border-radius: 10px; 
            font-size: 0.9rem; color: var(--text-main); background: #fff; transition: 0.2s;
            font-family: 'Montserrat', sans-serif;
        }
        input:focus, select:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(198, 40, 40, 0.1); }

        /* --- CART & MODALS --- */
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 900; display: none; backdrop-filter: blur(4px); opacity: 0; transition: opacity 0.3s;}
        .overlay.active { display: block; opacity: 1; }

        .cart-drawer { 
            position: fixed; top: 0; right: -500px; width: 450px; height: 100%; 
            background: white; z-index: 1100; transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1); 
            display: flex; flex-direction: column; box-shadow: -10px 0 40px rgba(0,0,0,0.15); 
        }
        .cart-drawer.open { transform: translateX(-500px); }

        .cart-items { flex: 1; overflow-y: auto; padding: 20px; }
        .c-item { 
            display: flex; gap: 15px; padding: 15px; border: 1px solid #f0f0f0; 
            border-radius: 12px; margin-bottom: 12px; align-items: center; background: white; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.02);
        }

        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 2000; display: none; align-items: center; justify-content: center; padding: 20px; backdrop-filter: blur(4px); }
        .modal-box { 
            background: white; width: 500px; max-width: 100%; padding: 30px; 
            border-radius: 20px; position: relative; max-height: 90vh; overflow-y: auto; 
            box-shadow: 0 20px 60px rgba(0,0,0,0.3); animation: zoomIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); 
        }
        @keyframes zoomIn { from { transform: scale(0.9); opacity: 0; } to { opacity: 1; transform: scale(1); } }

        /* UPLOADERS & CONFIG */
        .file-upload { border: 2px dashed #d1d4db; padding: 30px; text-align: center; border-radius: 16px; cursor: pointer; margin-top: 15px; background: #fafafa; transition:0.2s; position:relative; }
        .file-upload:hover { border-color: var(--primary); background: var(--primary-light); }

        .config-card { background: white; padding: 25px; border-radius: 16px; box-shadow: var(--shadow-soft); margin-bottom: 20px; }
        .section-title { font-weight: 800; color: var(--dark); border-bottom: 1px solid #f0f0f0; padding-bottom: 10px; margin-bottom: 20px; font-size: 1rem; text-transform: uppercase; letter-spacing: 0.5px;}

        #loader { position: fixed; top:0; left:0; width:100%; height:100%; background:white; z-index:9999; display:flex; justify-content:center; align-items:center; flex-direction:column; }
        .spinner { width:50px; height:50px; border:5px solid #f3f3f3; border-top-color:var(--primary); border-radius:50%; animation:spin 1s cubic-bezier(0.55, 0.055, 0.675, 0.19) infinite; }
        
        .toast { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); background: #333; color: white; padding: 12px 24px; border-radius: 50px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); font-size: 0.9rem; z-index: 10000; animation: fadeUp 0.3s ease; display:flex; align-items:center; gap:10px; }
        .toast.success { background: #2E7D32; }
        .toast.error { background: #c62828; }
        @keyframes fadeUp { from { opacity:0; transform: translate(-50%, 20px); } to { opacity:1; transform: translate(-50%, 0); } }

        /* MOBILE TWEAKS */
        @media (max-width: 768px) {
            body { flex-direction: column; }
            aside { position: fixed; bottom: 0; left: 0; width: 100%; height: var(--nav-height-mobile); flex-direction: row; justify-content: space-around; padding: 0 10px; background: white; border-top: 1px solid #f0f0f0; z-index: 1000; box-shadow: 0 -5px 20px rgba(0,0,0,0.05); }
            .brand, .sys-info { display: none; }
            .nav-menu { display: flex; flex-direction: row; width: 100%; padding: 0; justify-content: space-between; align-items: center; }
            .nav-item { flex-direction: column; justify-content: center; padding: 8px 5px; flex: 1; border-radius: 10px; margin: 0; background: transparent; gap: 5px; font-size: 0.7rem; color: #999; }
            .nav-item i { font-size: 1.2rem; margin-bottom: 0; }
            .nav-item.active { background: var(--primary-light); color: var(--primary); box-shadow: none;}

            main { height: calc(100vh - var(--nav-height-mobile)); }
            header { padding: 10px 15px; height: auto; flex-wrap: wrap; gap: 10px; }
            .mobile-brand { display: flex; }
            .search-wrap { width: 100%; max-width: none; order: 3; }
            .filter-group { width: 100%; order: 4; padding-bottom: 5px; }
            .grid { grid-template-columns: 1fr 1fr; gap: 15px; padding: 5px;}
            .cart-drawer { width: 100%; right: -100%; }
            .cart-drawer.open { transform: translateX(-100%); }
        }

        @keyframes spin { 100% { transform:rotate(360deg); } }
        #print-layer { display: none; }

        @media print { 
            body > *:not(#print-layer) { display: none !important; } 
            #print-layer { display: block !important; position: absolute; top: 0; left: 0; width: 100%; z-index: 99999; background: white; min-height: 100vh;} 
            @page { margin: 5mm; } 
        }

    </style>
</head>

<body>
    <!-- LOGIN OVERLAY -->
    <div id="loginOverlay" style="position:fixed; top:0; left:0; width:100%; height:100%; background:var(--dark); z-index:10000; display:flex; flex-direction:column; align-items:center; justify-content:center; color:white;">
        <div style="background:white; padding:5px; border-radius:50%; margin-bottom:20px;">
            <img id="loginLogo" src="https://placehold.co/100?text=WS" style="width:90px; height:90px; border-radius:50%; object-fit:contain; border:2px solid #eee;">
        </div>
        <h2 style="margin:0 0 5px 0; text-transform:uppercase; letter-spacing:2px; text-align:center;">Acceso Restringido</h2>
        <p style="color:#aaa; margin-bottom:30px; font-size:0.9rem;">Sistema Privado World Store (Sincronizado)</p>
        
        <div style="background:white; padding:30px; border-radius:16px; width:320px; max-width:90%; color:#333; text-align:center; box-shadow:0 10px 40px rgba(0,0,0,0.5);">
            <input type="email" id="txtEmail" placeholder="Correo Administrativo" style="margin-bottom:15px; border:1px solid #ddd; background:#f9f9f9; width:100%; padding:12px; border-radius:8px;">
            <input type="password" id="txtPass" placeholder="Contrase√±a" style="margin-bottom:20px; border:1px solid #ddd; background:#f9f9f9; width:100%; padding:12px; border-radius:8px;">
            <button class="btn btn-primary" onclick="appLogin()" id="btnLogin" style="width:100%; font-size:1rem;">INGRESAR</button>
            <p id="loginError" style="color:#d32f2f; font-size:0.8rem; margin-top:15px; display:none; font-weight:bold;"></p>
        </div>
    </div>

    <div id="loader">
        <div class="spinner"></div>
        <p style="margin-top:15px; color:#555; font-weight:bold;">Conectando a la Nube...</p>
    </div>
    <div id="toast-container"></div>
    <div class="overlay" id="mainOverlay" onclick="toggleCart()"></div>

    <!-- SIDEBAR -->
    <aside>
        <div class="brand">
            <img id="displayLogoSidebar" src="" alt="Logo">
            <h1 id="brandName">WORLD STORE</h1>
            <small id="brandSubSidebar">Gesti√≥n en la Nube</small>
        </div>
        <div class="nav-menu">
            <div class="nav-item active" onclick="nav('pos', this)"><i class="fa-solid fa-store"></i> <span>Cat√°logo</span></div>
            <div class="nav-item" onclick="nav('history', this)"><i class="fa-solid fa-receipt"></i> <span>Ventas</span></div>
            <div class="nav-item" onclick="nav('profit', this)"><i class="fa-solid fa-chart-line"></i> <span>Ganancias</span></div>
            <div class="nav-item" onclick="nav('inv', this)"><i class="fa-solid fa-boxes-stacked"></i> <span>Inventario</span></div>
            <div class="nav-item" onclick="toggleCart()"><i class="fa-solid fa-cart-shopping"></i> <span>Carrito <b id="cartCountBadge" style="background:var(--primary); color:white; padding:1px 6px; border-radius:10px; font-size:0.7em;">0</b></span></div>
            <div class="nav-item" onclick="nav('config', this)"><i class="fa-solid fa-sliders"></i> <span>Configuraci√≥n</span></div>
        </div>
        <div class="sys-info"><span id="footerBrand">SISTEMA v9.3</span></div>
    </aside>

    <main>
        <div id="globalBanner"></div>
        <header>
            <div class="mobile-brand">
                <img id="mobileLogoImg" src="" style="display:none;">
                <h2 id="mobileTitleTxt">WORLD STORE</h2>
            </div>
            <div class="search-wrap">
                <i class="fa-solid fa-magnifying-glass"></i>
                <input type="text" id="searchInput" placeholder="Buscar modelo, c√≥digo..." onkeyup="searchDelay()">
            </div>
            <div class="filter-group">
                <div class="chip active" onclick="filterCat('all', this)">Todo</div>
                <div class="chip" onclick="filterCat('Ni√±o/Ni√±a', this)">Infantil</div>
                <div class="chip" onclick="filterCat('Dama', this)">Dama</div>
                <div class="chip" onclick="filterCat('Caballero', this)">Caballero</div>
            </div>
        </header>

        <!-- POS (Catalogo) -->
        <div id="view-pos" class="view-panel active">
            <div class="grid" id="posGrid"></div>
        </div>

        <!-- HISTORY -->
        <div id="view-history" class="view-panel">
            <div style="background:white; padding:20px; border-radius:12px; margin-bottom:20px; box-shadow:0 2px 10px rgba(0,0,0,0.05); display:flex; justify-content:space-between;">
                <div><h3 style="margin:0">Registro de Ventas</h3><small>Mostrando √∫ltimas 100 operaciones</small></div>
                <!-- Nota: Total solo de lo que se ve en pantalla para ahorrar procesamiento -->
            </div>
            <div class="table-wrap">
                <table>
                    <thead><tr><th>Fecha</th><th>Cliente</th><th>Detalle</th><th>Total</th><th></th></tr></thead>
                    <tbody id="histBody"></tbody>
                </table>
            </div>
            <p style="text-align:center;font-size:0.8rem;color:#888;margin-top:10px;">El historial antiguo se mantiene seguro en la base de datos pero se oculta para optimizar velocidad.</p>
        </div>

        <!-- INVENTORY -->
        <div id="view-inv" class="view-panel">
            <div style="display:flex; justify-content:space-between; margin-bottom:20px; align-items:center;">
                <h3>Inventario de Productos</h3>
                <button class="btn btn-success" style="width:auto;" onclick="openModalProd()">+ Nuevo Producto</button>
            </div>
            <div class="table-wrap">
                <table>
                    <thead><tr><th>Img</th><th>C√≥digo / Modelo</th><th>Precio (Docena)</th><th>Stock</th><th></th></tr></thead>
                    <tbody id="invBody"></tbody>
                </table>
            </div>
        </div>

        <!-- CONFIG -->
        <div id="view-config" class="view-panel">
            <div class="settings-header"><i class="fa-solid fa-sliders"></i> Personalizaci√≥n del Sistema</div>
            <div class="config-card">
                <div class="section-title">Identidad Visual</div>
                <div class="form-row">
                    <label>Logo de la Empresa (Esquina Superior Izquierda)</label>
                    <div style="border:1px solid #ddd; padding:15px; border-radius:8px; display:flex; align-items:center; gap:15px; background:#f9f9f9;">
                        <img id="cfgLogoPreview" src="https://placehold.co/100x100?text=LOGO" style="width:60px; height:60px; object-fit:contain; background:white; border-radius:50%; border:2px solid #eee; box-shadow:0 2px 5px rgba(0,0,0,0.1);">
                        <div style="flex:1;">
                            <input type="file" accept="image/*" id="logoUploader" style="display:none" onchange="compressAndPreview(this.files[0], 'cfgLogoPreview', 'cfgLogoData')">
                            <button class="btn btn-blue" style="width:auto; padding:8px 15px;" onclick="document.getElementById('logoUploader').click()">
                                <i class="fa-solid fa-cloud-arrow-up"></i> Cambiar Logo
                            </button>
                            <input type="hidden" id="cfgLogoData">
                        </div>
                    </div>
                </div>

                <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px;">
                    <div class="form-row"><label>Nombre Empresa</label><input type="text" id="cfgName" placeholder="WORLD STORE"></div>
                    <div class="form-row"><label>Subt√≠tulo</label><input type="text" id="cfgSub" placeholder="Mayoristas..."></div>
                </div>
                <div class="form-row"><label>Color Tema</label><input type="color" id="cfgColor" style="height:45px;width:100%;padding:2px;cursor:pointer;" oninput="previewColor(this.value)"></div>
            </div>

            <div class="config-card">
                <div class="section-title">Operaciones</div>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px;">
                    <div class="form-row"><label>Tel√©fono Contacto</label><input type="tel" id="cfgTel"></div>
                    <div class="form-row"><label>S√≠mbolo Moneda</label><input type="text" id="cfgCurrency"></div>
                </div>
                <div class="form-row"><label>Mensaje Pie Factura</label><input type="text" id="cfgFooter"></div>
                <div class="form-row"><label>Anuncio Global</label><input type="text" id="cfgBanner"></div>
                
                <label class="checkbox-wrap" style="display:flex;align-items:center;gap:10px;margin-top:15px;">
                    <input type="checkbox" id="cfgMaintenance" style="width:20px;">
                    <span>Activar Modo "Mantenimiento" (Oculta cat√°logo)</span>
                </label>
            </div>

            <button class="btn btn-primary" style="padding:15px; font-size:1.1rem;" onclick="window.saveConfig()"><i class="fa-solid fa-floppy-disk"></i> GUARDAR CAMBIOS</button>

             <br><br>
            <div style="border-top:1px solid #eee; padding-top:20px; text-align:center;">
                <p style="color:#666;font-size:0.8rem;">Zona de Riesgo</p>
                <button class="btn btn-blue" style="background:#607D8B; max-width:300px;" onclick="window.reloadInitialData()"><i class="fa-solid fa-database"></i> Reiniciar Base de Datos (Reset Stock)</button>
            </div>
        </div>

        <!-- PROFIT -->
        <div id="view-profit" class="view-panel">
            <div style="background:white; padding:20px; border-radius:16px; margin-bottom:20px; box-shadow:var(--shadow-soft); display:flex; justify-content:space-between; align-items:center;">
                <div><h3 style="margin:0; color:var(--dark);">Reporte de Ganancias</h3><small>Basado en tabla de utilidades</small></div>
                <div style="text-align:right;"><div style="font-size:0.8rem;color:#777">Total en vista</div><div style="font-size:1.8rem;font-weight:800;color:#2E7D32" id="totalProfitDisplay">$0.00</div></div>
            </div>
            <div class="table-wrap">
                <table>
                    <thead><tr><th>Fecha</th><th>Venta / Cliente</th><th>Items</th><th style="text-align:right">Total Venta</th><th style="text-align:right; color:#2E7D32">Utilidad</th></tr></thead>
                    <tbody id="profitBody"></tbody>
                </table>
            </div>
        </div>
    </main>

    <!-- DRAWER & MODALS -->
    <div id="cartDrawer" class="cart-drawer">
        <div style="padding:15px; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center;">
            <h3 style="margin:0">üõí Pedido Actual</h3>
            <button onclick="toggleCart()" style="background:none; border:none; font-size:1.5rem; padding:10px;">&times;</button>
        </div>
        <div class="cart-items" id="cartContainer"></div>
        <div class="cart-total-bar" style="padding:20px; border-top:1px solid #eee;">
            <input type="text" id="cartClientName" placeholder="Nombre Cliente *" style="margin-bottom:10px;">
            <input type="tel" id="cartClientPhone" placeholder="Tel√©fono" inputmode="tel" style="margin-bottom:15px;">
            <div style="display:flex; justify-content:space-between; margin-bottom:15px; font-size:1.2rem; font-weight:bold;"><span>Total</span><span id="cartTotalDisplay" style="color:var(--primary)">$0.00</span></div>
            <button class="btn btn-success" id="btnProcessSale" onclick="window.processSale()" style="padding:15px;font-size:1.1rem;width:100%;">CONFIRMAR VENTA</button>
        </div>
    </div>

    <div id="modalSale" class="modal">
        <div class="modal-box">
            <h3 id="saleTitle" style="margin-top:0;">Producto</h3>
            <input type="hidden" id="saleId">
            <div style="background:#f9f9f9; padding:15px; border-radius:8px; margin:10px 0; text-align:center;">
                <label style="display:block;margin-bottom:5px;font-weight:bold;font-size:0.8rem;">Cantidad por:</label>
                <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:5px;">
                    <button class="btn" style="font-size:0.75rem; padding:8px 2px;" id="btn-doc" onclick="setSaleType('doc')">DOCENA</button>
                    <button class="btn" style="font-size:0.75rem; padding:8px 2px; background:#eee;" id="btn-half" onclick="setSaleType('half')">MEDIA</button>
                    <button class="btn" style="font-size:0.75rem; padding:8px 2px; background:#eee;" id="btn-unit" onclick="setSaleType('unit')">PAR</button>
                </div>
                <div id="unitPriceDisplay" style="margin-top:10px; font-weight:600; color:#555;"></div>
            </div>
            <div style="display:flex; gap:10px; margin-bottom:20px; align-items:center;">
                <button class="btn" style="background:#eee; font-size:1.5rem; width:60px;" onclick="adjQty(-1)">-</button>
                <input type="number" id="saleQty" value="1" min="1" style="flex:1; text-align:center; padding:12px; font-size:1.3rem; border:1px solid #ddd; border-radius:8px; font-weight:bold;" onchange="updateCalc()">
                <button class="btn" style="background:#eee; font-size:1.5rem; width:60px;" onclick="adjQty(1)">+</button>
            </div>
            <div style="text-align:right; font-size:2rem; font-weight:800; color:var(--primary); margin-bottom:20px;"><span id="saleTotalCalc">$0.00</span></div>
            <div style="display:flex; gap:10px;">
                <button class="btn" style="background:#eee; flex:1;" onclick="closeModal('modalSale')">Cancelar</button>
                <button class="btn btn-success" style="flex:2;" onclick="confirmAdd()">AGREGAR</button>
            </div>
        </div>
    </div>

    <div id="modalProd" class="modal">
        <div class="modal-box">
            <h3 id="modalProdTitle" style="margin-top:0;">Gesti√≥n de Producto</h3>
            <input type="hidden" id="prodId"><input type="hidden" id="prodImgBase64">
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                <div style="grid-column:span 2"><label>Nombre / Modelo</label><input type="text" id="pModel"></div>
                <div><label>C√≥digo</label><input type="text" id="pCode"></div>
                <div><label>Categor√≠a</label><select id="pCat"><option>Dama</option><option>Caballero</option><option>Ni√±o/Ni√±a</option></select></div>
                <div><label>Precio Docena</label><input type="number" id="pPrice" inputmode="decimal"></div>
                <div><label>Stock (Total Pares)</label><input type="number" id="pStock" inputmode="numeric"></div>
                <div style="grid-column:span 2"><label>Tallas</label><input type="text" id="pSize"></div>
            </div>
            <div class="file-upload" id="dropZone" onclick="document.getElementById('fileInput').click()">
                <span style="color:#aaa;"><i class="fa-solid fa-camera"></i> Subir foto</span>
                <img id="imgPreview" style="display:none; max-width:100%; height:150px; object-fit:contain; margin-top:10px;">
                <input type="file" id="fileInput" accept="image/*" style="display:none" onchange="compressAndPreview(this.files[0], 'imgPreview', 'prodImgBase64')">
            </div>
            <div style="margin-top:20px; display:flex; gap:10px;">
                <button class="btn btn-danger" onclick="closeModal('modalProd')">Cancelar</button>
                <button class="btn btn-success" onclick="window.saveProduct()">GUARDAR</button>
            </div>
        </div>
    </div>

    <!-- PRINT LAYOUT -->
    <div id="print-layer">
        <div style="width:100%;max-width:800px;margin:0 auto;color:black;font-family:sans-serif;font-size:14px;">
            <div style="border-bottom:2px solid #000;padding-bottom:10px;margin-bottom:15px;display:flex;justify-content:space-between; align-items:center;">
                <div style="display:flex; align-items:center; gap:15px;">
                    <img id="printLogoDisplay" style="height:70px;width:70px;object-fit:contain;display:none;">
                    <div>
                        <h1 id="printBrand" style="margin:0;font-size:22px;text-transform:uppercase;"></h1>
                        <div id="printSub" style="font-weight:bold; color:#555;"></div>
                        <div id="printTel" style="font-size:12px;"></div>
                    </div>
                </div>
                <div style="text-align:right;"><h2 style="color:black;margin:0;">NOTA DE ENTREGA</h2><div style="margin-top:5px;">Fecha: <span id="printDate"></span></div></div>
            </div>
            <div id="printClientBlock" style="border:1px solid #ccc; padding:10px; margin-bottom:20px; border-radius:4px; background:#f9f9f9;"></div>
            <table style="width:100%;border-collapse:collapse;margin-bottom:20px;"><thead><tr style="background:#eee;font-weight:bold;text-transform:uppercase;font-size:12px;"><th style="padding:8px;text-align:left;">Cant.</th><th style="padding:8px;text-align:left;">Descripci√≥n</th><th style="padding:8px;text-align:right;">Subtotal</th></tr></thead><tbody id="printBody"></tbody></table>
            <div style="text-align:right;font-size:20px;font-weight:bold;border-top:2px solid #000;padding-top:10px;">TOTAL A PAGAR: <span id="printTotal"></span></div>
            <div id="printFooter" style="text-align:center;font-size:12px;margin-top:40px;color:#555;font-style:italic;"></div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>

<script>
    // --- 1. CONFIGURACI√ìN FIREBASE ---
    const firebaseConfig = {
        apiKey: "AIzaSyB5ygJIoEgpJPKY0qMULocohmzXGc7UWFE",
        authDomain: "worldstoresystem.firebaseapp.com",
        databaseURL: "https://worldstoresystem-default-rtdb.firebaseio.com",
        projectId: "worldstoresystem",
        storageBucket: "worldstoresystem.firebasestorage.app",
        messagingSenderId: "460628958914",
        appId: "1:460628958914:web:95da76852bedecbdcf255b"
    };
    try { firebase.initializeApp(firebaseConfig); } catch(e) { console.error("Error init firebase", e); }
    
    const dbRef = firebase.database();
    const auth = firebase.auth();

    // --- 2. VARIABLES GLOBALES ---
    let db = [], history = [];
    let config = {
        name: "WORLD STORE", 
        sub: "Gesti√≥n Segura", 
        color: "#D32F2F", 
        currency: "$", 
        tel: "0424-7125937", 
        footer: "Gracias por su compra"
    };
    let cart = [], curFilter = 'all', saleItem = null, saleMode = 'doc';
    
    // TABLA GANANCIAS POR DEFECTO
    const PROFIT_DB_LOCAL = { "HY 001": 5.5, "HY 002-1": 5.5, "HY 002-3": 5.5, "LC C-04": 6.5 }; 
    let PROFIT_DB = PROFIT_DB_LOCAL;

    // --- 3. AUTENTICACI√ìN Y ARRANQUE ---
    auth.onAuthStateChanged(user => {
        if (user) {
            document.getElementById('loginOverlay').style.display = 'none';
            startSystem(); 
            Toast.show("Sistema Conectado y Seguro");
        } else {
            document.getElementById('loginOverlay').style.display = 'flex';
            const savedLogo = localStorage.getItem('localLogo');
            if(savedLogo) {
                document.getElementById('loginLogo').src = savedLogo;
                document.getElementById('loginLogo').style.display = 'block';
            }
        }
    });

    window.appLogin = function() {
        const e = document.getElementById('txtEmail').value;
        const p = document.getElementById('txtPass').value;
        const btn = document.getElementById('btnLogin');
        const err = document.getElementById('loginError');

        if(!e || !p) { err.innerText = "Faltan datos."; err.style.display = 'block'; return; }
        btn.innerText = "Verificando..."; btn.disabled = true; err.style.display = 'none';

        auth.signInWithEmailAndPassword(e, p).catch(error => {
            btn.innerText = "INGRESAR"; btn.disabled = false;
            let msg = "Error de acceso.";
            if(error.code === 'auth/wrong-password') msg = "Contrase√±a inv√°lida.";
            if(error.code === 'auth/user-not-found') msg = "Usuario no existe.";
            err.innerText = msg; err.style.display = 'block';
        });
    }

    // --- 4. CORE: GESTI√ìN DE DATOS ---
    function startSystem() {
        // A. Config
        dbRef.ref('config').on('value', s => { 
            if(s.val()){ 
                config = s.val(); 
                applyConfig(); 
                if(config.logo) localStorage.setItem('localLogo', config.logo);
            } else { saveConfig(); } 
        });

        // B. Inventario
        dbRef.ref('inventory').once('value').then(s => {
            db = s.val() || [];
            window.updateAllViews();
            document.getElementById('loader').style.display = 'none';

            dbRef.ref('inventory').on('child_changed', snap => {
                const idx = snap.key;
                if(db[idx]) { db[idx] = snap.val(); window.updateAllViews(); }
            });

            dbRef.ref('inventory').on('child_added', snap => {
                const val = snap.val();
                if(!db.find(x => x.id === val.id)) { db.push(val); window.updateAllViews(); }
            });

            dbRef.ref('inventory').on('child_removed', snap => {
                const val = snap.val();
                db = db.filter(x => x.id !== val.id);
                window.updateAllViews();
            });
        });

        // C. Historial COMPLETO (Corregido: Se quit√≥ el limitToLast para traer todo)
        dbRef.ref('history').on('value', s => { 
            history = s.val() ? Object.values(s.val()).sort((a,b) => b.id - a.id) : []; 
            renderHistory();
            if(document.getElementById('view-profit').classList.contains('active')) renderProfit();
        });
    }

    // --- 5. RENDERIZADO Y UI ---
    let searchTimer;
    window.searchDelay = function() {
        clearTimeout(searchTimer);
        searchTimer = setTimeout(() => { window.updateAllViews(); }, 300);
    }

    window.updateAllViews = function() {
        renderPOS();
        renderInv();
    }

    function renderPOS(){
        if(config.maintenance){ 
            document.getElementById('posGrid').innerHTML=`<div style="grid-column:1/-1;text-align:center;padding:50px;"><i class="fa-solid fa-store-slash" style="font-size:3rem;color:#ccc;"></i><h3>En Mantenimiento</h3></div>`; return;
        }

        const g = document.getElementById('posGrid'); 
        const txt = document.getElementById('searchInput').value.toLowerCase();
        
        const list = db.filter(p => (p.c.toLowerCase().includes(txt)||p.m.toLowerCase().includes(txt)) && (curFilter==='all'||p.cat===curFilter));
        list.sort((a, b) => a.cat.localeCompare(b.cat));

        if(list.length === 0){ g.innerHTML = `<p style="grid-column:1/-1;text-align:center;color:#999;margin-top:20px;">Sin resultados.</p>`; return; }

        let html = "";
        list.forEach(p => {
            const bg = p.cat === 'Dama' ? '#E91E63' : (p.cat === 'Caballero' ? '#546E7A' : '#FF9800');
            html += `
            <div class="card" onclick="openSale(${p.id})">
                <div class="card-img-wrap">
                    <img src="${p.img||'https://placehold.co/300?text=' + p.c}" loading="lazy">
                    <span class="badge-cat" style="background:${bg}">${p.cat.substring(0,3)}</span>
                </div>
                <div class="card-content">
                    <div><h4>${p.c}</h4><p>${p.m}</p></div>
                    <div class="card-footer">
                        <span class="stock" style="background:${p.stock < 12 ? '#ffcdd2' : '#E8F5E9'}; color:${p.stock < 12 ? '#c62828' : '#2E7D32'}">
                            ${p.stock < 12 ? 'Bajo Stock:' : 'Stock:'} ${p.stock}
                        </span>
                        <span class="price">${config.currency}${p.d} <small>/doc</small></span>
                    </div>
                </div>
            </div>`;
        });
        g.innerHTML = html;
    }

    function renderInv(){ 
        const t = document.getElementById('invBody'); t.innerHTML="";
        const txt = document.getElementById('searchInput').value.toLowerCase();
        const list = db.filter(p => (p.c.toLowerCase().includes(txt) || p.m.toLowerCase().includes(txt)) && (curFilter === 'all' || p.cat === curFilter));

        list.forEach(p => { 
            t.innerHTML += `<tr>
                <td><img src="${p.img || 'https://placehold.co/50'}" class="thumb"></td>
                <td><b>${p.c}</b> <small>(${p.cat})</small><br>${p.m}</td>
                <td>${config.currency}${p.d}</td>
                <td><b>${p.stock}</b></td>
                <td>
                    <button class="btn" style="background:#eee;color:#333;width:auto;padding:5px;" onclick="openEdit(${p.id})"><i class="fa-solid fa-pen"></i></button>
                    <button class="btn" style="background:var(--primary);color:white;width:auto;padding:5px;" onclick="delProd(${p.id})"><i class="fa-solid fa-trash"></i></button>
                </td>
            </tr>`
        });
    }

    // --- 6. PROCESAMIENTO DE VENTAS ---
    window.openSale = function(id){ 
        saleItem = db.find(x => x.id == id); 
        if(!saleItem) return;
        document.getElementById('saleTitle').innerText = `${saleItem.c} - ${saleItem.m}`; 
        document.getElementById('saleId').value = id; 
        document.getElementById('saleQty').value = 1; 
        window.setSaleType('doc'); 
        document.getElementById('modalSale').style.display = 'flex'; 
    }

    window.setSaleType = function(t){ 
        saleMode = t; 
        ['doc','half','unit'].forEach(x => {
            const el = document.getElementById('btn-'+x);
            el.style.background = x === t ? config.color : '#eee';
            el.style.color = x === t ? 'white' : '#333';
        }); 
        updateCalc(); 
    }

    window.updateCalc = function(){ 
        const q = parseInt(document.getElementById('saleQty').value)||1; 
        let p = 0;
        if(saleMode === 'doc') p = saleItem.d; 
        else if(saleMode === 'half') p = saleItem.d / 2; 
        else p = saleItem.d / 12; 

        document.getElementById('unitPriceDisplay').innerText = `Unitario: ${config.currency}${p.toFixed(2)}`; 
        document.getElementById('saleTotalCalc').innerText = `${config.currency}${(p*q).toFixed(2)}`; 
    }

    window.adjQty = (n) => { let v = parseInt(document.getElementById('saleQty').value)+n; if(v<1)v=1; document.getElementById('saleQty').value = v; updateCalc(); }

    window.confirmAdd = function() {
        const q = parseInt(document.getElementById('saleQty').value);
        let deduct = (saleMode === 'doc' ? 12 : (saleMode === 'half' ? 6 : 1)) * q;

        const inCart = cart.filter(i => i.pId === saleItem.id).reduce((s, i) => s + i.deduct, 0);
        if((deduct + inCart) > saleItem.stock) { return alert("‚ö†Ô∏è Stock insuficiente en local."); }

        const t = parseFloat(document.getElementById('saleTotalCalc').innerText.replace(/[^0-9.]/g, ''));
        const typeLabel = saleMode === 'doc' ? 'Doc' : (saleMode === 'half' ? 'Med' : 'Par');

        cart.push({ pId: saleItem.id, c: saleItem.c, m: saleItem.m, qtyTxt: `${q} ${typeLabel}`, total: t, deduct: deduct });
        
        closeModal('modalSale');
        renderCart(); toggleCart();
        Toast.show("Agregado al pedido");
    }

    window.processSale = function() {
        if(cart.length === 0) return alert("Carrito vac√≠o");
        const nm = document.getElementById('cartClientName').value.trim();
        if(!nm) return alert("Falta nombre del cliente");
        
        const btn = document.getElementById('btnProcessSale');
        btn.innerText = "Validando Stock..."; btn.disabled = true;

        const invRef = dbRef.ref('inventory');

        invRef.transaction((currInv) => {
            if(!currInv) return currInv;

            for(let item of cart) {
                const idx = currInv.findIndex(p => p.id === item.pId);
                if(idx === -1) throw "Prod no encontrado (borrado?)"; 
                
                const prod = currInv[idx];
                if(prod.stock < item.deduct) throw `Stock insuficiente: ${prod.c}`;

                prod.stock -= item.deduct;
                currInv[idx] = prod;
            }
            return currInv;
        }, (err, committed, snap) => {
            btn.disabled = false; btn.innerText = "CONFIRMAR VENTA";
            
            if(err) {
                console.error(err);
                alert("‚ùå ERROR: " + err.message || err);
            } else if(committed) {
                let totalVenta = 0, descStr = "";
                cart.forEach(i => { totalVenta += i.total; descStr += `${i.qtyTxt} ${i.c}, `; });

                const rec = {
                    id: Date.now(),
                    date: new Date().toLocaleString(),
                    client: nm,
                    phone: document.getElementById('cartClientPhone').value,
                    total: totalVenta,
                    items: cart,
                    desc: descStr
                };

                dbRef.ref('history').push(rec);
                printFromData(rec);
                cart = []; document.getElementById('cartClientName').value = "";
                renderCart(); toggleCart();
                Toast.show("Venta Exitosa", "success");
            }
        });
    }

    function renderCart(){ 
        const c = document.getElementById('cartContainer'); c.innerHTML=""; let t=0;
        if(cart.length==0) c.innerHTML="<div style='text-align:center;color:#999;padding:20px;'>Vac√≠o</div>"; 
        cart.forEach((i,x)=>{
            t+=i.total;
            c.innerHTML+=`<div class="c-item">
                <div style="flex:1"><b>${i.c}</b><br><small>${i.qtyTxt}</small></div>
                <div style="text-align:right"><b>${config.currency}${i.total.toFixed(2)}</b><br>
                <small style="color:#d32f2f;cursor:pointer" onclick="cart.splice(${x},1);renderCart()">Eliminar</small></div>
            </div>`
        });
        document.getElementById('cartTotalDisplay').innerText=`${config.currency}${t.toFixed(2)}`;
        document.getElementById('cartCountBadge').innerText=cart.length;
    }

    // --- 7. HISTORIAL & PROFIT (TOTALES) ---
    function renderHistory() {
        const t = document.getElementById('histBody'); t.innerHTML = "";
        const c = config.currency;
        
        history.forEach(h => {
            t.innerHTML += `
            <tr>
                <td><small>${h.date.split(',')[0]}</small></td>
                <td><b>${h.client}</b></td>
                <td><button class="btn" style="padding:2px 8px; font-size:0.7rem; background:#f0f0f0; color:#555; width:auto; height:auto;" onclick="alert('${h.desc}')">Ver</button></td>
                <td><b>${c}${parseFloat(h.total).toFixed(2)}</b></td>
                <td>
                    <i class="fa-solid fa-print" style="color:#1976D2;margin-right:10px;cursor:pointer" onclick="reprint(${h.id})"></i> 
                    <i class="fa-solid fa-rotate-left" style="color:#d32f2f;cursor:pointer" onclick="delHist(${h.id})" title="Devolver Venta"></i>
                </td>
            </tr>`;
        });
    }

    window.delHist = function(id) {
        if(!confirm("‚ö†Ô∏è ¬øANULAR VENTA?\nEl stock regresar√° autom√°ticamente al inventario.")) return;

        dbRef.ref('history').once('value').then(snap => {
            const hData = snap.val();
            let key = null, sale = null;
            for(let k in hData) { if(hData[k].id === id) { key=k; sale=hData[k]; break; }}
            
            if(!sale) return alert("Venta no encontrada");

            dbRef.ref('inventory').transaction(currInv => {
                if(!currInv) return currInv;
                sale.items.forEach(soldItem => {
                    const idx = currInv.findIndex(p => p.id === soldItem.pId);
                    if(idx !== -1) {
                        currInv[idx].stock = parseInt(currInv[idx].stock) + parseInt(soldItem.deduct);
                    }
                });
                return currInv;
            }, (err, committed) => {
                if(committed) {
                    dbRef.ref('history/' + key).remove();
                    Toast.show("Venta Anulada", "success");
                } else {
                    alert("Error devolviendo stock: " + err);
                }
            });
        });
    }

    function renderProfit() {
        // C√°lculo Total Basado en Historial Completo
        const t = document.getElementById('profitBody'); t.innerHTML = "";
        let gT = 0; const c = config.currency;

        history.forEach(h => {
            let saleProfit = 0;
            h.items.forEach(item => {
                let code = item.c.trim();
                let profitPerDozen = PROFIT_DB[code] || 5.5; 
                let itemProfit = (profitPerDozen / 12) * item.deduct; 
                saleProfit += itemProfit;
            });
            gT += saleProfit;
            
            t.innerHTML += `<tr>
                <td><small>${h.date.split(',')[0]}</small></td>
                <td>${h.client}</td>
                <td><small>${h.items.length} skus</small></td>
                <td style="text-align:right">${c}${parseFloat(h.total).toFixed(2)}</td>
                <td style="text-align:right; font-weight:bold; color:#2E7D32">+${c}${saleProfit.toFixed(2)}</td>
            </tr>`;
        });
        document.getElementById('totalProfitDisplay').innerText = `${c}${gT.toFixed(2)}`;
    }

    // --- 8. TOOLS & CONFIG ---
    window.nav = (v, e) => {
        document.querySelectorAll('.view-panel').forEach(x => x.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(x => x.classList.remove('active'));
        document.getElementById('view-'+v).classList.add('active'); 
        if(e) e.classList.add('active');
        if(v==='pos') window.updateAllViews();
        if(v==='profit') renderProfit();
    }

    window.toggleCart = () => { document.getElementById('cartDrawer').classList.toggle('open'); document.getElementById('mainOverlay').classList.toggle('active'); renderCart(); }
    window.filterCat = (c, el) => { curFilter=c; document.querySelectorAll('.chip').forEach(x=>x.classList.remove('active')); el.classList.add('active'); window.updateAllViews(); }
    
    window.saveConfig = () => {
        config.name = document.getElementById('cfgName').value;
        config.currency = document.getElementById('cfgCurrency').value;
        config.color = document.getElementById('cfgColor').value;
        config.maintenance = document.getElementById('cfgMaintenance').checked;
        config.logo = document.getElementById('cfgLogoData').value;
        dbRef.ref('config').set(config).then(() => Toast.show("Config Guardada"));
    }

    window.applyConfig = () => {
        document.documentElement.style.setProperty('--primary', config.color);
        document.getElementById('brandName').innerText = config.name;
        document.getElementById('mobileTitleTxt').innerText = config.name;
        if(config.logo) {
            document.querySelectorAll('#displayLogoSidebar, #mobileLogoImg, #cfgLogoPreview').forEach(i => { i.src = config.logo; i.style.display='block'; });
            document.getElementById('cfgLogoData').value = config.logo;
        }
        document.getElementById('cfgName').value = config.name;
        document.getElementById('cfgColor').value = config.color;
        document.getElementById('cfgCurrency').value = config.currency;
        document.getElementById('cfgMaintenance').checked = config.maintenance || false;
    }

    // --- FUNCI√ìN EDITAR A√ëADIDA (CORRECCI√ìN) ---
    window.openEdit = (id) => {
        const prod = db.find(p => p.id === id);
        if(!prod) return;

        // Llenar campos con data existente
        document.getElementById('prodId').value = prod.id;
        document.getElementById('pCode').value = prod.c;
        document.getElementById('pModel').value = prod.m;
        document.getElementById('pCat').value = prod.cat;
        document.getElementById('pPrice').value = prod.d;
        document.getElementById('pStock').value = prod.stock;
        document.getElementById('pSize').value = prod.t || "";

        // Foto existente
        if(prod.img) {
            document.getElementById('imgPreview').src = prod.img;
            document.getElementById('imgPreview').style.display = 'block';
            document.getElementById('prodImgBase64').value = prod.img;
        } else {
            document.getElementById('imgPreview').style.display = 'none';
            document.getElementById('prodImgBase64').value = "";
        }
        
        document.getElementById('modalProdTitle').innerText = "Editar Producto";
        document.getElementById('modalProd').style.display = 'flex';
    }

    window.saveProduct = () => {
        const id = document.getElementById('prodId').value;
        const obj = {
            c: document.getElementById('pCode').value, m: document.getElementById('pModel').value,
            cat: document.getElementById('pCat').value, d: parseFloat(document.getElementById('pPrice').value)||0,
            stock: parseInt(document.getElementById('pStock').value)||0, t: document.getElementById('pSize').value,
            img: document.getElementById('prodImgBase64').value
        };

        const ref = dbRef.ref('inventory');
        if(id) {
            // Actualizar item espec√≠fico
            ref.transaction(curr => {
                if(!curr) return curr;
                const i = curr.findIndex(x => x.id == id);
                if(i!==-1) curr[i] = {...curr[i], ...obj};
                return curr;
            }).then(() => { closeModal('modalProd'); Toast.show("Actualizado"); });
        } else {
            // Crear Nuevo
            ref.transaction(curr => {
                if(!curr) curr = [];
                curr.unshift({ ...obj, id: Date.now() });
                return curr;
            }).then(() => { closeModal('modalProd'); Toast.show("Creado"); });
        }
    }
    
    window.delProd = (id) => {
        if(!confirm("Borrar?")) return;
        dbRef.ref('inventory').transaction(curr => {
            return curr ? curr.filter(x => x.id !== id) : curr;
        });
    }

    // Image Utils
    window.compressAndPreview = function(file, imgID, inputID) {
        if(!file || !file.type.startsWith('image/')) return;
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = (e) => {
            const img = new Image(); img.src = e.target.result;
            img.onload = () => {
                const canvas = document.createElement('canvas');
                const MAX = 400;
                let w=img.width, h=img.height;
                if(w>h){ if(w>MAX){h*=MAX/w; w=MAX}} else {if(h>MAX){w*=MAX/h; h=MAX}}
                canvas.width=w; canvas.height=h;
                canvas.getContext('2d').drawImage(img,0,0,w,h);
                const data = canvas.toDataURL('image/jpeg', 0.6);
                document.getElementById(imgID).src=data;
                document.getElementById(imgID).style.display='block';
                document.getElementById(inputID).value=data;
            }
        }
    }

    window.openModalProd = () => {
        ['pCode','pModel','pPrice','pStock','pSize','prodImgBase64'].forEach(x => document.getElementById(x).value="");
        document.getElementById('prodId').value="";
        document.getElementById('modalProdTitle').innerText = "Nuevo Producto";
        document.getElementById('imgPreview').style.display='none';
        document.getElementById('modalProd').style.display='flex';
    }

    window.closeModal = (id) => document.getElementById(id).style.display='none';
    window.onclick = (e) => { if(e.target.className === 'modal') e.target.style.display='none'; }
    
    window.reprint = (id) => {
        const h = history.find(x=>x.id==id);
        if(h) printFromData(h);
    }

    function printFromData(rec){
        document.getElementById('printBrand').innerText = config.name;
        document.getElementById('printDate').innerText = rec.date;
        document.getElementById('printClientBlock').innerHTML = `<b>${rec.client}</b><br>ID: ${rec.id}`;
        const tb = document.getElementById('printBody'); tb.innerHTML="";
        rec.items.forEach(i => {
            tb.innerHTML += `<tr><td>${i.qtyTxt}</td><td>${i.c} ${i.m}</td><td style="text-align:right">${config.currency}${i.total.toFixed(2)}</td></tr>`;
        });
        document.getElementById('printTotal').innerText = config.currency + rec.total.toFixed(2);
        setTimeout(() => window.print(), 300);
    }
    
    window.reloadInitialData = () => {
            if(confirm("DANGER: Esto borrar√° la base de datos y pondr√° stock 50. Continuar?")) {
                const sample = [{id:1, c:"TEST", m:"Test Prod", cat:"Dama", d:12, stock:50, t:"36-40"}];
                dbRef.ref('inventory').set(sample).then(() => window.location.reload());
            }
    }

    const Toast = { show: (m,t='success') => {
        const d = document.createElement('div'); d.className = `toast ${t}`;
        d.innerHTML = `<i class="fa-solid fa-${t==='success'?'check':'circle-exclamation'}"></i> ${m}`;
        document.getElementById('toast-container').appendChild(d);
        setTimeout(() => d.remove(), 3000);
    }};
</script>
</body>
</html>

