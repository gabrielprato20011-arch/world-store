<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>World Store V9.2 - Cloud Optimizado</title>
    
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;600;700;800&display=swap" rel="stylesheet">

   <style>
        :root {
            /* Colores Refinados */
            --primary: #D32F2F; 
            --primary-light: #FFEBEE;
            --dark: #1e1e2d;
            --dark-light: #2d2d44;
            --bg: #f3f5f9;
            --text-main: #3F4254;
            --text-muted: #B5B5C3;
            --white: #ffffff;
            
            --sidebar-width: 270px;
            --nav-height-mobile: 70px;
            --radius: 12px;
            --shadow-soft: 0 5px 20px rgba(0,0,0,0.03);
            --shadow-hover: 0 10px 25px rgba(0,0,0,0.06);
        }

        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        
        body { 
            margin: 0; 
            font-family: 'Montserrat', sans-serif; 
            background: var(--bg); 
            color: var(--text-main); 
            height: 100vh; height: 100dvh; 
            overflow: hidden; 
            display: flex; 
            overscroll-behavior: none; 
        }

        /* --- SIDEBAR --- */
        aside { 
            width: var(--sidebar-width); 
            background: var(--dark); 
            color: white; 
            display: flex; 
            flex-direction: column; 
            height: 100%; 
            z-index: 50; 
            box-shadow: 5px 0 20px rgba(0,0,0,0.05); 
            transition: 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
        }

        .brand { padding: 35px 20px; text-align: center; }
        #displayLogoSidebar { 
            width: 80px; height: 80px; 
            object-fit: contain; 
            border-radius: 50%; 
            margin: 0 auto 15px auto; 
            background: white; 
            border: 4px solid rgba(255,255,255,0.1); 
            display: none; 
            padding: 5px;
        }
        
        .brand h1 { margin: 0; font-size: 1.3rem; font-weight: 800; letter-spacing: 0.5px; text-transform: uppercase;}
        .brand small { color: rgba(255,255,255,0.5); font-weight: 500; font-size: 0.75rem; letter-spacing: 1px;}

        .nav-menu { flex: 1; padding: 20px 10px; overflow-y: auto; }
        
        .nav-item { 
            padding: 16px 20px; 
            cursor: pointer; 
            display: flex; 
            align-items: center; 
            gap: 15px; 
            color: #8c8c9e; 
            transition: all 0.2s; 
            font-size: 0.9rem; 
            border-radius: var(--radius);
            margin-bottom: 5px;
            font-weight: 500;
        }
        
        .nav-item i { font-size: 1.1rem; width: 25px; text-align: center; }

        .nav-item:hover { background: rgba(255,255,255,0.03); color: white; }
        
        .nav-item.active { 
            background: var(--primary); 
            color: white; 
            font-weight: 600; 
            box-shadow: 0 4px 15px rgba(211, 47, 47, 0.3);
        }

        .sys-info { padding: 20px; font-size: 0.7rem; text-align: center; color: rgba(255,255,255,0.3); border-top: 1px solid rgba(255,255,255,0.05); }

        /* --- MAIN AREA --- */
        main { flex: 1; position: relative; display: flex; flex-direction: column; overflow: hidden; width: 100%; height: 100%; }

        #globalBanner {
            display: none; background: #fff8e1; color: #8d6e16; text-align: center; 
            padding: 10px; font-weight: 700; font-size: 0.85rem; width: 100%; 
            border-bottom: 1px solid #ffeeba;
        }

        header { 
            height: 80px; background: rgba(255,255,255,0.9); 
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(0,0,0,0.05); 
            display: flex; align-items: center; justify-content: space-between; 
            padding: 0 30px; gap: 20px; flex-shrink: 0; z-index: 40;
        }
        
        .mobile-brand { display: none; align-items: center; gap: 10px; }
        .mobile-brand img { width: 40px; height: 40px; border-radius: 50%; object-fit: contain; background: white; box-shadow: 0 2px 5px rgba(0,0,0,0.1);}

        /* SEARCH BAR */
        .search-wrap { position: relative; flex: 1; max-width: 450px; }
        .search-wrap input { 
            width: 100%; padding: 12px 20px 12px 45px; 
            border-radius: 50px; border: 2px solid transparent; 
            background: #eef0f8; font-size: 0.9rem; font-weight: 500;
            color: var(--dark); transition: 0.2s;
        }
        .search-wrap input:focus { background: white; border-color: var(--primary); box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .search-wrap input::placeholder { color: #a1a5b7; }
        .search-wrap i { position: absolute; left: 18px; top: 50%; transform: translateY(-50%); color: #a1a5b7; }
        
        /* FILTERS */
        .filter-group { display: flex; gap: 8px; overflow-x: auto; scrollbar-width: none; align-items: center; }
        .chip { 
            padding: 8px 18px; border-radius: 50px; font-size: 0.8rem; font-weight: 600; cursor: pointer; 
            background: white; border: 1px solid #e1e3ea; color: #7e8299; transition:0.2s;
        }
        .chip:hover { border-color: var(--text-muted); }
        .chip.active { background: var(--dark); color: white; border-color: var(--dark); box-shadow: 0 4px 10px rgba(0,0,0,0.15); }

        /* --- VISTAS --- */
        .view-panel { padding: 25px 30px; flex: 1; overflow-y: auto; display: none; padding-bottom: 100px; }
        .view-panel.active { display: block; animation: fadeIn 0.4s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- GRID DE PRODUCTOS (Modern Card) --- */
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 20px; }
        .card { 
            background: white; border-radius: 16px; overflow: hidden; 
            border: none; box-shadow: var(--shadow-soft); cursor: pointer; 
            display: flex; flex-direction: column; height: 100%; position: relative;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .card:hover { transform: translateY(-5px); box-shadow: var(--shadow-hover); }
        
        .card-img-wrap { 
            height: 160px; background: #f9f9f9; display: flex; 
            justify-content: center; align-items: center; position: relative; overflow: hidden; 
        }
        .card-img-wrap img { width: 100%; height: 100%; object-fit: cover; transition: transform 0.4s;}
        .card:hover .card-img-wrap img { transform: scale(1.05); }

        .badge-cat { 
            position: absolute; top: 10px; right: 10px; padding: 4px 10px; 
            border-radius: 20px; color: white; font-size: 0.65rem; font-weight: 700; 
            text-transform: uppercase; box-shadow: 0 3px 8px rgba(0,0,0,0.15); 
            backdrop-filter: blur(4px); z-index: 2;
        }
        
        .card-content { padding: 15px; flex: 1; display: flex; flex-direction: column; justify-content: space-between; gap: 8px;}
        .card h4 { margin: 0; font-size: 0.95rem; color: var(--text-main); font-weight: 700; line-height: 1.3; }
        .card p { margin: 0; font-size: 0.8rem; color: #7e8299; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; }
        
        .card-footer { display: flex; justify-content: space-between; align-items: flex-end; margin-top: auto; padding-top: 10px; border-top: 1px dashed #eff2f5;}
        .price { color: var(--primary); font-weight: 800; font-size: 1.1rem; }
        .stock { 
            font-size: 0.65rem; background: #E8F5E9; color: #2E7D32; 
            padding: 4px 8px; border-radius: 6px; font-weight: 700; letter-spacing: 0.5px; 
        }

        /* --- TABLES (Clean Style) --- */
        .table-wrap { 
            background: white; border-radius: 16px; overflow: hidden; 
            box-shadow: var(--shadow-soft); border: 1px solid rgba(0,0,0,0.02);
        }
        table { width: 100%; border-collapse: collapse; font-size: 0.9rem; min-width: 600px; }
        thead { background: #f9f9f9; color: var(--text-muted); text-transform: uppercase; font-size: 0.75rem; letter-spacing: 1px; font-weight: 700; }
        th { padding: 15px 20px; text-align: left; }
        td { padding: 15px 20px; border-bottom: 1px solid #f0f0f0; color: var(--text-main); font-weight: 500;}
        tr:last-child td { border-bottom: none; }
        tr:hover td { background: #fbfbfb; }
        
        .thumb { width: 45px; height: 45px; border-radius: 8px; object-fit: cover; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }

        /* --- BOTONES Y FORMULARIOS --- */
        .btn { padding: 12px 20px; border-radius: 10px; border:none; cursor: pointer; font-weight: 700; width: 100%; transition: all 0.2s; display: inline-flex; justify-content: center; align-items: center; gap: 8px; font-size: 0.9rem; letter-spacing: 0.3px;}
        .btn:hover { transform: translateY(-2px); filter: brightness(110%); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .btn:active { transform: scale(0.97); }
        
        .btn-primary { background: linear-gradient(145deg, var(--dark), #2c2c3e); color: white; }
        .btn-success { background: linear-gradient(145deg, #2E7D32, #43A047); color: white; box-shadow: 0 5px 15px rgba(46, 125, 50, 0.3); }
        .btn-danger { background: linear-gradient(145deg, #C62828, #E53935); color: white; box-shadow: 0 5px 15px rgba(198, 40, 40, 0.3);}
        .btn-blue { background: linear-gradient(145deg, #1565C0, #1E88E5); color: white; }

        input, select { 
            width: 100%; padding: 12px 15px; border: 1px solid #e1e3ea; border-radius: 10px; 
            font-size: 0.9rem; color: var(--text-main); background: #fff; transition: 0.2s;
            font-family: 'Montserrat', sans-serif;
        }
        input:focus, select:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(198, 40, 40, 0.1); }

        /* --- CART & MODALS --- */
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 900; display: none; backdrop-filter: blur(4px); opacity: 0; transition: opacity 0.3s;}
        .overlay.active { display: block; opacity: 1; }

        .cart-drawer { 
            position: fixed; top: 0; right: -500px; width: 450px; height: 100%; 
            background: white; z-index: 1100; transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1); 
            display: flex; flex-direction: column; box-shadow: -10px 0 40px rgba(0,0,0,0.15); 
        }
        .cart-drawer.open { transform: translateX(-500px); }
        
        .cart-items { flex: 1; overflow-y: auto; padding: 20px; }
        .c-item { 
            display: flex; gap: 15px; padding: 15px; border: 1px solid #f0f0f0; 
            border-radius: 12px; margin-bottom: 12px; align-items: center; background: white; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.02);
        }

        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 2000; display: none; align-items: center; justify-content: center; padding: 20px; backdrop-filter: blur(4px); }
        .modal-box { 
            background: white; width: 500px; max-width: 100%; padding: 30px; 
            border-radius: 20px; position: relative; max-height: 90vh; overflow-y: auto; 
            box-shadow: 0 20px 60px rgba(0,0,0,0.3); animation: zoomIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); 
        }
        @keyframes zoomIn { from { transform: scale(0.9); opacity: 0; } to { opacity: 1; transform: scale(1); } }

        /* UPLOADERS & CONFIG */
        .file-upload { border: 2px dashed #d1d4db; padding: 30px; text-align: center; border-radius: 16px; cursor: pointer; margin-top: 15px; background: #fafafa; transition:0.2s; position:relative; }
        .file-upload:hover { border-color: var(--primary); background: var(--primary-light); }
        
        .config-card { background: white; padding: 25px; border-radius: 16px; box-shadow: var(--shadow-soft); margin-bottom: 20px; }
        .section-title { font-weight: 800; color: var(--dark); border-bottom: 1px solid #f0f0f0; padding-bottom: 10px; margin-bottom: 20px; font-size: 1rem; text-transform: uppercase; letter-spacing: 0.5px;}

        #loader { position: fixed; top:0; left:0; width:100%; height:100%; background:white; z-index:9999; display:flex; justify-content:center; align-items:center; flex-direction:column; }
        .spinner { width:50px; height:50px; border:5px solid #f3f3f3; border-top-color:var(--primary); border-radius:50%; animation:spin 1s cubic-bezier(0.55, 0.055, 0.675, 0.19) infinite; }
        
        /* MOBILE TWEAKS */
        @media (max-width: 768px) {
            body { flex-direction: column; }
            aside { position: fixed; bottom: 0; left: 0; width: 100%; height: var(--nav-height-mobile); flex-direction: row; justify-content: space-around; padding: 0 10px; background: white; border-top: 1px solid #f0f0f0; z-index: 1000; box-shadow: 0 -5px 20px rgba(0,0,0,0.05); }
            .brand, .sys-info { display: none; }
            .nav-menu { display: flex; flex-direction: row; width: 100%; padding: 0; justify-content: space-between; align-items: center; }
            .nav-item { flex-direction: column; justify-content: center; padding: 8px 5px; flex: 1; border-radius: 10px; margin: 0; background: transparent; gap: 5px; font-size: 0.7rem; color: #999; }
            .nav-item i { font-size: 1.2rem; margin-bottom: 0; }
            .nav-item.active { background: var(--primary-light); color: var(--primary); box-shadow: none;}
            
            main { height: calc(100vh - var(--nav-height-mobile)); }
            header { padding: 10px 15px; height: auto; flex-wrap: wrap; gap: 10px; }
            .mobile-brand { display: flex; }
            .search-wrap { width: 100%; max-width: none; order: 3; }
            .filter-group { width: 100%; order: 4; padding-bottom: 5px; }
            .grid { grid-template-columns: 1fr 1fr; gap: 15px; padding: 5px;}
            .cart-drawer { width: 100%; right: -100%; }
            .cart-drawer.open { transform: translateX(-100%); }
        }
        
        @keyframes spin { 100% { transform:rotate(360deg); } }
        @media print { body > *:not(#print-layer) { display: none !important; } #print-layer { display: block !important; position: absolute; top: 0; left: 0; width: 100%; z-index: 99999; background: white; min-height: 100vh;} @page { margin: 5mm; } }
    </style>
</head>

<body>

    <div id="loader">
        <div class="spinner"></div>
        <p style="margin-top:15px; color:#555; font-weight:bold;">Sincronizando Sistema...</p>
    </div>
    <div id="toast-container"></div>
    <div class="overlay" id="mainOverlay" onclick="toggleCart()" style="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:900;display:none;backdrop-filter:blur(3px);"></div>

    <!-- SIDEBAR -->
    <aside>
        <div class="brand">
            <img id="displayLogoSidebar" src="" alt="Logo">
            <h1 id="brandName">WORLD STORE</h1>
            <small id="brandSubSidebar">Gesti칩n en la Nube</small>
        </div>
        <div class="nav-menu">
            <div class="nav-item active" onclick="nav('pos', this)"><i class="fa-solid fa-store"></i> <span>Cat치logo</span></div>
            <div class="nav-item" onclick="nav('history', this)"><i class="fa-solid fa-receipt"></i> <span>Ventas</span></div>
            <div class="nav-item" onclick="nav('inv', this)"><i class="fa-solid fa-boxes-stacked"></i> <span>Inventario</span></div>
            <div class="nav-item" onclick="toggleCart()"><i class="fa-solid fa-cart-shopping"></i> <span>Carrito <b id="cartCountBadge" style="background:var(--primary); color:white; padding:1px 6px; border-radius:10px; font-size:0.7em;">0</b></span></div>
            <div class="nav-item" onclick="nav('config', this)"><i class="fa-solid fa-sliders"></i> <span>Configuraci칩n</span></div>
        </div>
        <div class="sys-info"><span id="footerBrand">SISTEMA v9.2</span></div>
    </aside>

    <main>
        <div id="globalBanner"></div>
        <header>
            <div class="mobile-brand">
                <img id="mobileLogoImg" src="" style="display:none;">
                <h2 id="mobileTitleTxt">WORLD STORE</h2>
            </div>
            <div class="search-wrap">
                <i class="fa-solid fa-magnifying-glass"></i>
                <!-- CAMBIO AQU칈: Llamamos a searchDelay() en lugar de funciones directas para OPTIMIZAR -->
                <input type="text" id="searchInput" placeholder="Buscar modelo, c칩digo..." onkeyup="searchDelay()">
            </div>
            <div class="filter-group">
                <div class="chip active" onclick="filterCat('all', this)">Todo</div>
                <div class="chip" onclick="filterCat('Ni침o/Ni침a', this)">Infantil</div>
                <div class="chip" onclick="filterCat('Dama', this)">Dama</div>
                <div class="chip" onclick="filterCat('Caballero', this)">Caballero</div>
            </div>
        </header>

        <!-- POS (Catalogo) -->
        <div id="view-pos" class="view-panel active">
            <div class="grid" id="posGrid"></div>
        </div>

        <!-- HISTORY -->
        <div id="view-history" class="view-panel">
            <div style="background:white; padding:20px; border-radius:12px; margin-bottom:20px; box-shadow:0 2px 10px rgba(0,0,0,0.05); display:flex; justify-content:space-between;">
                <div><h3 style="margin:0">Registro de Ventas</h3><small>Historial en Tiempo Real</small></div>
                <div style="text-align:right;"><div style="font-size:0.8rem;color:#777">Total Recaudado</div><div style="font-size:1.5rem;font-weight:800;color:var(--primary)" id="grandTotalHistory">$0.00</div></div>
            </div>
            <div class="table-wrap">
                <table>
                    <thead><tr><th>Fecha</th><th>Cliente</th><th>Detalle</th><th>Total</th><th></th></tr></thead>
                    <tbody id="histBody"></tbody>
                </table>
            </div>
            <br><button class="btn btn-danger" onclick="clearHistory()"><i class="fa-solid fa-trash-can"></i> Limpiar Historial Local y Nube</button>
        </div>

        <!-- INVENTORY -->
        <div id="view-inv" class="view-panel">
            <div style="display:flex; justify-content:space-between; margin-bottom:20px; align-items:center;">
                <h3>Inventario de Productos</h3>
                <button class="btn btn-success" style="width:auto;" onclick="openModalProd()">+ Nuevo Producto</button>
            </div>
            <div class="table-wrap">
                <table>
                    <thead><tr><th>Img</th><th>C칩digo / Modelo</th><th>Precio (Docena)</th><th>Stock</th><th></th></tr></thead>
                    <tbody id="invBody"></tbody>
                </table>
            </div>
        </div>

        <!-- CONFIG -->
        <div id="view-config" class="view-panel">
            <div class="settings-header"><i class="fa-solid fa-sliders"></i> Personalizaci칩n del Sistema</div>
            
            <div class="config-card">
                <div class="section-title">Identidad Visual</div>
                
                <div class="form-row">
                    <label>Logo de la Empresa (Esquina Superior Izquierda)</label>
                    <div style="border:1px solid #ddd; padding:15px; border-radius:8px; display:flex; align-items:center; gap:15px; background:#f9f9f9;">
                        <img id="cfgLogoPreview" src="https://placehold.co/100x100?text=LOGO" style="width:60px; height:60px; object-fit:contain; background:white; border-radius:50%; border:2px solid #eee; box-shadow:0 2px 5px rgba(0,0,0,0.1);">
                        <div style="flex:1;">
                            <input type="file" accept="image/*" id="logoUploader" style="display:none" onchange="compressAndPreview(this.files[0], 'cfgLogoPreview', 'cfgLogoData')">
                            <button class="btn btn-blue" style="width:auto; padding:8px 15px;" onclick="document.getElementById('logoUploader').click()">
                                <i class="fa-solid fa-cloud-arrow-up"></i> Cambiar Logo
                            </button>
                            <input type="hidden" id="cfgLogoData">
                            <div style="font-size:0.75rem; color:#666; margin-top:5px;">El logo se ajustar치 autom치ticamente para la barra lateral y facturas.</div>
                        </div>
                    </div>
                </div>

                <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px;">
                    <div class="form-row"><label>Nombre Empresa (T칤tulo Principal)</label><input type="text" id="cfgName" placeholder="WORLD STORE"></div>
                    <div class="form-row"><label>Subt칤tulo / Eslogan</label><input type="text" id="cfgSub" placeholder="Mayoristas..."></div>
                </div>
                
                <div class="form-row"><label>Color Principal del Tema</label><input type="color" id="cfgColor" style="height:45px;width:100%;padding:2px;cursor:pointer;" oninput="previewColor(this.value)"></div>
            </div>

            <div class="config-card">
                <div class="section-title">Operaciones & Facturaci칩n</div>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px;">
                    <div class="form-row"><label>Tel칠fono Contacto</label><input type="tel" id="cfgTel"></div>
                    <div class="form-row"><label>S칤mbolo Moneda</label><input type="text" id="cfgCurrency"></div>
                </div>
                <div class="form-row"><label>Mensaje Pie de Factura</label><input type="text" id="cfgFooter"></div>
            </div>

            <div class="config-card">
                <div class="section-title">Anuncios y Estado</div>
                <div class="form-row"><label>Anuncio Global (Banner amarillo superior)</label><input type="text" id="cfgBanner" placeholder="Ej: 춰Ofertas de Navidad!"></div>
                
                <label class="checkbox-wrap">
                    <input type="checkbox" id="cfgMaintenance">
                    <span>Activar Modo "Cerrado / En Mantenimiento" (Oculta cat치logo a clientes)</span>
                </label>
            </div>
            
            <button class="btn btn-primary" style="padding:15px; font-size:1.1rem;" onclick="window.saveConfig()"><i class="fa-solid fa-floppy-disk"></i> GUARDAR CAMBIOS</button>
            
            <br><br><br>
            <div style="border-top:1px solid #eee; padding-top:20px; text-align:center;">
                <p style="color:#666;font-size:0.8rem;">Zona de Recuperaci칩n</p>
                <button class="btn btn-blue" style="background:#607D8B; max-width:300px;" onclick="window.reloadInitialData()"><i class="fa-solid fa-database"></i> Recargar Cat치logo PDF Original</button>
            </div>
        </div>
    </main>

    <!-- DRAWER & MODALS -->
    <div id="cartDrawer" class="cart-drawer">
        <div style="padding:15px; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center;">
            <h3 style="margin:0">游 Tu Pedido</h3>
            <button onclick="toggleCart()" style="background:none; border:none; font-size:1.5rem; padding:10px;">&times;</button>
        </div>
        <div class="cart-items" id="cartContainer"></div>
        <div class="cart-total-bar">
            <div class="client-inputs">
                <input type="text" id="cartClientName" placeholder="Nombre Cliente *">
                <input type="tel" id="cartClientPhone" placeholder="Tel칠fono Contacto" inputmode="tel">
            </div>
            <div style="display:flex; justify-content:space-between; margin-bottom:15px; font-size:1.2rem; font-weight:bold;"><span>Total</span><span id="cartTotalDisplay" style="color:var(--primary)">$0.00</span></div>
            <button class="btn btn-success w-100" onclick="window.processSale()" style="padding:15px;font-size:1.1rem;">CONFIRMAR VENTA</button>
        </div>
    </div>

    <div id="modalSale" class="modal">
        <div class="modal-box">
            <h3 id="saleTitle" style="margin-top:0;">Producto</h3>
            <input type="hidden" id="saleId">
            <div style="background:#f9f9f9; padding:15px; border-radius:8px; margin:10px 0; text-align:center;">
                <label style="display:block;margin-bottom:5px;font-weight:bold;font-size:0.8rem;">Seleccione Cantidad por:</label>
                <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:5px;">
                    <button class="btn" style="font-size:0.75rem; padding:8px 2px;" id="btn-doc" onclick="setSaleType('doc')">DOCENA</button>
                    <button class="btn" style="font-size:0.75rem; padding:8px 2px; background:#eee;" id="btn-half" onclick="setSaleType('half')">MEDIA</button>
                    <button class="btn" style="font-size:0.75rem; padding:8px 2px; background:#eee;" id="btn-unit" onclick="setSaleType('unit')">PAR</button>
                </div>
                <div id="unitPriceDisplay" style="margin-top:10px; font-weight:600; color:#555;"></div>
            </div>
            <div style="display:flex; gap:10px; margin-bottom:20px; align-items:center;">
                <button class="btn" style="background:#eee; font-size:1.5rem; width:60px;" onclick="adjQty(-1)">-</button>
                <input type="number" id="saleQty" value="1" min="1" inputmode="decimal" style="flex:1; text-align:center; padding:12px; font-size:1.3rem; border:1px solid #ddd; border-radius:8px; font-weight:bold;" onchange="updateCalc()">
                <button class="btn" style="background:#eee; font-size:1.5rem; width:60px;" onclick="adjQty(1)">+</button>
            </div>
            <div style="text-align:right; font-size:2rem; font-weight:800; color:var(--primary); margin-bottom:20px;"><span id="saleTotalCalc">$0.00</span></div>
            <div style="display:flex; gap:10px;">
                <button class="btn" style="background:#eee; flex:1;" onclick="closeModal('modalSale')">Cancelar</button>
                <button class="btn btn-success" style="flex:2;" onclick="confirmAdd()">AGREGAR AL PEDIDO</button>
            </div>
        </div>
    </div>

    <div id="modalProd" class="modal">
        <div class="modal-box">
            <h3 id="modalProdTitle" style="margin-top:0;">Gesti칩n de Producto</h3>
            <input type="hidden" id="prodId"><input type="hidden" id="prodImgBase64">
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                <div style="grid-column:span 2"><label>Nombre / Modelo</label><input type="text" id="pModel"></div>
                <div><label>C칩digo</label><input type="text" id="pCode"></div>
                <div><label>Categor칤a</label><select id="pCat"><option>Dama</option><option>Caballero</option><option>Ni침o/Ni침a</option></select></div>
                <div><label>Precio Docena</label><input type="number" id="pPrice" inputmode="decimal"></div>
                <div><label>Stock Paquetes</label><input type="number" id="pStock" inputmode="numeric"></div>
                <div style="grid-column:span 2"><label>Tallas (Ej: 35-40)</label><input type="text" id="pSize"></div>
            </div>
            <div class="file-upload" id="dropZone" onclick="document.getElementById('fileInput').click()">
                <span style="color:#aaa;"><i class="fa-solid fa-camera"></i> Toca para subir foto</span>
                <img id="imgPreview">
                <input type="file" id="fileInput" accept="image/*" style="display:none" onchange="compressAndPreview(this.files[0], 'imgPreview', 'prodImgBase64')">
                <div class="upload-loading">Procesando imagen...</div>
            </div>
            <div style="margin-top:20px; display:flex; gap:10px;">
                <button class="btn btn-danger" onclick="closeModal('modalProd')">Cancelar</button>
                <button class="btn btn-success" onclick="window.saveProduct()">GUARDAR CAMBIOS</button>
            </div>
        </div>
    </div>

    <div id="print-layer">
        <div style="width:100%;max-width:800px;margin:0 auto;color:black;font-family:sans-serif;font-size:14px;">
            <div style="border-bottom:2px solid #000;padding-bottom:10px;margin-bottom:15px;display:flex;justify-content:space-between; align-items:center;">
                <div style="display:flex; align-items:center; gap:15px;">
                    <img id="printLogoDisplay" style="height:70px;width:70px;object-fit:contain;display:none;">
                    <div>
                        <h1 id="printBrand" style="margin:0;font-size:22px;text-transform:uppercase;"></h1>
                        <div id="printSub" style="font-weight:bold; color:#555;"></div>
                        <div id="printTel" style="font-size:12px;"></div>
                    </div>
                </div>
                <div style="text-align:right;"><h2 style="color:black;margin:0;">NOTA DE ENTREGA</h2><div style="margin-top:5px;">Fecha: <span id="printDate"></span></div></div>
            </div>
            <div id="printClientBlock" style="border:1px solid #ccc; padding:10px; margin-bottom:20px; border-radius:4px; background:#f9f9f9;"></div>
            <table style="width:100%;border-collapse:collapse;margin-bottom:20px;"><thead><tr style="background:#eee;font-weight:bold;text-transform:uppercase;font-size:12px;"><th style="padding:8px;text-align:left;">Cant.</th><th style="padding:8px;text-align:left;">Descripci칩n</th><th style="padding:8px;text-align:right;">Subtotal</th></tr></thead><tbody id="printBody"></tbody></table>
            <div style="text-align:right;font-size:20px;font-weight:bold;border-top:2px solid #000;padding-top:10px;">TOTAL A PAGAR: <span id="printTotal"></span></div>
            <div id="printFooter" style="text-align:center;font-size:12px;margin-top:40px;color:#555;font-style:italic;"></div>
        </div>
    </div>

    <!-- SCRIPT -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

    <script>
        // --- CONFIGURACI칍N DE FIREBASE (Mantenida intacta) ---
        const firebaseConfig = {
            apiKey: "AIzaSyB5ygJIoEgpJPKY0qMULocohmzXGc7UWFE",
            authDomain: "worldstoresystem.firebaseapp.com",
            databaseURL: "https://worldstoresystem-default-rtdb.firebaseio.com",
            projectId: "worldstoresystem",
            storageBucket: "worldstoresystem.firebasestorage.app",
            messagingSenderId: "460628958914",
            appId: "1:460628958914:web:95da76852bedecbdcf255b",
            measurementId: "G-9NQMR0XVHT"
        };

        try {
            firebase.initializeApp(firebaseConfig);
        } catch(e) { console.error(e); }
        
        const dbRef = firebase.database();
        let db=[], history=[], config={name:"WORLD STORE", sub:"ARIANA & GABRIEL", color:"#C62828", currency:"$", tel:"0424-7125937", footer:"Gracias por su compra"};
        let cart=[], curFilter='all', saleItem=null, saleMode='doc';

        // CONEXIONES
        dbRef.ref('inventory').on('value', s => { 
            db = s.val() || []; 
            if(!s.val()) saveInitialData(); 
            // CAMBIO: Se usa la funcion unificada
            window.updateAllViews(); 
            document.getElementById('loader').style.display='none'; 
        });
        dbRef.ref('history').on('value', s => { history = s.val() ? Object.values(s.val()).sort((a,b)=>b.id-a.id) : []; renderHistory(); });
        dbRef.ref('config').on('value', s => { if(s.val()){ config=s.val(); applyConfig(); window.updateAllViews(); } else { saveConfig(); } });

        // --- OPTIMIZACI칍N DE B칔SQUEDA (Debounce) ---
        let searchTimer;
        window.searchDelay = function() {
            clearTimeout(searchTimer);
            searchTimer = setTimeout(() => {
                window.updateAllViews(); 
            }, 300); // 300ms de espera antes de ejecutar
        }

        // --- FUNCI칍N UNIFICADA ---
        window.updateAllViews = function() {
            renderPOS();
            renderInv();
        }

        // --- FUNCIONES COMPRESOR ---
        window.compressAndPreview = function(file, imgPreviewId, hiddenInputId) {
            if(!file || !file.type.startsWith('image/')) return;
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = (event) => {
                const img = new Image();
                img.src = event.target.result;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const maxSize = 500;
                    let width = img.width; let height = img.height;
                    if (width > height) { if (width > maxSize) { height *= maxSize / width; width = maxSize; } } else { if (height > maxSize) { width *= maxSize / height; height = maxSize; } }
                    canvas.width = width; canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);
                    const dataUrl = canvas.toDataURL('image/jpeg', 0.7);
                    document.getElementById(imgPreviewId).src = dataUrl;
                    document.getElementById(imgPreviewId).style.display = 'block';
                    document.getElementById(hiddenInputId).value = dataUrl;
                    if(imgPreviewId === 'imgPreview') { document.getElementById('dropZone').classList.add('has-img'); }
                    Toast.show("Imagen optimizada correctamente", "success");
                }
            }
        };

        // --- CARGA DEL PDF ---
        window.saveProduct = function() {
            const id=document.getElementById('prodId').value;
            const obj={
                c:document.getElementById('pCode').value, m:document.getElementById('pModel').value, 
                cat:document.getElementById('pCat').value, d:parseFloat(document.getElementById('pPrice').value)||0,
                stock:parseInt(document.getElementById('pStock').value)||0, t:document.getElementById('pSize').value,
                img:document.getElementById('prodImgBase64').value
            };
            let newDb=[...db]; 
            if(id) { const i=newDb.findIndex(x=>x.id==id); if(i!==-1) newDb[i]={...newDb[i],...obj}; } 
            else { newDb.unshift({...obj, id:Date.now()}); }
            
            dbRef.ref('inventory').set(newDb).then(()=>{ closeModal('modalProd'); Toast.show("Producto Guardado"); });
        }

        window.processSale = function() {
            if(cart.length===0) return alert("El carrito est치 vac칤o");
            const nm=document.getElementById('cartClientName').value.trim(); if(!nm) return alert("Ingrese Nombre del Cliente");
            
            let tot=0, desc="", snap=JSON.parse(JSON.stringify(cart));
            cart.forEach(i=>{
                tot+=i.total; desc+=`${i.qtyTxt} ${i.c}, `;
                const p=db.find(x=>x.id==i.pId); if(p) p.stock-=i.deduct;
            });
            
            dbRef.ref('inventory').set(db); 
            const rec={id:Date.now(), date:new Date().toLocaleString(), client:nm, phone:document.getElementById('cartClientPhone').value, total:tot, items:snap, desc:desc};
            dbRef.ref('history').push(rec);
            
            printFromData(rec);
            cart=[]; document.getElementById('cartClientName').value=""; document.getElementById('cartClientPhone').value="";
            renderCart(); toggleCart();
        }

        window.saveConfig = function() {
            config.name = document.getElementById('cfgName').value; config.sub = document.getElementById('cfgSub').value;
            config.tel = document.getElementById('cfgTel').value; config.currency = document.getElementById('cfgCurrency').value;
            config.footer = document.getElementById('cfgFooter').value; config.color = document.getElementById('cfgColor').value;
            config.banner = document.getElementById('cfgBanner').value; config.maintenance = document.getElementById('cfgMaintenance').checked;
            const l=document.getElementById('cfgLogoData').value; if(l) config.logo=l;
            dbRef.ref('config').set(config).then(()=>Toast.show("Personalizaci칩n Guardada", "success"));
        }
        
        function saveInitialData(){
            const initialData = [
                // DAMA
                {c:"W 15",m:"Croc Clasico Baby",d:46,t:"36-40",cat:"Dama"},{c:"LC W72-3",m:"Croc Decorado",d:32,t:"35-40",cat:"Dama"},{c:"LC W99-1",m:"Sandalia Fashion",d:48,t:"36-40",cat:"Dama"},
                {c:"LC W-801",m:"Plataforma Barbie",d:35,t:"36-40",cat:"Dama"},{c:"LC M14-2",m:"Chancla Gatito/Vaca",d:38,t:"36-40",cat:"Dama"},{c:"HY 047-1",m:"Croc Bicolor 1",d:42,t:"36-40",cat:"Dama"},
                {c:"HY 047-2",m:"Croc Bicolor 2",d:42,t:"36-40",cat:"Dama"},{c:"HY 047-3",m:"Croc con Peluche",d:47,t:"36-40",cat:"Dama"},{c:"HY 040-1",m:"Croc Kuromi",d:32,t:"36-40",cat:"Dama"},
                {c:"HY 040-3",m:"Croc Accesorios",d:33,t:"36-40",cat:"Dama"},{c:"HY 040-4",m:"Croc Cadena Oro",d:34,t:"36-40",cat:"Dama"},{c:"HY 040-6",m:"Croc Perla/Oso",d:36,t:"36-40",cat:"Dama"},
                {c:"HY 077",m:"Croc Hong Yuan Flores",d:34,t:"36-40",cat:"Dama"},{c:"RS 111",m:"Croc Cadena Negro",d:43,t:"36-41",cat:"Dama"},{c:"RS 110",m:"Croc Grueso Fashion",d:50,t:"36-41",cat:"Dama"},
                {c:"RS 109",m:"Croc Geom칠trico",d:39,t:"36-41",cat:"Dama"},{c:"RS 112",m:"Croc Plataforma Alta",d:31,t:"36-41",cat:"Dama"},{c:"RS 107",m:"Sueco Cerrado Liso",d:44,t:"36-41",cat:"Dama"},
                {c:"RS 202",m:"Sueco Hebilla",d:35,t:"36-41",cat:"Dama"},{c:"HY 056",m:"Croc Puntera Love",d:35,t:"36-40",cat:"Dama"},{c:"RS 123",m:"Chancla Nike Style",d:35,t:"36-41",cat:"Dama"},
                {c:"HY 032",m:"Plataforma Arrugada",d:43,t:"36-40",cat:"Dama"},{c:"HY 032-1",m:"Plataforma Lazo",d:47,t:"36-40",cat:"Dama"},{c:"HY 011-2",m:"Plataforma Textura",d:41,t:"36-40",cat:"Dama"},
                {c:"RS A9",m:"Yeezy Style Slide",d:34,t:"36-41",cat:"Dama"},{c:"HY 006-1",m:"Chancla Cadena Strass",d:42,t:"36-40",cat:"Dama"},{c:"LB - 03",m:"Sandalia Doble Tira",d:35,t:"36-40",cat:"Dama"},
                {c:"HY 006-2",m:"Chancla Cadena Oso",d:42,t:"36-40",cat:"Dama"},{c:"HY 011-1",m:"Plataforma Flor",d:47,t:"36-40",cat:"Dama"},{c:"HY 002-1",m:"Chancla Vaca (Forro)",d:36,t:"36-40",cat:"Dama"},
                {c:"HY 002-3",m:"Chancla Estampada",d:40,t:"36-40",cat:"Dama"},{c:"HY 001",m:"Chancla Nube Lisa",d:41,t:"36-40",cat:"Dama"},{c:"LC W99",m:"Chancla Brillo",d:48,t:"36-40",cat:"Dama"},
                {c:"RS A2",m:"Yeezy Estampado",d:36,t:"36-41",cat:"Dama"},{c:"RS A2-1",m:"Chancla Lazo Minnie",d:34,t:"36-41",cat:"Dama"},{c:"LC B-2426-1",m:"Sandalia Dedo Lisa Pastel",d:30,t:"36-40",cat:"Dama"},
                {c:"HY 028-4",m:"Hawaiana Flores",d:30,t:"36-40",cat:"Dama"},{c:"PW 33-1",m:"Hawaiana Transparente",d:30,t:"36-41",cat:"Dama"},{c:"HY 022",m:"Chancla Cruzada Acolchada",d:42,t:"36-40",cat:"Dama"},
                {c:"HY 058-1",m:"Sandalia Doble Lazo",d:45,t:"36-40",cat:"Dama"},{c:"HY 029",m:"Sandalia Sport Ajustable",d:56,t:"36-40",cat:"Dama"},
                {c:"W-06",m:"Hawaiana Dedo Caballero",d:28,t:"36-40",cat:"Dama"},{c:"LC B-2426",m:"Sandalia Dedo Oscura",d:30,t:"36-40",cat:"Dama"},{c:"HY 060",m:"Croc Bicolor Casual",d:44,t:"36-40",cat:"Dama"},
                {c:"W-99-2",m:"Chancla Franjas",d:36,t:"36-40",cat:"Dama"},
                // CABALLERO
                {c:"LC M-15D",m:"Croc Camuflaje",d:52,t:"40-45",cat:"Caballero"},{c:"M-15",m:"Croc Linea Amarilla",d:50,t:"40-45",cat:"Caballero"},{c:"LA-08",m:"Chancla Adidas Logo",d:38,t:"40-45",cat:"Caballero"},
                {c:"SM 99-3",m:"Chancla Banda Ancha",d:45,t:"40-45",cat:"Caballero"},{c:"LC M-76",m:"Croc 'M' Hebilla",d:35,t:"40-45",cat:"Caballero"},{c:"LC M-75",m:"Croc 'M' Liso",d:34,t:"40-45",cat:"Caballero"},
                {c:"M-60",m:"Chancla Logo Lateral",d:38,t:"40-45",cat:"Caballero"},{c:"LC M-99-1",m:"Sandalia Tiras",d:48,t:"40-45",cat:"Caballero"},{c:"SM 99-8",m:"Chancla Banda Logo",d:45,t:"40-45",cat:"Caballero"},
                {c:"SM 99-5",m:"Chancla 'Sport'",d:45,t:"40-45",cat:"Caballero"},{c:"SM 99-4",m:"Chancla 'Just Do It'",d:45,t:"40-45",cat:"Caballero"},{c:"M99-2",m:"Chancla 3 Franjas",d:38,t:"40-45",cat:"Caballero"},
                {c:"RS 108",m:"Sueco Cerrado Sport",d:51,t:"40-45",cat:"Caballero"},{c:"HY 060-1",m:"Croc Salpicado",d:45,t:"36-40",cat:"Caballero"},{c:"HY 076",m:"Croc Todo Terreno",d:34,t:"40-45",cat:"Caballero"},
                {c:"HY 045",m:"Croc Cl치sico Liso",d:31,t:"40-45",cat:"Caballero"},{c:"RS A3",m:"Yeezy Logo Color",d:41,t:"40-45",cat:"Caballero"},{c:"HY 016",m:"Yeezy Slide Lisa",d:36,t:"40-45",cat:"Caballero"},
                {c:"HY 049-1",m:"Sandalia 'Sport' Letras",d:48,t:"40-45",cat:"Caballero"},{c:"LC A-2402",m:"Yeezy Estampado Tropical",d:36,t:"40-45",cat:"Caballero"},{c:"HY 016-1",m:"Yeezy Slide Camuflaje",d:46,t:"40-45",cat:"Caballero"},
                {c:"HY 037",m:"Sandalia Slide Malla",d:38,t:"40-45",cat:"Caballero"},{c:"HY 010",m:"Yeezy Texture",d:36,t:"40-45",cat:"Caballero"},{c:"LC AM14-1",m:"Yeezy Malla Fina",d:34,t:"40-45",cat:"Caballero"},
                {c:"HY 033",m:"Sandalia Doble Hebilla Goma",d:35,t:"40-45",cat:"Caballero"},{c:"LC A-2403",m:"Yeezy Slide Textura",d:29,t:"40-45",cat:"Caballero"},{c:"LC A-2402D",m:"Yeezy Selva",d:45,t:"40-45",cat:"Caballero"},
                {c:"LC M99",m:"Chancla Numero 23",d:50,t:"40-45",cat:"Caballero"},{c:"HY 007",m:"Sandalia Cuadros",d:30,t:"40-45",cat:"Caballero"},{c:"HY 049",m:"Sandalia Ajuste Lateral",d:50,t:"40-45",cat:"Caballero"},
                {c:"RS 101",m:"Chancla Basket/Jordan",d:34,t:"40-45",cat:"Caballero"},{c:"HY 042",m:"Sandalia Dedo Sport",d:30,t:"40-45",cat:"Caballero"},{c:"HY 027",m:"Hawaiana Simple",d:30,t:"40-45",cat:"Caballero"},
                {c:"HY 031-4",m:"Sandalia Franciscana",d:56,t:"40-45",cat:"Caballero"},
                // NI칌O / NI칌A
                {c:"LC C-09D",m:"Croc Infantil 3D",d:44,t:"30-35",cat:"Ni침o/Ni침a"},{c:"LC C-02-1",m:"Croc Pastel Dibujos",d:32,t:"30-35",cat:"Ni침o/Ni침a"},{c:"LC D-55-1",m:"Sandalia Banda Dibujos",d:32,t:"24-29",cat:"Ni침o/Ni침a"},
                {c:"LC C-55-1",m:"Chancla Banda Ancha Kids",d:33,t:"30-35",cat:"Ni침o/Ni침a"},{c:"LC C-07-1",m:"Croc Animalitos",d:30,t:"30-35",cat:"Ni침o/Ni침a"},{c:"LC C-04",m:"Croc Textura Cesta",d:33,t:"30-35",cat:"Ni침o/Ni침a"},
                {c:"LC 05",m:"Chancla Nike Kids",d:32,t:"30-35",cat:"Ni침o/Ni침a"},{c:"RS 106",m:"Croc Mickey",d:35,t:"25-30",cat:"Ni침o/Ni침a"},{c:"RS 133",m:"Croc Kuromi/Cereza",d:31,t:"30-35",cat:"Ni침o/Ni침a"},
                {c:"HY 038-1",m:"Croc Peque침os Dibujos",d:27,t:"24-29",cat:"Ni침o/Ni침a"},{c:"HY 039-1",m:"Croc Ni침a Mu침eca",d:29,t:"30-35",cat:"Ni침o/Ni침a"},{c:"RS 119",m:"Croc Ondulado Hello Kitty",d:27,t:"25-30",cat:"Ni침o/Ni침a"},
                {c:"RS 113",m:"Croc Perlas/Flores",d:33,t:"30-35",cat:"Ni침o/Ni침a"},{c:"HY 009-1",m:"Croc Bebidas/Frutas",d:33,t:"30-35",cat:"Ni침o/Ni침a"},{c:"HY 017-1",m:"Croc Bebe Flor/Estrella",d:27,t:"19-24",cat:"Ni침o/Ni침a"},
                {c:"HY 018-1",m:"Croc Forma Auto",d:30,t:"24-29",cat:"Ni침o/Ni침a"},{c:"HY 003-1",m:"Chancla Vaquita Ni침os",d:32,t:"30-35",cat:"Ni침o/Ni침a"},{c:"LC D-08-1",m:"Hawaiana Bebe Animales",d:29,t:"24-29",cat:"Ni침o/Ni침a"},
                {c:"LO 024",m:"Chancla Bob Esponja",d:33,t:"30-35",cat:"Ni침o/Ni침a"},{c:"RS A1",m:"Yeezy Kids Liso",d:28,t:"30-35",cat:"Ni침o/Ni침a"},{c:"LO 020",m:"Chancla Hello Kitty",d:26,t:"30-35",cat:"Ni침o/Ni침a"},
                {c:"HY 055-4",m:"Bota Lluvia Mo침o",d:36,t:"24-29",cat:"Ni침o/Ni침a"},{c:"HY 055-7",m:"Bota Lluvia Gato",d:40,t:"30-35",cat:"Ni침o/Ni침a"},{c:"HY 019",m:"Sandalia Vaquita Tela",d:39,t:"18-23",cat:"Ni침o/Ni침a"},
                {c:"HY 013-1",m:"Sandalia Bebe Tiras",d:27,t:"19-24",cat:"Ni침o/Ni침a"},{c:"HY 020-3",m:"Sandalia Sport Ni침a",d:50,t:"24-29",cat:"Ni침o/Ni침a"},{c:"HY 015-1",m:"Sandalia Hebilla Bebe",d:29,t:"25-30",cat:"Ni침o/Ni침a"},
                {c:"HY 030-3",m:"Sandalia Sport Print",d:55,t:"30-35",cat:"Ni침o/Ni침a"},{c:"HY 020-1",m:"Sandalia Sport Clasica",d:31,t:"24-29",cat:"Ni침o/Ni침a"},{c:"HY 026",m:"Sandalia Ositos",d:40,t:"30-35",cat:"Ni침o/Ni침a"},
                {c:"LO 078-5",m:"Sandalia Mariposa/Cadena",d:35,t:"24-29",cat:"Ni침o/Ni침a"},
                {c:"LC 01",m:"Croc Mario/Juegos",d:31,t:"30-35",cat:"Ni침o/Ni침a"},{c:"C-07",m:"Croc Dinosaurio",d:29,t:"30-35",cat:"Ni침o/Ni침a"},{c:"LC C-09",m:"Croc Raya Lateral",d:44,t:"24-29",cat:"Ni침o/Ni침a"},
                {c:"LC C-02",m:"Croc Personaje Urbano",d:32,t:"30-35",cat:"Ni침o/Ni침a"},{c:"LC D-08",m:"Hawaiana Ni침o",d:29,t:"24-29",cat:"Ni침o/Ni침a"},{c:"HY 017-2",m:"Croc Bebe Espacio",d:27,t:"19-24",cat:"Ni침o/Ni침a"},
                {c:"HY 018-2",m:"Croc Auto Gris/Azul",d:30,t:"24-29",cat:"Ni침o/Ni침a"},{c:"HY 038-2",m:"Croc Ni침o Dinosaurio",d:27,t:"24-29",cat:"Ni침o/Ni침a"},{c:"HY 009-2",m:"Croc Ni침o Oscuro",d:33,t:"30-35",cat:"Ni침o/Ni침a"},
                {c:"LO 043",m:"Chancla Ciudad",d:31,t:"24-29",cat:"Ni침o/Ni침a"},{c:"G 008B",m:"Chancla Oso Militar",d:31,t:"30-35",cat:"Ni침o/Ni침a"},{c:"LC D-55",m:"Sandalia Ni침o 3D",d:32,t:"24-29",cat:"Ni침o/Ni침a"},
                {c:"LC C-55",m:"Chancla Ni침o Dinosaurio/Pizza",d:33,t:"30-35",cat:"Ni침o/Ni침a"},{c:"HY 055-5",m:"Bota Lluvia Dino",d:36,t:"24-29",cat:"Ni침o/Ni침a"},{c:"HY 055-6",m:"Bota Lluvia Lobo",d:40,t:"30-35",cat:"Ni침o/Ni침a"},
                {c:"HY 013",m:"Sandalia Tiras Oscuras",d:27,t:"19-24",cat:"Ni침o/Ni침a"},{c:"HY 015",m:"Sandalia Hebilla Oscura",d:29,t:"25-30",cat:"Ni침o/Ni침a"},{c:"HY 020-5",m:"Sandalia Sport Oscura",d:52,t:"24-29",cat:"Ni침o/Ni침a"},
                {c:"HY 030-4",m:"Sandalia Sport Gris",d:55,t:"30-35",cat:"Ni침o/Ni침a"},{c:"HY 030-5",m:"Sandalia Sport Azul",d:55,t:"30-35",cat:"Ni침o/Ni침a"}
            ];

            const dbWithIDs = initialData.map((p,i)=>({...p, id:Date.now()+i, stock:72, p_unit:0}));
            
            dbRef.ref('inventory').set(dbWithIDs).then(()=>{
                db = dbWithIDs;
                Toast.show("춰Cat치logo del PDF Cargado Exitosamente!");
                setTimeout(()=>nav('pos', document.querySelector('.nav-item.active')), 1500);
            });
        }
        
        window.reloadInitialData = function(){
            if(confirm("쯉eguro que quieres restaurar la base de datos completa con los items del cat치logo PDF? Esto borrar치 modificaciones de stock actuales.")){
                saveInitialData();
            }
        }

        // --- INTERFAZ UI ---
        function applyConfig(){
            // Aplica los cambios visuales guardados
            document.documentElement.style.setProperty('--primary', config.color);
            document.getElementById('brandName').innerText = config.name; 
            document.getElementById('mobileTitleTxt').innerText = config.name.toUpperCase();
            
            // Subtitulo sidebar
            const subElem = document.getElementById('brandSubSidebar');
            if(subElem) subElem.innerText = config.sub;
            
            // Sidebar Footer
            const footElem = document.getElementById('footerBrand');
            if(footElem) footElem.innerText = "Sistema v9.2 - " + config.name;

            // Rellenar formulario de config
            document.getElementById('cfgName').value=config.name; 
            document.getElementById('cfgSub').value=config.sub;
            document.getElementById('cfgTel').value=config.tel; 
            document.getElementById('cfgCurrency').value=config.currency;
            document.getElementById('cfgFooter').value=config.footer; 
            document.getElementById('cfgColor').value=config.color;
            document.getElementById('cfgBanner').value=config.banner||""; 
            document.getElementById('cfgMaintenance').checked=config.maintenance||false;
            
            const b = document.getElementById('globalBanner'); 
            if(config.banner){ b.innerText=config.banner; b.style.display='block'; } else { b.style.display='none'; }
            
            // Logica del Logo
            if(config.logo){
                ['displayLogoSidebar', 'mobileLogoImg', 'printLogoDisplay', 'cfgLogoPreview'].forEach(id=>{
                    const el=document.getElementById(id); 
                    if(el){ 
                        el.src=config.logo; 
                        if(id!=='cfgLogoPreview') el.style.display='block'; 
                    }
                });
                document.getElementById('cfgLogoData').value=config.logo;
            } else {
               document.getElementById('displayLogoSidebar').style.display = 'none'; // Ocultar si no hay
            }
        }
        
        window.nav=(v,e)=>{ document.querySelectorAll('.view-panel').forEach(x=>x.classList.remove('active')); document.querySelectorAll('.nav-item').forEach(x=>x.classList.remove('active')); document.getElementById('view-'+v).classList.add('active'); e.classList.add('active'); if(v==='pos')window.updateAllViews(); }
        
        // --- FUNCI칍N RENDER POS OPTIMIZADA ---
        function renderPOS(){
            // Check Maintenance
            if(config.maintenance){ 
                document.getElementById('posGrid').innerHTML=`
                <div style="grid-column:1/-1; text-align:center; padding:50px;">
                    <i class="fa-solid fa-store-slash" style="font-size:3rem; color:#aaa;"></i>
                    <h3>Tienda Cerrada Temporalmente</h3>
                    <p>Estamos actualizando nuestro inventario. Vuelva pronto.</p>
                </div>`; 
                return;
            }

            const g=document.getElementById('posGrid'); 
            const txt=document.getElementById('searchInput').value.toLowerCase();
            
            // Normalizar categor칤as para filtro
            let targetCat = curFilter;
            const list=db.filter(p=>(p.c.toLowerCase().includes(txt)||p.m.toLowerCase().includes(txt))&&(targetCat==='all'||p.cat===targetCat));
            
            // --- ORDENAR SIEMPRE POR CATEGOR칈A ---
            list.sort((a, b) => a.cat.localeCompare(b.cat));

            if(list.length === 0){
                g.innerHTML = `<p style="grid-column:1/-1;text-align:center;color:#999;margin-top:20px;">No se encontraron productos.</p>`;
                return;
            }

            // --- OPTIMIZACI칍N DE PINTADO ---
            let htmlContent = "";

            list.forEach(p=>{
                const bg=p.cat==='Dama'?'#E91E63':(p.cat==='Caballero'?'#546E7A':'#FF9800');
                const img=p.img||`https://placehold.co/300x300/eee/333?text=${p.c}`;
                
                htmlContent += `
                <div class="card" onclick="openSale(${p.id})">
                    <div class="card-img-wrap">
                        <img src="${img}" loading="lazy">
                        <span class="badge-cat" style="background:${bg}">${p.cat.substring(0,4)}</span>
                    </div>
                    <div class="card-content">
                        <div>
                            <h4>${p.c}</h4>
                            <p>${p.m} <small>(${p.t})</small></p>
                        </div>
                        <div class="card-footer">
                            <span class="stock">Disp: ${p.stock}</span>
                            <span class="price">${config.currency}${p.d} <small style="font-size:0.6em;font-weight:400">/doc</small></span>
                        </div>
                    </div>
                </div>`;
            });
            
            g.innerHTML = htmlContent;
        }
        
        // --- CAMBIO: Filtros actualizan TODO ---
        window.filterCat=(c,el)=>{ curFilter=c; document.querySelectorAll('.chip').forEach(x=>x.classList.remove('active')); el.classList.add('active'); window.updateAllViews(); }
        window.toggleCart=()=>{ document.getElementById('cartDrawer').classList.toggle('open'); document.getElementById('mainOverlay').classList.toggle('active'); renderCart(); }
        
        // --- LOGICA DE VENTAS ---
        window.openSale=function(id){ 
            saleItem=db.find(x=>x.id==id); 
            document.getElementById('saleTitle').innerText = `${saleItem.c} - ${saleItem.m}`; 
            document.getElementById('saleId').value=id; 
            document.getElementById('saleQty').value=1; 
            window.setSaleType('doc'); 
            document.getElementById('modalSale').style.display='flex'; 
        }
        
        window.setSaleType=function(t){ 
            saleMode=t; 
            ['doc','half','unit'].forEach(x=>{
                document.getElementById('btn-'+x).style.background = x==t ? config.color : '#eee';
                document.getElementById('btn-'+x).style.color = x==t ? 'white' : '#333';
            }); 
            updateCalc(); 
        }
        
        window.updateCalc=function(){ 
            const q=parseInt(document.getElementById('saleQty').value)||1; 
            const cur=config.currency; 
            let p=0, txt=""; 
            
            if(saleMode==='doc'){ 
                p=saleItem.d; 
                txt=`Precio Docena: ${cur}${p}`; 
            } else if(saleMode==='half'){ 
                p=saleItem.d/2; 
                txt=`Precio Media Docena: ${cur}${p.toFixed(2)}`; 
            } else { 
                // CORRECCI칍N PRECIO UNITARIO (DIV 12)
                p = saleItem.d / 12; 
                txt=`Precio Unitario (Par): ${cur}${p.toFixed(2)}`; 
            } 
            
            document.getElementById('unitPriceDisplay').innerText = txt; 
            document.getElementById('saleTotalCalc').innerText = `${cur}${(p*q).toFixed(2)}`; 
        }
        
        window.adjQty=(n)=>{ 
            let v=parseInt(document.getElementById('saleQty').value)+n; 
            if(v<1)v=1; 
            document.getElementById('saleQty').value=v; 
            updateCalc(); 
        }
        
        window.confirmAdd=function(){ 
            const q=parseInt(document.getElementById('saleQty').value); 
            const t=parseFloat(document.getElementById('saleTotalCalc').innerText.replace(/[^0-9.]/g,''));
            
            // Texto para el recibo
            let typeLabel = saleMode==='doc' ? 'Docenas' : (saleMode==='half'?'Medias Doc':'Pares');
            let deduction = saleMode==='doc' ? 12*q : (saleMode==='half'?6*q:q); 
            
            cart.push({
                pId:saleItem.id, 
                c:saleItem.c, 
                m:saleItem.m, 
                qtyTxt:`${q} ${typeLabel}`, 
                total:t, 
                deduct: deduction
            });
            
            closeModal('modalSale'); 
            renderCart(); 
            toggleCart(); 
            Toast.show("Agregado al Carrito");
        }
        
        function renderCart(){ 
            const c=document.getElementById('cartContainer');
            c.innerHTML="";
            let t=0;
            if(cart.length==0) c.innerHTML="<div style='text-align:center;color:#999;padding:20px;'><i class='fa-solid fa-basket-shopping' style='font-size:2rem;'></i><br>Vac칤o</div>"; 
            
            cart.forEach((i,x)=>{
                t+=i.total;
                c.innerHTML+=`
                <div class="c-item">
                    <div style="flex:1"><b>${i.c}</b> <br><small>${i.qtyTxt} - ${i.m}</small></div>
                    <div style="text-align:right">
                        <b>${config.currency}${i.total.toFixed(2)}</b>
                        <i class="fa-solid fa-trash" style="color:#d32f2f;margin-left:10px;cursor:pointer;" onclick="cart.splice(${x},1);renderCart()"></i>
                    </div>
                </div>`
            });
            
            document.getElementById('cartTotalDisplay').innerText=`${config.currency}${t.toFixed(2)}`;
            document.getElementById('cartCountBadge').innerText=cart.length;
        }
        
        // ADMIN & PRINT
        // --- FUNCI칍N RENDER INV OPTIMIZADA Y FILTRABLE ---
        function renderInv(){ 
            const t=document.getElementById('invBody'); t.innerHTML=""; const c=config.currency; 
            
            // Leemos el buscador tambien aqu칤
            const txt = document.getElementById('searchInput').value.toLowerCase();
            let targetCat = curFilter;

            // Filtro aplicado a Inventario
            const list = db.filter(p => (p.c.toLowerCase().includes(txt) || p.m.toLowerCase().includes(txt)) && (targetCat === 'all' || p.cat === targetCat));
            
            // Ordenar por categor칤a
            list.sort((a, b) => a.cat.localeCompare(b.cat));

            if(list.length === 0){
                t.innerHTML = `<tr><td colspan="5" style="text-align:center; padding:20px; color:#999;">No hay resultados en Inventario</td></tr>`;
                return;
            }

            // String builder
            let htmlContent = "";

            list.forEach(p=>{ 
                const i=p.img||"https://placehold.co/50?text=?";
                const catBadge = `<span style="font-size:0.7em; background:#eee; padding:2px 4px; border-radius:4px; margin-left:5px;">${p.cat}</span>`;
                htmlContent+=`
                <tr>
                    <td><img src="${i}" class="thumb"></td>
                    <td><b>${p.c}</b>${catBadge}<br><small>${p.m}</small></td>
                    <td>${c}${p.d}</td>
                    <td>${p.stock} u.</td>
                    <td>
                        <button class="btn" style="background:#eee;color:#333;width:auto;padding:5px 10px;" onclick="openEdit(${p.id})"><i class="fa-solid fa-pen"></i></button>
                        <button class="btn" style="background:var(--primary);color:white;width:auto;padding:5px 10px;" onclick="delProd(${p.id})"><i class="fa-solid fa-trash"></i></button>
                    </td>
                </tr>`
            });
            
            t.innerHTML = htmlContent;
        }
        
        window.openEdit=(id)=>{ 
            const p=db.find(x=>x.id==id);
            document.getElementById('prodId').value=p.id; 
            document.getElementById('pCode').value=p.c; 
            document.getElementById('pModel').value=p.m;
            document.getElementById('pPrice').value=p.d;
            document.getElementById('pStock').value=p.stock;
            document.getElementById('pCat').value=p.cat; 
            document.getElementById('pSize').value=p.t || "Unica";
            document.getElementById('prodImgBase64').value=p.img||""; 
            if(p.img){ document.getElementById('imgPreview').src=p.img; document.getElementById('imgPreview').style.display='block'; }
            document.getElementById('modalProd').style.display='flex'; 
        }
        
        window.openModalProd=()=>{ 
            ['pCode','pModel','pPrice','pStock','prodImgBase64','pSize'].forEach(k=>document.getElementById(k).value=""); 
            document.getElementById('prodId').value="";
            document.getElementById('imgPreview').style.display='none'; 
            document.getElementById('modalProd').style.display='flex'; 
        }
        
        window.delProd=(id)=>{ if(confirm("쮼liminar este producto?")) dbRef.ref('inventory').set(db.filter(x=>x.id!=id)); }
        
        function renderHistory(){ const t=document.getElementById('histBody');t.innerHTML="";let g=0;const c=config.currency; history.forEach(h=>{ g+=h.total; t.innerHTML+=`<tr><td><small>${h.date.split(',')[0]}</small></td><td><b>${h.client}</b></td><td><button class="btn" style="padding:2px 8px;font-size:0.7rem;background:#eee;color:#333;width:auto;" onclick="alert('${h.desc}')">Ver Items</button></td><td>${c}${h.total}</td><td><i class="fa-solid fa-print" style="color:var(--primary);cursor:pointer;margin-right:10px;" onclick="reprint(${h.id})"></i> <i class="fa-solid fa-trash" style="color:#aaa;cursor:pointer;" onclick="delHist(${h.id})"></i></td></tr>`}); document.getElementById('grandTotalHistory').innerText=`${c}${g.toFixed(2)}`; }
        // Funci칩n para Borrar Historial y DEVOLVER STOCK
window.delHist = function(id) {
    if (!confirm("丘멆잺 쮼st치s seguro de ELIMINAR esta venta?\n\nAl hacerlo, los productos se devolver치n al inventario (Stock aumentar치) y la venta desaparecer치 de las cuentas.")) return;

    // 1. Buscar la venta espec칤fica en la base de datos (Nube)
    dbRef.ref('history').once('value').then(snapshot => {
        const historyData = snapshot.val();
        if (!historyData) return;

        let saleKey = null;
        let saleData = null;

        // Encontrar la llave y los datos usando el ID num칠rico
        for (const [key, value] of Object.entries(historyData)) {
            if (value.id === id) {
                saleKey = key;
                saleData = value;
                break;
            }
        }

        if (saleKey && saleData && saleData.items) {
            // 2. Devolver stock (Sumar cantidades)
            let updatedDb = [...db]; // Copia del inventario actual
            
            saleData.items.forEach(soldItem => {
                // Buscar el producto en el inventario actual
                const prodIndex = updatedDb.findIndex(p => p.id === soldItem.pId);
                
                if (prodIndex !== -1) {
                    // Si el producto aun existe, devolvemos la cantidad descontada originalmente
                    // nota: soldItem.deduct es la cantidad exacta de pares que se restaron
                    updatedDb[prodIndex].stock = parseInt(updatedDb[prodIndex].stock) + parseInt(soldItem.deduct);
                }
            });

            // 3. Guardar el Inventario Actualizado en la Nube
            dbRef.ref('inventory').set(updatedDb);

            // 4. Borrar el registro del historial permanentemente
            dbRef.ref('history/' + saleKey).remove()
                .then(() => {
                    Toast.show("Venta eliminada y Stock devuelto", "success");
                    // Refrescar visualmente (El onValue lo har치 autom치tico, pero forzamos por seguridad visual)
                    renderInv();
                })
                .catch(err => alert("Error al borrar: " + err.message));
                
        } else {
            alert("No se encontraron los datos de la venta o no tiene productos asociados.");
        }
    });
}
        window.clearHistory=()=>{ if(confirm("丘멆잺 쮹ORRAR TODO EL HISTORIAL DE VENTAS? Esto no se puede deshacer.")) dbRef.ref('history').set(null); }
        window.reprint=(id)=>{const h=history.find(x=>x.id==id);if(h)printFromData(h,true);}
        
        function printFromData(rec,cp=false){
            // Asigna valores al layout de impresi칩n
            document.getElementById('printBrand').innerText=config.name; 
            document.getElementById('printSub').innerText=config.sub;
            document.getElementById('printTel').innerText="Tel: " + config.tel; 
            document.getElementById('printDate').innerText=rec.date;
            document.getElementById('printFooter').innerText=config.footer;
            document.getElementById('printClientBlock').innerHTML=`<strong style="font-size:1.1em">${rec.client}</strong><br>Tel: ${rec.phone||'N/A'}<br>ID Venta: #${rec.id.toString().slice(-6)}`;
            
            const logoEl = document.getElementById('printLogoDisplay');
            if(config.logo){ logoEl.src=config.logo; logoEl.style.display='block'; } else { logoEl.style.display='none'; }
            
            const t=document.getElementById('printBody'); t.innerHTML="";
            rec.items.forEach(i=>{
                t.innerHTML+=`<tr>
                    <td style="padding:5px;border-bottom:1px solid #eee;">${i.qtyTxt}</td>
                    <td style="padding:5px;border-bottom:1px solid #eee;">${i.c} <small>(${i.m})</small></td>
                    <td style="padding:5px;border-bottom:1px solid #eee;text-align:right;">${config.currency}${i.total.toFixed(2)}</td>
                </tr>`
            });
            
            document.getElementById('printTotal').innerText=`${config.currency}${rec.total.toFixed(2)}`;
            setTimeout(()=>window.print(),500);
        }

        window.previewColor=(c)=>{
            document.documentElement.style.setProperty('--primary',c);
        }
        window.closeModal=(id)=>{document.getElementById(id).style.display='none'}
        
        const Toast={show:(m,t='s')=>{const d=document.createElement('div');d.className=`toast ${t}`;d.innerHTML=`<i class="fa-solid fa-check-circle"></i> ${m}`;document.getElementById('toast-container').appendChild(d);setTimeout(()=>d.remove(),3000)}}
        
        window.onclick=e=>{if(e.target.className==='modal')e.target.style.display='none'}
    </script>
</body>
</html>







