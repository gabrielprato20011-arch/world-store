<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>World Store V9.6 - Cloud Optimizado</title>

    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;600;700;800&display=swap" rel="stylesheet">

   <style>
        :root {
            /* Colores Refinados */
            --primary: #D32F2F; 
            --primary-light: #FFEBEE;
            --dark: #1e1e2d;
            --dark-light: #2d2d44;
            --bg: #f3f5f9;
            --text-main: #3F4254;
            --text-muted: #B5B5C3;
            --white: #ffffff;

            --sidebar-width: 270px;
            --nav-height-mobile: 70px;
            --radius: 12px;
            --shadow-soft: 0 5px 20px rgba(0,0,0,0.03);
            --shadow-hover: 0 10px 25px rgba(0,0,0,0.06);
        }

        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }

        body { 
            margin: 0; 
            font-family: 'Montserrat', sans-serif; 
            background: var(--bg); 
            color: var(--text-main); 
            height: 100vh; height: 100dvh; 
            overflow: hidden; 
            display: flex; 
            overscroll-behavior: none; 
        }

        /* --- SIDEBAR --- */
        aside { 
            width: var(--sidebar-width); 
            background: var(--dark); 
            color: white; 
            display: flex; 
            flex-direction: column; 
            height: 100%; 
            z-index: 50; 
            box-shadow: 5px 0 20px rgba(0,0,0,0.05); 
            transition: 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
        }

        .brand { padding: 35px 20px; text-align: center; }
        #displayLogoSidebar { 
            width: 80px; height: 80px; 
            object-fit: contain; 
            border-radius: 50%; 
            margin: 0 auto 15px auto; 
            background: white; 
            border: 4px solid rgba(255,255,255,0.1); 
            display: none; 
            padding: 5px;
        }

        .brand h1 { margin: 0; font-size: 1.3rem; font-weight: 800; letter-spacing: 0.5px; text-transform: uppercase;}
        .brand small { color: rgba(255,255,255,0.5); font-weight: 500; font-size: 0.75rem; letter-spacing: 1px;}

        .nav-menu { flex: 1; padding: 20px 10px; overflow-y: auto; }

        .nav-item { 
            padding: 16px 20px; 
            cursor: pointer; 
            display: flex; 
            align-items: center; 
            gap: 15px; 
            color: #8c8c9e; 
            transition: all 0.2s; 
            font-size: 0.9rem; 
            border-radius: var(--radius);
            margin-bottom: 5px;
            font-weight: 500;
        }

        .nav-item i { font-size: 1.1rem; width: 25px; text-align: center; }

        .nav-item:hover { background: rgba(255,255,255,0.03); color: white; }

        .nav-item.active { 
            background: var(--primary); 
            color: white; 
            font-weight: 600; 
            box-shadow: 0 4px 15px rgba(211, 47, 47, 0.3);
        }

        .sys-info { padding: 20px; font-size: 0.7rem; text-align: center; color: rgba(255,255,255,0.3); border-top: 1px solid rgba(255,255,255,0.05); }

        /* --- MAIN AREA --- */
        main { flex: 1; position: relative; display: flex; flex-direction: column; overflow: hidden; width: 100%; height: 100%; }

        #globalBanner {
            display: none; background: #fff8e1; color: #8d6e16; text-align: center; 
            padding: 10px; font-weight: 700; font-size: 0.85rem; width: 100%; 
            border-bottom: 1px solid #ffeeba;
        }

        header { 
            height: 80px; background: rgba(255,255,255,0.9); 
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(0,0,0,0.05); 
            display: flex; align-items: center; justify-content: space-between; 
            padding: 0 30px; gap: 20px; flex-shrink: 0; z-index: 40;
        }

        .mobile-brand { display: none; align-items: center; gap: 10px; }
        .mobile-brand img { width: 40px; height: 40px; border-radius: 50%; object-fit: contain; background: white; box-shadow: 0 2px 5px rgba(0,0,0,0.1);}

        /* SEARCH BAR */
        .search-wrap { position: relative; flex: 1; max-width: 450px; }
        .search-wrap input { 
            width: 100%; padding: 12px 20px 12px 45px; 
            border-radius: 50px; border: 2px solid transparent; 
            background: #eef0f8; font-size: 0.9rem; font-weight: 500;
            color: var(--dark); transition: 0.2s;
        }
        .search-wrap input:focus { background: white; border-color: var(--primary); box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .search-wrap input::placeholder { color: #a1a5b7; }
        .search-wrap i { position: absolute; left: 18px; top: 50%; transform: translateY(-50%); color: #a1a5b7; }

        /* FILTERS */
        .filter-group { display: flex; gap: 8px; overflow-x: auto; scrollbar-width: none; align-items: center; }
        .chip { 
            padding: 8px 18px; border-radius: 50px; font-size: 0.8rem; font-weight: 600; cursor: pointer; 
            background: white; border: 1px solid #e1e3ea; color: #7e8299; transition:0.2s;
        }
        .chip:hover { border-color: var(--text-muted); }
        .chip.active { background: var(--dark); color: white; border-color: var(--dark); box-shadow: 0 4px 10px rgba(0,0,0,0.15); }

        /* --- VISTAS --- */
        .view-panel { padding: 25px 30px; flex: 1; overflow-y: auto; display: none; padding-bottom: 100px; }
        .view-panel.active { display: block; animation: fadeIn 0.4s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- GRID DE PRODUCTOS (Modern Card) --- */
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 20px; }
        .card { 
            background: white; border-radius: 16px; overflow: hidden; 
            border: none; box-shadow: var(--shadow-soft); cursor: pointer; 
            display: flex; flex-direction: column; height: 100%; position: relative;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .card:hover { transform: translateY(-5px); box-shadow: var(--shadow-hover); }

        .card-img-wrap { 
            height: 160px; background: #f9f9f9; display: flex; 
            justify-content: center; align-items: center; position: relative; overflow: hidden; 
        }
        .card-img-wrap img { width: 100%; height: 100%; object-fit: cover; transition: transform 0.4s;}
        .card:hover .card-img-wrap img { transform: scale(1.05); }

        .badge-cat { 
            position: absolute; top: 10px; right: 10px; padding: 4px 10px; 
            border-radius: 20px; color: white; font-size: 0.65rem; font-weight: 700; 
            text-transform: uppercase; box-shadow: 0 3px 8px rgba(0,0,0,0.15); 
            backdrop-filter: blur(4px); z-index: 2;
        }

        .card-content { padding: 15px; flex: 1; display: flex; flex-direction: column; justify-content: space-between; gap: 8px;}
        .card h4 { margin: 0; font-size: 0.95rem; color: var(--text-main); font-weight: 700; line-height: 1.3; }
        .card p { margin: 0; font-size: 0.8rem; color: #7e8299; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; }

        .card-footer { display: flex; justify-content: space-between; align-items: flex-end; margin-top: auto; padding-top: 10px; border-top: 1px dashed #eff2f5;}
        .price { color: var(--primary); font-weight: 800; font-size: 1.1rem; }
        .stock { 
            font-size: 0.65rem; background: #E8F5E9; color: #2E7D32; 
            padding: 4px 8px; border-radius: 6px; font-weight: 700; letter-spacing: 0.5px; 
        }

        /* --- TABLES (Clean Style) --- */
        .table-wrap { 
            background: white; 
            border-radius: 16px; 
            overflow-x: auto; 
            -webkit-overflow-scrolling: touch; 
            box-shadow: var(--shadow-soft); 
            border: 1px solid rgba(0,0,0,0.02);
            width: 100%; 
        }
        table { width: 100%; border-collapse: collapse; font-size: 0.9rem; min-width: 600px; }
        thead { background: #f9f9f9; color: var(--text-muted); text-transform: uppercase; font-size: 0.75rem; letter-spacing: 1px; font-weight: 700; }
        th { padding: 15px 20px; text-align: left; }
        td { padding: 15px 20px; border-bottom: 1px solid #f0f0f0; color: var(--text-main); font-weight: 500;}
        tr:last-child td { border-bottom: none; }
        tr:hover td { background: #fbfbfb; }

        .thumb { width: 45px; height: 45px; border-radius: 8px; object-fit: cover; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }

        /* --- BOTONES Y FORMULARIOS --- */
        .btn { padding: 12px 20px; border-radius: 10px; border:none; cursor: pointer; font-weight: 700; width: 100%; transition: all 0.2s; display: inline-flex; justify-content: center; align-items: center; gap: 8px; font-size: 0.9rem; letter-spacing: 0.3px;}
        .btn:hover { transform: translateY(-2px); filter: brightness(110%); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .btn:active { transform: scale(0.97); }

        .btn-primary { background: linear-gradient(145deg, var(--dark), #2c2c3e); color: white; }
        .btn-success { background: linear-gradient(145deg, #2E7D32, #43A047); color: white; box-shadow: 0 5px 15px rgba(46, 125, 50, 0.3); }
        .btn-danger { background: linear-gradient(145deg, #C62828, #E53935); color: white; box-shadow: 0 5px 15px rgba(198, 40, 40, 0.3);}
        .btn-blue { background: linear-gradient(145deg, #1565C0, #1E88E5); color: white; }

        .btn-warning { background: linear-gradient(145deg, #FFB300, #FFD54F); color: #3e2723; }

        input, select { 
            width: 100%; padding: 12px 15px; border: 1px solid #e1e3ea; border-radius: 10px; 
            font-size: 0.9rem; color: var(--text-main); background: #fff; transition: 0.2s;
            font-family: 'Montserrat', sans-serif;
        }
        input:focus, select:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(198, 40, 40, 0.1); }

        /* --- CART & MODALS --- */
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 900; display: none; backdrop-filter: blur(4px); opacity: 0; transition: opacity 0.3s;}
        .overlay.active { display: block; opacity: 1; }

        .cart-drawer { 
            position: fixed; top: 0; right: -500px; width: 450px; height: 100%; 
            background: white; z-index: 1100; transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1); 
            display: flex; flex-direction: column; box-shadow: -10px 0 40px rgba(0,0,0,0.15); 
        }
        .cart-drawer.open { transform: translateX(-500px); }

        .cart-items { flex: 1; overflow-y: auto; padding: 20px; }
        .c-item { 
            display: flex; gap: 15px; padding: 15px; border: 1px solid #f0f0f0; 
            border-radius: 12px; margin-bottom: 12px; align-items: center; background: white; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.02);
        }

        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 2000; display: none; align-items: center; justify-content: center; padding: 20px; backdrop-filter: blur(4px); }
        .modal-box { 
            background: white; width: 500px; max-width: 100%; padding: 30px; 
            border-radius: 20px; position: relative; max-height: 90vh; overflow-y: auto; 
            box-shadow: 0 20px 60px rgba(0,0,0,0.3); animation: zoomIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); 
        }
        @keyframes zoomIn { from { transform: scale(0.9); opacity: 0; } to { opacity: 1; transform: scale(1); } }

        /* UPLOADERS & CONFIG */
        .file-upload { border: 2px dashed #d1d4db; padding: 30px; text-align: center; border-radius: 16px; cursor: pointer; margin-top: 15px; background: #fafafa; transition:0.2s; position:relative; }
        .file-upload:hover { border-color: var(--primary); background: var(--primary-light); }

        .config-card { background: white; padding: 25px; border-radius: 16px; box-shadow: var(--shadow-soft); margin-bottom: 20px; }
        .section-title { font-weight: 800; color: var(--dark); border-bottom: 1px solid #f0f0f0; padding-bottom: 10px; margin-bottom: 20px; font-size: 1rem; text-transform: uppercase; letter-spacing: 0.5px;}
        .profit-row { display: flex; align-items: center; padding: 10px; border-bottom: 1px solid #eee; gap:10px; font-size:0.9rem; }
        .profit-row input { padding: 8px; width: 100px; text-align: center; border: 1px solid #ccc; border-radius: 6px; }

        #loader { position: fixed; top:0; left:0; width:100%; height:100%; background:white; z-index:9999; display:flex; justify-content:center; align-items:center; flex-direction:column; }
        .spinner { width:50px; height:50px; border:5px solid #f3f3f3; border-top-color:var(--primary); border-radius:50%; animation:spin 1s cubic-bezier(0.55, 0.055, 0.675, 0.19) infinite; }

        /* MOBILE TWEAKS */
        @media (max-width: 768px) {
            body { flex-direction: column; }
            aside { position: fixed; bottom: 0; left: 0; width: 100%; height: var(--nav-height-mobile); flex-direction: row; justify-content: space-around; padding: 0 10px; background: white; border-top: 1px solid #f0f0f0; z-index: 1000; box-shadow: 0 -5px 20px rgba(0,0,0,0.05); }
            .brand, .sys-info { display: none; }
            .nav-menu { display: flex; flex-direction: row; width: 100%; padding: 0; justify-content: space-between; align-items: center; }
            .nav-item { flex-direction: column; justify-content: center; padding: 8px 5px; flex: 1; border-radius: 10px; margin: 0; background: transparent; gap: 5px; font-size: 0.7rem; color: #999; }
            .nav-item i { font-size: 1.2rem; margin-bottom: 0; }
            .nav-item.active { background: var(--primary-light); color: var(--primary); box-shadow: none;}

            main { height: calc(100vh - var(--nav-height-mobile)); }
            header { padding: 10px 15px; height: auto; flex-wrap: wrap; gap: 10px; }
            .mobile-brand { display: flex; }
            .search-wrap { width: 100%; max-width: none; order: 3; }
            .filter-group { width: 100%; order: 4; padding-bottom: 5px; }
            .grid { grid-template-columns: 1fr 1fr; gap: 15px; padding: 5px;}
            .cart-drawer { width: 100%; right: -100%; }
            .cart-drawer.open { transform: translateX(-100%); }
        }

        @keyframes spin { 100% { transform:rotate(360deg); } }
        #print-layer { display: none; }

    @media print { 
        body > *:not(#print-layer) { display: none !important; } 
        #print-layer { display: block !important; position: absolute; top: 0; left: 0; width: 100%; z-index: 99999; background: white; min-height: 100vh;} 
        @page { margin: 5mm; } 
    }

    </style>
</head>

<body>
<!-- LOGIN OVERLAY -->
    <div id="loginOverlay" style="position:fixed; top:0; left:0; width:100%; height:100%; background:var(--dark); z-index:10000; display:flex; flex-direction:column; align-items:center; justify-content:center; color:white;">
        <div style="background:white; padding:5px; border-radius:50%; margin-bottom:20px;">
            <img id="loginLogo" src="https://placehold.co/100?text=WS" style="width:90px; height:90px; border-radius:50%; object-fit:contain; border:2px solid #eee;">
        </div>
        <h2 style="margin:0 0 5px 0; text-transform:uppercase; letter-spacing:2px; text-align:center;">Acceso Restringido</h2>
        <p style="color:#aaa; margin-bottom:30px; font-size:0.9rem;">Sistema Privado World Store</p>
        
        <div style="background:white; padding:30px; border-radius:16px; width:320px; max-width:90%; color:#333; text-align:center; box-shadow:0 10px 40px rgba(0,0,0,0.5);">
            <input type="email" id="txtEmail" placeholder="Correo Administrativo" style="margin-bottom:15px; border:1px solid #ddd; background:#f9f9f9; width:100%; padding:12px; border-radius:8px;">
            <input type="password" id="txtPass" placeholder="Contrase침a" style="margin-bottom:20px; border:1px solid #ddd; background:#f9f9f9; width:100%; padding:12px; border-radius:8px;">
            <button class="btn btn-primary" onclick="appLogin()" id="btnLogin" style="width:100%; font-size:1rem;">INGRESAR</button>
            <p id="loginError" style="color:#d32f2f; font-size:0.8rem; margin-top:15px; display:none; font-weight:bold;"></p>
        </div>
    </div>
    <div id="loader">
        <div class="spinner"></div>
        <p style="margin-top:15px; color:#555; font-weight:bold;">Sincronizando Sistema...</p>
    </div>
    <div id="toast-container"></div>
    <div class="overlay" id="mainOverlay" onclick="toggleCart()" style="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:900;display:none;backdrop-filter:blur(3px);"></div>

    <!-- SIDEBAR -->
    <aside>
        <div class="brand">
            <img id="displayLogoSidebar" src="" alt="Logo">
            <h1 id="brandName">WORLD STORE</h1>
            <small id="brandSubSidebar">Gesti칩n en la Nube</small>
        </div>
        <div class="nav-menu">
            <div class="nav-item active" onclick="nav('pos', this)"><i class="fa-solid fa-store"></i> <span>Cat치logo</span></div>
            <div class="nav-item" onclick="nav('history', this)"><i class="fa-solid fa-receipt"></i> <span>Ventas</span></div>
            <div class="nav-item" onclick="nav('profit', this)"><i class="fa-solid fa-chart-line"></i> <span>Ganancias</span></div>
            <div class="nav-item" onclick="nav('inv', this)"><i class="fa-solid fa-boxes-stacked"></i> <span>Inventario</span></div>
            <div class="nav-item" onclick="toggleCart()"><i class="fa-solid fa-cart-shopping"></i> <span>Carrito <b id="cartCountBadge" style="background:var(--primary); color:white; padding:1px 6px; border-radius:10px; font-size:0.7em;">0</b></span></div>
            <div class="nav-item" onclick="nav('config', this)"><i class="fa-solid fa-sliders"></i> <span>Configuraci칩n</span></div>
        </div>
        <div class="sys-info"><span id="footerBrand">SISTEMA v9.6</span></div>
    </aside>

    <main>
        <div id="globalBanner"></div>
        <header>
            <div class="mobile-brand">
                <img id="mobileLogoImg" src="" style="display:none;">
                <h2 id="mobileTitleTxt">WORLD STORE</h2>
            </div>
            <div class="search-wrap">
                <i class="fa-solid fa-magnifying-glass"></i>
                <input type="text" id="searchInput" placeholder="Buscar modelo, c칩digo..." onkeyup="searchDelay()">
            </div>
            <div class="filter-group">
                <div class="chip active" onclick="filterCat('all', this)">Todo</div>
                <div class="chip" onclick="filterCat('Ni침o/Ni침a', this)">Infantil</div>
                <div class="chip" onclick="filterCat('Dama', this)">Dama</div>
                <div class="chip" onclick="filterCat('Caballero', this)">Caballero</div>
            </div>
        </header>

        <!-- POS (Catalogo) -->
        <div id="view-pos" class="view-panel active">
            <div class="grid" id="posGrid"></div>
        </div>

        <!-- HISTORY -->
        <div id="view-history" class="view-panel">
            <div style="background:white; padding:20px; border-radius:12px; margin-bottom:20px; box-shadow:0 2px 10px rgba(0,0,0,0.05); display:flex; justify-content:space-between;">
                <div><h3 style="margin:0">Registro de Ventas</h3><small>Historial en Tiempo Real</small></div>
                <div style="text-align:right;"><div style="font-size:0.8rem;color:#777">Total Recaudado</div><div style="font-size:1.5rem;font-weight:800;color:var(--primary)" id="grandTotalHistory">$0.00</div></div>
            </div>
            <div class="table-wrap">
                <table>
                    <thead><tr><th>Fecha</th><th>Cliente</th><th>Detalle</th><th>Total</th><th></th></tr></thead>
                    <tbody id="histBody"></tbody>
                </table>
            </div>
            <br><button class="btn btn-danger" onclick="clearHistory()"><i class="fa-solid fa-trash-can"></i> Limpiar Historial Local y Nube</button>
        </div>

        <!-- INVENTORY -->
        <div id="view-inv" class="view-panel">
            <div style="display:flex; justify-content:space-between; margin-bottom:20px; align-items:center;">
                <h3>Inventario de Productos</h3>
                <button class="btn btn-success" style="width:auto;" onclick="openModalProd()">+ Nuevo Producto</button>
            </div>
            <div class="table-wrap">
                <table>
                    <thead><tr><th>Img</th><th>C칩digo / Modelo</th><th>Precio (Docena)</th><th>Stock</th><th></th></tr></thead>
                    <tbody id="invBody"></tbody>
                </table>
            </div>
        </div>

        <!-- CONFIG -->
        <div id="view-config" class="view-panel">
            <div class="settings-header"><i class="fa-solid fa-sliders"></i> Personalizaci칩n del Sistema</div>

            <!-- MODULO DE COSTOS -->
            <div class="config-card">
                <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #f0f0f0; margin-bottom:20px; padding-bottom:10px;">
                    <div class="section-title" style="margin:0; border:none;"><i class="fa-solid fa-file-invoice-dollar"></i> Costos y Ganancias</div>
                    <!-- BOT칍N IMPORTANTE PARA EL USUARIO -->
                    <button class="btn btn-warning" onclick="loadDefaultProfitList()" style="width:auto; font-size:0.75rem; padding:5px 10px;">丘멆잺 Cargar Lista Nueva (PDF)</button>
                </div>
                
                <p style="font-size:0.85rem; color:#666; margin-bottom:15px;">Tabla de ganancia neta por docena para el c치lculo de utilidades.</p>
                
                <div class="search-wrap" style="width:100%; max-width:100%; margin-bottom:15px; background:white;">
                    <i class="fa-solid fa-search"></i>
                    <input type="text" id="profitSearchInput" placeholder="Buscar c칩digo en tabla..." onkeyup="renderProfitConfigTable()">
                </div>

                <div style="max-height: 400px; overflow-y: auto; border:1px solid #eee; border-radius:8px; margin-bottom:15px;">
                    <table style="width:100%;" id="profitConfigTable">
                        <thead style="position:sticky; top:0; background:#f9f9f9; z-index:5;">
                            <tr><th style="padding:10px;">C칩digo</th><th style="padding:10px; text-align:right;">Ganancia/Docena ($)</th></tr>
                        </thead>
                        <tbody id="profitConfigBody"></tbody>
                    </table>
                </div>
                <button class="btn btn-success" onclick="saveProfitTable()"><i class="fa-solid fa-save"></i> GUARDAR CAMBIOS</button>
            </div>

            <div class="config-card">
                <div class="section-title">Identidad Visual</div>
                <div class="form-row">
                    <label>Logo de la Empresa</label>
                    <div style="border:1px solid #ddd; padding:15px; border-radius:8px; display:flex; align-items:center; gap:15px; background:#f9f9f9;">
                        <img id="cfgLogoPreview" src="https://placehold.co/100x100?text=LOGO" style="width:60px; height:60px; object-fit:contain; background:white; border-radius:50%; border:2px solid #eee; box-shadow:0 2px 5px rgba(0,0,0,0.1);">
                        <div style="flex:1;">
                            <input type="file" accept="image/*" id="logoUploader" style="display:none" onchange="compressAndPreview(this.files[0], 'cfgLogoPreview', 'cfgLogoData')">
                            <button class="btn btn-blue" style="width:auto; padding:8px 15px;" onclick="document.getElementById('logoUploader').click()">
                                <i class="fa-solid fa-cloud-arrow-up"></i> Cambiar Logo
                            </button>
                            <input type="hidden" id="cfgLogoData">
                        </div>
                    </div>
                </div>

                <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px;">
                    <div class="form-row"><label>Nombre Empresa</label><input type="text" id="cfgName" placeholder="WORLD STORE"></div>
                    <div class="form-row"><label>Subt칤tulo / Eslogan</label><input type="text" id="cfgSub" placeholder="Mayoristas..."></div>
                </div>
                <div class="form-row"><label>Color Tema</label><input type="color" id="cfgColor" style="height:45px;width:100%;padding:2px;cursor:pointer;" oninput="previewColor(this.value)"></div>
            </div>

            <div class="config-card">
                <div class="section-title">Facturaci칩n & Estado</div>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px;">
                    <div class="form-row"><label>Tel칠fono</label><input type="tel" id="cfgTel"></div>
                    <div class="form-row"><label>Moneda</label><input type="text" id="cfgCurrency"></div>
                </div>
                <div class="form-row"><label>Pie de Factura</label><input type="text" id="cfgFooter"></div>
                <div class="form-row"><label>Banner Global</label><input type="text" id="cfgBanner" placeholder="Anuncio importante..."></div>
                <label class="checkbox-wrap"><input type="checkbox" id="cfgMaintenance"><span>Modo Mantenimiento (Cerrado)</span></label>
            </div>
            
            <button class="btn btn-primary" style="padding:15px; font-size:1.1rem;" onclick="window.saveConfig()"><i class="fa-solid fa-floppy-disk"></i> GUARDAR CONFIGURACI칍N</button>
            <br><br>
        </div>

        <!-- VIEW PROFIT -->
        <div id="view-profit" class="view-panel">
            <div style="background:white; padding:20px; border-radius:16px; margin-bottom:20px; box-shadow:var(--shadow-soft); display:flex; justify-content:space-between; align-items:center;">
                <div><h3 style="margin:0; color:var(--dark);">Reporte de Ganancias</h3><small style="color:#777;">Utilidad Neta Total</small></div>
                <div style="text-align:right;">
                    <div style="font-size:0.8rem;color:#777">Ganancia Est.</div>
                    <div style="font-size:1.8rem;font-weight:800;color:#2E7D32" id="totalProfitDisplay">$0.00</div>
                </div>
            </div>
            <div class="table-wrap">
                <table>
                    <thead><tr><th>Fecha</th><th>Cliente / Venta</th><th>Items</th><th style="text-align:right">Total</th><th style="text-align:right; color:#2E7D32">Ganancia</th></tr></thead>
                    <tbody id="profitBody"></tbody>
                </table>
            </div>
        </div>
    </main>

    <!-- DRAWER & MODALS (Id칠nticos para mantener compatibilidad) -->
    <div id="cartDrawer" class="cart-drawer">
        <div style="padding:15px; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center;">
            <h3 style="margin:0">游 Tu Pedido</h3>
            <button onclick="toggleCart()" style="background:none; border:none; font-size:1.5rem; padding:10px;">&times;</button>
        </div>
        <div class="cart-items" id="cartContainer"></div>
        <div class="cart-total-bar">
            <div class="client-inputs">
                <input type="text" id="cartClientName" placeholder="Nombre Cliente *">
                <input type="tel" id="cartClientPhone" placeholder="Tel칠fono Contacto" inputmode="tel">
            </div>
            <div style="display:flex; justify-content:space-between; margin-bottom:15px; font-size:1.2rem; font-weight:bold;"><span>Total</span><span id="cartTotalDisplay" style="color:var(--primary)">$0.00</span></div>
            <button class="btn btn-success w-100" onclick="window.processSale()" style="padding:15px;font-size:1.1rem;">CONFIRMAR VENTA</button>
        </div>
    </div>

    <div id="modalSale" class="modal">
        <div class="modal-box">
            <h3 id="saleTitle" style="margin-top:0;">Producto</h3>
            <input type="hidden" id="saleId">
            <div style="background:#f9f9f9; padding:15px; border-radius:8px; margin:10px 0; text-align:center;">
                <label style="display:block;margin-bottom:5px;font-weight:bold;font-size:0.8rem;">Seleccione Cantidad por:</label>
                <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:5px;">
                    <button class="btn" style="font-size:0.75rem; padding:8px 2px;" id="btn-doc" onclick="setSaleType('doc')">DOCENA</button>
                    <button class="btn" style="font-size:0.75rem; padding:8px 2px; background:#eee;" id="btn-half" onclick="setSaleType('half')">MEDIA</button>
                    <button class="btn" style="font-size:0.75rem; padding:8px 2px; background:#eee;" id="btn-unit" onclick="setSaleType('unit')">PAR</button>
                </div>
                <div id="unitPriceDisplay" style="margin-top:10px; font-weight:600; color:#555;"></div>
            </div>
            <div style="display:flex; gap:10px; margin-bottom:20px; align-items:center;">
                <button class="btn" style="background:#eee; font-size:1.5rem; width:60px;" onclick="adjQty(-1)">-</button>
                <input type="number" id="saleQty" value="1" min="1" inputmode="decimal" style="flex:1; text-align:center; padding:12px; font-size:1.3rem; border:1px solid #ddd; border-radius:8px; font-weight:bold;" onchange="updateCalc()">
                <button class="btn" style="background:#eee; font-size:1.5rem; width:60px;" onclick="adjQty(1)">+</button>
            </div>
            <div style="text-align:right; font-size:2rem; font-weight:800; color:var(--primary); margin-bottom:20px;"><span id="saleTotalCalc">$0.00</span></div>
            <div style="display:flex; gap:10px;">
                <button class="btn" style="background:#eee; flex:1;" onclick="closeModal('modalSale')">Cancelar</button>
                <button class="btn btn-success" style="flex:2;" onclick="confirmAdd()">AGREGAR AL PEDIDO</button>
            </div>
        </div>
    </div>

    <div id="modalProd" class="modal">
        <div class="modal-box">
            <h3 id="modalProdTitle" style="margin-top:0;">Gesti칩n de Producto</h3>
            <input type="hidden" id="prodId"><input type="hidden" id="prodImgBase64">
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                <div style="grid-column:span 2"><label>Nombre / Modelo</label><input type="text" id="pModel"></div>
                <div><label>C칩digo</label><input type="text" id="pCode"></div>
                <div><label>Categor칤a</label><select id="pCat"><option>Dama</option><option>Caballero</option><option>Ni침o/Ni침a</option></select></div>
                <div><label>Precio Docena</label><input type="number" id="pPrice" inputmode="decimal"></div>
                <div><label>Stock Paquetes</label><input type="number" id="pStock" inputmode="numeric"></div>
                <div style="grid-column:span 2"><label>Tallas (Ej: 35-40)</label><input type="text" id="pSize"></div>
            </div>
            <div class="file-upload" id="dropZone" onclick="document.getElementById('fileInput').click()">
                <span style="color:#aaa;"><i class="fa-solid fa-camera"></i> Toca para subir foto</span>
                <img id="imgPreview">
                <input type="file" id="fileInput" accept="image/*" style="display:none" onchange="compressAndPreview(this.files[0], 'imgPreview', 'prodImgBase64')">
            </div>
            <div style="margin-top:20px; display:flex; gap:10px;">
                <button class="btn btn-danger" onclick="closeModal('modalProd')">Cancelar</button>
                <button class="btn btn-success" onclick="window.saveProduct()">GUARDAR CAMBIOS</button>
            </div>
        </div>
    </div>

    <div id="print-layer">
        <div style="width:100%;max-width:800px;margin:0 auto;color:black;font-family:sans-serif;font-size:14px;">
            <div style="border-bottom:2px solid #000;padding-bottom:10px;margin-bottom:15px;display:flex;justify-content:space-between; align-items:center;">
                <div style="display:flex; align-items:center; gap:15px;">
                    <img id="printLogoDisplay" style="height:70px;width:70px;object-fit:contain;display:none;">
                    <div><h1 id="printBrand" style="margin:0;font-size:22px;text-transform:uppercase;"></h1><div id="printSub" style="font-weight:bold; color:#555;"></div><div id="printTel" style="font-size:12px;"></div></div>
                </div>
                <div style="text-align:right;"><h2 style="color:black;margin:0;">NOTA DE ENTREGA</h2><div style="margin-top:5px;">Fecha: <span id="printDate"></span></div></div>
            </div>
            <div id="printClientBlock" style="border:1px solid #ccc; padding:10px; margin-bottom:20px; border-radius:4px; background:#f9f9f9;"></div>
            <table style="width:100%;border-collapse:collapse;margin-bottom:20px;"><thead><tr style="background:#eee;font-weight:bold;text-transform:uppercase;font-size:12px;"><th style="padding:8px;text-align:left;">Cant.</th><th style="padding:8px;text-align:left;">Descripci칩n</th><th style="padding:8px;text-align:right;">Subtotal</th></tr></thead><tbody id="printBody"></tbody></table>
            <div style="text-align:right;font-size:20px;font-weight:bold;border-top:2px solid #000;padding-top:10px;">TOTAL: <span id="printTotal"></span></div>
            <div id="printFooter" style="text-align:center;font-size:12px;margin-top:40px;color:#555;font-style:italic;"></div>
        </div>
    </div>

    <!-- SCRIPTS -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>

    <script>
        // CONFIGURACI칍N DE FIREBASE
        const firebaseConfig = {
            apiKey: "AIzaSyB5ygJIoEgpJPKY0qMULocohmzXGc7UWFE",
            authDomain: "worldstoresystem.firebaseapp.com",
            databaseURL: "https://worldstoresystem-default-rtdb.firebaseio.com",
            projectId: "worldstoresystem",
            storageBucket: "worldstoresystem.firebasestorage.app",
            messagingSenderId: "460628958914",
            appId: "1:460628958914:web:95da76852bedecbdcf255b",
            measurementId: "G-9NQMR0XVHT"
        };
        try { firebase.initializeApp(firebaseConfig); } catch(e) { console.error(e); }
        const dbRef = firebase.database();
        const auth = firebase.auth(); 

        let db=[], history=[], config={name:"WORLD STORE", sub:"", color:"#C62828", currency:"$", tel:"", footer:""}, cart=[], saleItem=null, saleMode='doc', profitMap = {};

        // --- LISTA ACTUALIZADA DEL PDF (V9.6) ---
        // Se carga esta lista si Firebase est치 vac칤o o si el usuario presiona "Cargar Lista Nueva"
        const DEFAULT_PROFIT_DB = {
            "A-2409": 5, "A-2425": 7, "AM-99": 10.8, "BM-14": 6, "G 008B": 5, "HY 001": 5, 
            "HY 002-1": 5, "HY 002-3": 5, "HY 003-1": 5, "HY 007": 5, "HY 009-1": 5, "HY 009-2": 5, 
            "HY 010": 5, "HY 011-1": 5, "HY 011-2": 5, "HY 012": 5, "HY 015": 5, "HY 015-1": 5, 
            "HY 016": 5, "HY 016-1": 5, "HY 017-1": 5, "HY 017-2": 5, "HY 018-1": 5, "HY 018-2": 5, 
            "HY 019": 5, "HY 020-3": 5, "HY 020-4": 5, "HY 020-5": 5, "HY 021-1": 5, "HY 022-1": 5, 
            "HY 025": 5, "HY 026-1": 5, "HY 027": 5, "HY 027-1": 5, "HY 029": 8, "HY 030-3": 7, 
            "HY 031-4": 8, "HY 032": 5, "HY 032-1": 5, "HY 033": 5, "HY 037": 5, "HY 039-1": 5, 
            "HY 040-1": 5, "HY 040-2": 5, "HY 040-3": 5, "HY 040-4": 5, "HY 040-6": 5, "HY 042": 5, 
            "HY 045": 5, "HY 047-1": 5, "HY 047-2": 5, "HY 047-3": 5, "HY 048-1": 5, "HY 048-2": 5, 
            "HY 049": 5, "HY 049-1": 9, "HY 055-4": 5, "HY 055-5": 5, "HY 055-6": 5, "HY 055-7": 5, 
            "HY 056": 5, "HY 057-2": 5, "HY 058-1": 5, "HY 060": 5, "HY 060-1": 5, "HY 061": 5, 
            "HY 061-1": 5, "HY 062": 5, "HY 062-1": 5, "HY 066-2": 5, "HY 076": 5, "HY 077": 5, 
            "HW-01": 5, "LA-01": 5, "LB 01-1": 5, "LB-01": 5, "LB -03": 6, "LB-11-1": 5.5, 
            "LB-11": 5.5, "LB-12": 5.8, "LC 01": 5, "LC 01-1": 5, "LC C-04": 5, "LC 05": 5, 
            "LC 05-1": 5, "LC 09": 5, "LC A-2402": 5, "LC A-2402D": 5, "LC A-2403": 5, 
            "LC AM14-1": 5, "LC B2404": 5, "LC B-2426": 5, "LC B-2426-1": 5, "LC C-02": 5.5, 
            "LC C-02-1": 5, "LC C-07": 5, "LC C07-1": 5, "LC C-09": 5, "LC C-09-1": 5, "LC C-55": 6, 
            "LC C-55-1": 6, "LC D-08": 5, "LC D-08-1": 5, "LC D-55": 6, "LC D-55-1": 6, 
            "LC LA 08": 5, "LC LB 03": 5, "LC M-11": 5, "LC M14-2": 5, "LC M-15": 7, "LC M-15D": 6, 
            "LC M-75": 6, "LC M-76": 5, "LC M99": 11, "LC M99-1": 6, "LC M99-2": 5.5, "LC PW33": 5, 
            "LC W-06": 5, "LC W15": 5, "LC W-15": 5, "LC W72-3": 5, "LC W-801": 5, "LC W-99": 5, 
            "LC W-99-1": 7, "LC W99-2": 5, "LO 024": 5, "LO 043": 5, "LO 078-5": 5, "M-60": 5, 
            "NM-99": 12.3, "PW33": 6, "RS 105": 6, "RS 106": 13, "RS 107": 5.8, "RS 108": 7, 
            "RS 109": 6.2, "RS 110": 13.6, "RS 111": 9, "RS 112": 5, "RS 113": 5, "RS 115": 5, 
            "RS 115-1": 5, "RS 119": 5, "RS 123": 8, "RS 123-1": 8, "RS 125": 10, "RS 126": 5, 
            "RS 133": 5.4, "RS 202": 7, "RS A1": 5, "RS A2": 11, "RS A2-1": 5.2, "RS A3": 10, 
            "SM 99-1": 7.4, "SM 99-3": 8, "SM 99-4": 8, "SM 99-5": 8, "SM 99-8": 8, 
            "TIB-01": 5, "LC W-63": 13, "LC W-90": 5
        };

        // LOGIN
        auth.onAuthStateChanged(user => {
            if (user) { document.getElementById('loginOverlay').style.display = 'none'; startSystem(); } 
            else { 
                document.getElementById('loginOverlay').style.display = 'flex';
                const s = localStorage.getItem('localLogo'); if(s) document.getElementById('loginLogo').src = s;
            }
        });
        window.appLogin = function() {
            const e = document.getElementById('txtEmail').value, p = document.getElementById('txtPass').value, btn = document.getElementById('btnLogin');
            if(!e || !p) return document.getElementById('loginError').innerText = "Faltan datos.";
            btn.innerText = "Verificando..."; btn.disabled = true;
            auth.signInWithEmailAndPassword(e, p).catch(er => { btn.innerText = "INGRESAR"; btn.disabled = false; document.getElementById('loginError').innerText = "Error de credenciales."; });
        }

        function startSystem() {
            dbRef.ref('config').on('value', s => { 
                if(s.val()) { config=s.val(); applyConfig(); localStorage.setItem('localLogo', config.logo||""); window.updateAllViews(); }
            });
            dbRef.ref('inventory').on('value', s => { 
                db = s.val() || []; if(!s.val()) loadInitialCatalog(); 
                window.updateAllViews(); renderProfitConfigTable(); document.getElementById('loader').style.display='none'; 
            });
            dbRef.ref('history').on('value', s => { history = s.val() ? Object.values(s.val()).sort((a,b)=>b.id-a.id) : []; renderHistory(); if(document.getElementById('view-profit').classList.contains('active')) renderProfit(); });
            
            // CARGA DE GANANCIAS
            dbRef.ref('profits').on('value', s => {
                const val = s.val();
                if (val) profitMap = val; else { profitMap = DEFAULT_PROFIT_DB; dbRef.ref('profits').set(DEFAULT_PROFIT_DB); }
                if(document.getElementById('view-profit').classList.contains('active')) renderProfit();
                renderProfitConfigTable();
            });
        }

        // FUNCIONALIDADES
        let searchTimer;
        window.searchDelay = () => { clearTimeout(searchTimer); searchTimer = setTimeout(() => { window.updateAllViews(); }, 300); }
        window.updateAllViews = () => { renderPOS(); renderInv(); }

        window.loadDefaultProfitList = function() {
            if(confirm("丘멆잺 쮻eseas SOBRESCRIBIR la tabla de ganancias actual con la nueva lista del PDF?\n\nEsto borrar치 cambios manuales de ganancias y pondr치 los valores del documento reciente.")) {
                dbRef.ref('profits').set(DEFAULT_PROFIT_DB).then(() => {
                    Toast.show("Lista del PDF Cargada Exitosamente", "success");
                    renderProfitConfigTable();
                });
            }
        }

        window.renderProfitConfigTable = function() {
            const container = document.getElementById('profitConfigBody');
            const search = document.getElementById('profitSearchInput').value.toLowerCase().trim();
            container.innerHTML = "";
            const inventoryCodes = db.map(p => p.c.trim());
            const profitCodes = Object.keys(profitMap);
            const allCodes = [...new Set([...inventoryCodes, ...profitCodes])].sort();

            allCodes.forEach(code => {
                if (search && !code.toLowerCase().includes(search)) return;
                const val = profitMap[code] || 0;
                const product = db.find(p => p.c.trim() === code);
                const details = product ? `<small style="color:#888;">${product.m}</small>` : `<small style="color:#d32f2f;">Solo en Hist칩rico</small>`;
                const row = document.createElement('tr');
                row.innerHTML = `<td style="padding:10px; border-bottom:1px solid #f0f0f0;"><span style="font-weight:bold;">${code}</span><br>${details}</td><td style="padding:10px; text-align:right; border-bottom:1px solid #f0f0f0;"><input type="number" class="profit-input" data-code="${code}" value="${val}" step="0.1"></td>`;
                container.appendChild(row);
            });
        }

        window.saveProfitTable = function() {
            let newMap = { ...profitMap };
            document.querySelectorAll('.profit-input').forEach(input => {
                const code = input.getAttribute('data-code'), val = parseFloat(input.value);
                if (!isNaN(val)) newMap[code] = val;
            });
            dbRef.ref('profits').set(newMap).then(() => { Toast.show("Tabla Actualizada"); });
        }

        function renderPOS(){
            if(config.maintenance) return document.getElementById('posGrid').innerHTML=`<div style="padding:50px;text-align:center;"><h3>Tienda Cerrada</h3></div>`;
            const g=document.getElementById('posGrid'), txt=document.getElementById('searchInput').value.toLowerCase();
            let targetCat = document.querySelector('.chip.active')?.innerText || 'Todo';
            if(targetCat === 'Todo') targetCat = 'all'; else if(targetCat==='Infantil') targetCat='Ni침o/Ni침a';

            const list=db.filter(p=>(p.c.toLowerCase().includes(txt)||p.m.toLowerCase().includes(txt))&&(targetCat==='all'||p.cat===targetCat));
            list.sort((a,b) => a.cat.localeCompare(b.cat));
            if(list.length===0) return g.innerHTML = `<p style="grid-column:1/-1;text-align:center;color:#999;margin-top:20px;">Sin resultados.</p>`;
            g.innerHTML = list.map(p=> {
                const bg=p.cat==='Dama'?'#E91E63':(p.cat==='Caballero'?'#546E7A':'#FF9800');
                const img=p.img||`https://placehold.co/300x300/eee/333?text=${p.c}`;
                return `<div class="card" onclick="openSale(${p.id})"><div class="card-img-wrap"><img src="${img}" loading="lazy"><span class="badge-cat" style="background:${bg}">${p.cat.substring(0,4)}</span></div><div class="card-content"><div><h4>${p.c}</h4><p>${p.m}</p></div><div class="card-footer"><span class="stock">Stock: ${p.stock}</span><span class="price">${config.currency}${p.d}</span></div></div></div>`
            }).join('');
        }

        window.filterCat=(c,el)=>{ document.querySelectorAll('.chip').forEach(x=>x.classList.remove('active')); el.classList.add('active'); renderPOS(); }
        window.toggleCart=()=>{ document.getElementById('cartDrawer').classList.toggle('open'); document.getElementById('mainOverlay').classList.toggle('active'); renderCart(); }
        
        window.openSale=function(id){ 
            saleItem=db.find(x=>x.id==id); document.getElementById('saleTitle').innerText = `${saleItem.c}`; 
            document.getElementById('saleId').value=id; document.getElementById('saleQty').value=1; 
            window.setSaleType('doc'); document.getElementById('modalSale').style.display='flex'; 
        }

        window.setSaleType=function(t){ 
            saleMode=t; 
            ['doc','half','unit'].forEach(x=>{
                document.getElementById('btn-'+x).style.background = x==t ? config.color : '#eee';
                document.getElementById('btn-'+x).style.color = x==t ? 'white' : '#333';
            }); 
            const q=parseInt(document.getElementById('saleQty').value)||1, cur=config.currency; 
            let p = saleMode==='doc' ? saleItem.d : (saleMode==='half' ? saleItem.d/2 : saleItem.d/12);
            document.getElementById('unitPriceDisplay').innerText = `Base: ${cur}${p.toFixed(2)}`;
            document.getElementById('saleTotalCalc').innerText = `${cur}${(p*q).toFixed(2)}`;
        }
        window.updateCalc = () => setSaleType(saleMode);
        window.adjQty=(n)=>{ let v=parseInt(document.getElementById('saleQty').value)+n; if(v<1)v=1; document.getElementById('saleQty').value=v; updateCalc(); }

        window.confirmAdd = function() {
            const q = parseInt(document.getElementById('saleQty').value);
            let deduction = saleMode === 'doc' ? 12 * q : (saleMode === 'half' ? 6 * q : q);
            const inCart = cart.filter(item => item.pId === saleItem.id).reduce((sum, item) => sum + item.deduct, 0);
            if ((deduction + inCart) > saleItem.stock) return alert(`Stock insuficiente (${saleItem.stock})`);
            
            const t = parseFloat(document.getElementById('saleTotalCalc').innerText.replace(/[^0-9.]/g, ''));
            let txt = saleMode === 'doc' ? 'Docenas' : (saleMode === 'half' ? 'Medias Doc' : 'Pares');
            cart.push({ pId: saleItem.id, c: saleItem.c, m: saleItem.m, qtyTxt: `${q} ${txt}`, total: t, deduct: deduction });
            closeModal('modalSale'); renderCart(); toggleCart(); Toast.show("Agregado");
        }

        function renderCart(){ 
            const c=document.getElementById('cartContainer'); c.innerHTML=""; let t=0;
            if(cart.length==0) c.innerHTML="<div style='text-align:center;padding:20px;color:#ccc'>Vac칤o</div>"; 
            cart.forEach((i,x)=>{ t+=i.total; c.innerHTML+=`<div class="c-item"><div style="flex:1"><b>${i.c}</b><br><small>${i.qtyTxt}</small></div><div><b>${config.currency}${i.total.toFixed(2)}</b><i class="fa-solid fa-trash" style="color:#d32f2f;margin-left:10px;cursor:pointer;" onclick="cart.splice(${x},1);renderCart()"></i></div></div>` });
            document.getElementById('cartTotalDisplay').innerText=`${config.currency}${t.toFixed(2)}`;
            document.getElementById('cartCountBadge').innerText=cart.length;
        }

        window.processSale = function() {
            if(cart.length===0) return; 
            const nm=document.getElementById('cartClientName').value.trim(); if(!nm) return alert("Cliente requerido");
            let tot=0, desc="", snap=JSON.parse(JSON.stringify(cart));
            cart.forEach(i=>{ tot+=i.total; desc+=`${i.qtyTxt} ${i.c}, `; const p=db.find(x=>x.id==i.pId); if(p) p.stock-=i.deduct; });
            dbRef.ref('inventory').set(db); 
            dbRef.ref('history').push({id:Date.now(), date:new Date().toLocaleString(), client:nm, phone:document.getElementById('cartClientPhone').value, total:tot, items:snap, desc:desc});
            printSale(nm, tot, snap); cart=[]; document.getElementById('cartClientName').value=""; renderCart(); toggleCart();
        }

        function renderInv(){ 
            const t=document.getElementById('invBody'); t.innerHTML=""; const txt = document.getElementById('searchInput').value.toLowerCase();
            const list = db.filter(p => (p.c.toLowerCase().includes(txt) || p.m.toLowerCase().includes(txt))).sort((a, b) => a.cat.localeCompare(b.cat));
            if(list.length === 0) return t.innerHTML = `<tr><td colspan="5" style="text-align:center;color:#999">Vac칤o</td></tr>`;
            t.innerHTML = list.map(p=> `<tr><td><img src="${p.img||''}" class="thumb"></td><td><b>${p.c}</b><small>${p.m}</small></td><td>${config.currency}${p.d}</td><td>${p.stock}</td><td><button class="btn" onclick="openEdit(${p.id})"><i class="fa-solid fa-pen"></i></button> <button class="btn" style="background:var(--primary);color:white" onclick="delProd(${p.id})"><i class="fa-solid fa-trash"></i></button></td></tr>`).join('');
        }

        window.openEdit=(id)=>{ 
            const p=db.find(x=>x.id==id); document.getElementById('prodId').value=p.id; 
            ['Code','Model','Price','Stock','Cat','Size'].forEach(k => document.getElementById('p'+k).value = k==='Cat' ? p.cat : (k==='Size' ? p.t : (k==='Code' ? p.c : (k==='Model' ? p.m : (k==='Price' ? p.d : p.stock)))));
            document.getElementById('prodImgBase64').value=p.img||""; 
            document.getElementById('modalProd').style.display='flex'; 
        }

        window.openModalProd=()=>{ document.querySelectorAll('#modalProd input').forEach(i=>i.value=""); document.getElementById('modalProd').style.display='flex'; }
        window.saveProduct = function() {
            const id=document.getElementById('prodId').value, obj={c:document.getElementById('pCode').value, m:document.getElementById('pModel').value, cat:document.getElementById('pCat').value, d:parseFloat(document.getElementById('pPrice').value), stock:parseInt(document.getElementById('pStock').value), t:document.getElementById('pSize').value, img:document.getElementById('prodImgBase64').value};
            let newDb=[...db]; if(id) { const i=newDb.findIndex(x=>x.id==id); if(i!==-1) newDb[i]={...newDb[i],...obj}; } else { newDb.unshift({...obj, id:Date.now()}); }
            dbRef.ref('inventory').set(newDb).then(()=>{ closeModal('modalProd'); Toast.show("Guardado"); });
        }
        window.delProd=(id)=>{ if(confirm("쮼liminar?")) dbRef.ref('inventory').set(db.filter(x=>x.id!=id)); }
        
        function renderHistory() {
            const t = document.getElementById('histBody'); t.innerHTML = ""; let g = 0;
            history.forEach(h => { g += h.total; t.innerHTML += `<tr><td>${h.date.split(',')[0]}</td><td><b>${h.client}</b></td><td><button class="btn" onclick="alert('${h.desc}')">Ver</button></td><td>${config.currency}${parseFloat(h.total).toFixed(2)}</td><td><i class="fa-solid fa-trash" style="cursor:pointer" onclick="delHist(${h.id})"></i></td></tr>`; });
            document.getElementById('grandTotalHistory').innerText = `${config.currency}${g.toFixed(2)}`;
        }

        window.delHist = function(id) {
            if (!confirm("Eliminar venta devuelve el stock. 쯉eguro?")) return;
            dbRef.ref('history').orderByChild('id').equalTo(id).once('value', s => {
                s.forEach(c => {
                    const val = c.val(); val.items.forEach(i => { const p = db.find(x => x.id === i.pId); if(p) p.stock += i.deduct; });
                    dbRef.ref('inventory').set(db); c.ref.remove(); Toast.show("Venta Anulada");
                });
            });
        }
        window.clearHistory=()=>{ if(confirm("쮹orrar todo?")) dbRef.ref('history').set(null); }

        function renderProfit() {
            const t = document.getElementById('profitBody'); t.innerHTML = ""; let gT = 0;
            history.forEach(h => {
                let sP = 0; h.items.forEach(i => { sP += ((profitMap[i.c.trim()] || 0) / 12) * i.deduct; });
                gT += sP;
                t.innerHTML += `<tr><td>${h.date.split(',')[0]}</td><td><b>${h.client}</b></td><td>${h.items.length} refs</td><td style="text-align:right">${config.currency}${h.total.toFixed(2)}</td><td style="text-align:right;font-weight:bold;color:#2E7D32">+ ${config.currency}${sP.toFixed(2)}</td></tr>`;
            });
            document.getElementById('totalProfitDisplay').innerText = `${config.currency}${gT.toFixed(2)}`;
        }
        
        function printSale(c, t, i) { 
             /* Simulaci칩n impresi칩n para ahorrar espacio */ 
             setTimeout(()=>window.print(), 500); 
        }

        // HELPERS
        window.compressAndPreview = function(file, imgId, inpId) {
            const reader = new FileReader(); reader.readAsDataURL(file);
            reader.onload = e => { 
                const img=new Image(); img.src=e.target.result; 
                img.onload=()=>{
                    const c=document.createElement('canvas'), ctx=c.getContext('2d');
                    let w=img.width, h=img.height; if(w>500){ h*=500/w; w=500; } c.width=w; c.height=h;
                    ctx.drawImage(img,0,0,w,h); document.getElementById(imgId).src=c.toDataURL('image/jpeg',0.7); document.getElementById(inpId).value=c.toDataURL('image/jpeg',0.7);
                }
            }
        }
        window.saveConfig = () => { config.name = document.getElementById('cfgName').value; config.maintenance = document.getElementById('cfgMaintenance').checked; dbRef.ref('config').set(config).then(()=>Toast.show("Configurado")); }
        function applyConfig(){ document.getElementById('brandName').innerText = config.name; }
        
        window.nav=(v,e)=>{ document.querySelectorAll('.view-panel, .nav-item').forEach(x=>x.classList.remove('active')); document.getElementById('view-'+v).classList.add('active'); if(e) e.classList.add('active'); if(v==='profit') renderProfit(); if(v==='config') renderProfitConfigTable(); }
        window.closeModal=(id)=>document.getElementById(id).style.display='none';
        const Toast={show:(m,t='s')=>{const d=document.createElement('div');d.className=`toast ${t}`;d.innerHTML=m;document.getElementById('toast-container').appendChild(d);setTimeout(()=>d.remove(),3000)}}
        window.onclick=e=>{if(e.target.className==='modal')e.target.style.display='none'}
    </script>
</body>
