<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema World Store v6.6 - Definitivo</title>
    <!-- Iconos y Fuentes -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;600;700;800&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary: #C62828;
            --dark: #121212;
            --bg: #f3f4f6;
            --sidebar-width: 270px;
            --accent: #FFD54F;
            --text-on-dark: #ffffff;
        }

        * { box-sizing: border-box; outline: none; }
        body { margin: 0; font-family: 'Montserrat', sans-serif; background: var(--bg); color: #333; height: 100vh; overflow: hidden; display: flex; }

        /* --- SIDEBAR --- */
        aside { width: var(--sidebar-width); background: var(--dark); color: var(--text-on-dark); display: flex; flex-direction: column; height: 100%; z-index: 50; box-shadow: 4px 0 15px rgba(0, 0, 0, 0.1); }
        .brand { padding: 30px 20px; text-align: center; border-bottom: 1px solid rgba(255, 255, 255, 0.1); background: rgba(0, 0, 0, 0.2); }
        #displayLogo { width: 80px; height: 80px; object-fit: cover; border-radius: 50%; margin: 0 auto 15px auto; border: 3px solid rgba(255, 255, 255, 0.15); display: none; background: white; }
        .brand h1 { margin: 0; font-size: 1.4rem; font-weight: 800; letter-spacing: 1px; color: var(--text-on-dark); }
        .brand small { color: #888; font-size: 0.75rem; display: block; margin-top: 5px; }
        .nav-menu { flex: 1; padding: 20px 0; overflow-y: auto; }
        .nav-item { padding: 15px 25px; cursor: pointer; display: flex; align-items: center; gap: 15px; color: #aaa; transition: 0.2s; font-size: 0.95rem; border-left: 4px solid transparent; text-decoration: none; }
        .nav-item:hover { background: rgba(255, 255, 255, 0.05); color: white; padding-left: 30px; }
        .nav-item.active { background: rgba(255, 255, 255, 0.1); color: var(--accent); border-left-color: var(--primary); font-weight: 700; }
        .nav-item i { width: 25px; text-align: center; }
        .backup-section { border-top: 1px solid rgba(255, 255, 255, 0.1); padding-top: 10px; margin-top: 10px; }
        .nav-item.backup { color: #81C784; }
        .nav-item.restore { color: #64B5F6; }
        .sys-info { padding: 15px; font-size: 0.7rem; text-align: center; color: #666; border-top: 1px solid rgba(255, 255, 255, 0.1); }

        /* --- MAIN --- */
        main { flex: 1; position: relative; display: flex; flex-direction: column; overflow: hidden; }
        header { height: 70px; background: white; border-bottom: 1px solid #ddd; display: flex; align-items: center; justify-content: space-between; padding: 0 30px; }
        .search-wrap { position: relative; width: 400px; }
        .search-wrap input { width: 100%; padding: 12px 20px 12px 45px; border-radius: 50px; border: 1px solid #ddd; background: #f9fafb; font-size: 0.9rem; transition: 0.3s; }
        .search-wrap input:focus { background: white; border-color: var(--primary); box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05); }
        .search-wrap i { position: absolute; left: 18px; top: 50%; transform: translateY(-50%); color: #999; }
        .filter-group { display: flex; gap: 8px; }
        .chip { padding: 6px 14px; border-radius: 20px; font-size: 0.8rem; font-weight: 600; cursor: pointer; background: white; border: 1px solid #eee; color: #555; transition: 0.2s; }
        .chip:hover { transform: translateY(-1px); border-color: #ccc; }
        .chip.active { background: var(--dark); color: white; border-color: var(--dark); }

        /* --- VISTAS --- */
        .view-panel { padding: 25px; overflow-y: auto; height: 100%; display: none; }
        .view-panel.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* --- GRID --- */
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(190px, 1fr)); gap: 20px; padding-bottom: 80px; }
        .card { background: white; border-radius: 12px; overflow: hidden; border: 1px solid #f0f0f0; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.02); transition: 0.3s; cursor: pointer; display: flex; flex-direction: column; position: relative; }
        .card:hover { transform: translateY(-4px); box-shadow: 0 10px 20px rgba(0, 0, 0, 0.08); border-color: var(--primary); }
        .card-img-wrap { height: 160px; background: #f5f5f5; display: flex; align-items: center; justify-content: center; overflow: hidden; position: relative; }
        .card-img-wrap img { width: 100%; height: 100%; object-fit: cover; transition: 0.5s; }
        .card:hover img { transform: scale(1.05); }
        .badge-cat { position: absolute; top: 8px; right: 8px; padding: 3px 8px; font-size: 0.65rem; font-weight: 700; border-radius: 4px; color: white; text-transform: uppercase; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2); }
        .card-content { padding: 12px; flex: 1; display: flex; flex-direction: column; justify-content: space-between; }
        .card h4 { margin: 0; font-size: 0.95rem; font-weight: 800; color: #333; }
        .card p { margin: 4px 0 10px; font-size: 0.8rem; color: #777; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .card-footer { display: flex; justify-content: space-between; align-items: center; border-top: 1px dashed #eee; padding-top: 8px; }
        .price { color: var(--primary); font-weight: 800; font-size: 1.1rem; }
        .stock { font-size: 0.7rem; background: #e8f5e9; color: #2e7d32; padding: 2px 6px; border-radius: 4px; font-weight: 600; }

        /* --- TABLE FIXES (SOLUCION HOVER BLANCO) --- */
        .table-wrap { background: white; border-radius: 10px; overflow: hidden; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05); }
        table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
        thead { background: #263238; color: white; }
        /* Fix bug: force header hover to stay dark */
        thead tr:hover { background-color: #263238 !important; }
        th, td { padding: 12px 15px; border-bottom: 1px solid #eee; text-align: left; vertical-align: middle; }
        /* Only apply light hover to body rows */
        tbody tr:hover { background: #f8f9fa; }
        .thumb { width: 45px; height: 45px; border-radius: 6px; object-fit: cover; background: #eee; border: 1px solid #ddd; }

        /* --- CART --- */
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); z-index: 900; display: none; }
        .overlay.active { display: block; }
        .cart-drawer { position: fixed; top: 0; right: -420px; width: 420px; height: 100%; background: white; z-index: 1000; box-shadow: -5px 0 30px rgba(0, 0, 0, 0.2); transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1); display: flex; flex-direction: column; }
        .cart-drawer.open { transform: translateX(-420px); }
        .cart-items { flex: 1; overflow-y: auto; padding: 20px; }
        .empty-cart { text-align: center; color: #aaa; margin-top: 50px; }
        .cart-total-bar { padding: 20px; background: #fafafa; border-top: 1px solid #eee; }
        .client-inputs { margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 15px; }
        .client-inputs input { width: 100%; padding: 10px; margin-bottom: 8px; border: 1px solid #ddd; border-radius: 5px; font-weight:600;}
        .c-item { display: flex; gap: 10px; padding: 15px; border: 1px solid #eee; border-radius: 8px; margin-bottom: 10px; align-items: center; }
        .c-img { width: 50px; height: 50px; border-radius: 6px; object-fit: cover; }

        /* --- TOAST --- */
        #toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 3000; display: flex; flex-direction: column; gap: 10px; }
        .toast { padding: 12px 20px; border-radius: 8px; color: white; box-shadow: 0 4px 12px rgba(0,0,0,0.15); display: flex; align-items: center; gap: 10px; animation: slideIn 0.3s; min-width: 250px; justify-content: space-between; font-size: 0.9rem;}
        .toast.success { background: #2E7D32; }
        .toast.error { background: #C62828; }
        .toast.info { background: #333; }
        @keyframes fadeOut { to { opacity: 0; transform: translateX(100%); } }

        /* --- CONFIG --- */
        .config-card { background: white; max-width: 600px; margin: 0 auto; padding: 30px; border-radius: 12px; box-shadow: 0 5px 20px rgba(0, 0, 0, 0.05); }
        .form-row { margin-bottom: 20px; }
        .form-row label { display: block; font-weight: 600; font-size: 0.9rem; margin-bottom: 8px; color: #555; }
        .form-row input, .form-row select { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; }
        .upload-logo-box { border: 1px solid #ddd; border-radius: 8px; padding: 15px; display: flex; align-items: center; gap: 15px; }
        #cfgLogoPreview { width: 60px; height: 60px; object-fit: contain; border: 1px solid #eee; background: #f9f9f9; border-radius: 4px; }

        /* --- MODAL --- */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.6); z-index: 2000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(3px); }
        .modal-box { background: white; width: 550px; max-width: 90%; padding: 25px; border-radius: 12px; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3); position: relative; animation: slideUp 0.3s; }
        .file-upload { border: 2px dashed #ddd; padding: 20px; text-align: center; cursor: pointer; border-radius: 8px; margin-top: 5px; transition: 0.2s; position: relative; }
        .file-upload:hover { border-color: var(--primary); background: #fafafa; }
        .file-upload img { max-height: 100px; display: none; margin: 0 auto; border-radius: 6px; }
        .file-upload.has-img img { display: block; }
        .file-upload.has-img span { display: none; }

        /* UTILS */
        .btn { border: none; padding: 12px 20px; border-radius: 6px; font-weight: 600; cursor: pointer; font-size: 0.9rem; transition: 0.2s; display: inline-block; text-align: center; }
        .btn:active { transform: scale(0.98); }
        .btn-primary { background: var(--dark); color: white; }
        .btn-success { background: #2E7D32; color: white; }
        .btn-danger { background: #ffebee; color: #c62828; }
        .btn-icon { padding: 5px 10px; font-size: 0.8rem; }
        .w-100 { width: 100%; }

        /* PRINT */
        #print-layer { display: none; }
        @media print {
            body > *:not(#print-layer) { display: none !important; }
            #print-layer { display: block !important; position: absolute; top: 0; left: 0; width: 100%; z-index: 99999; background: white; min-height: 100vh;}
            @page { margin: 10mm; }
        }
    </style>
</head>

<body>

    <div id="toast-container"></div>
    <div class="overlay" id="mainOverlay" onclick="toggleCart()"></div>

    <!-- SIDEBAR -->
    <aside>
        <div class="brand">
            <img id="displayLogo" src="" alt="Logo">
            <h1 id="brandName">WORLD STORE</h1>
            <small>Sistema V6.6</small>
        </div>
        <div class="nav-menu">
            <div class="nav-item active" onclick="nav('pos', this)"><i class="fa-solid fa-shop"></i> Catálogo / Ventas</div>
            <div class="nav-item" onclick="nav('history', this)"><i class="fa-solid fa-clock-rotate-left"></i> Historial (Cuentas)</div>
            <div class="nav-item" onclick="nav('inv', this)"><i class="fa-solid fa-boxes-stacked"></i> Inventario</div>
            <div class="nav-item" onclick="toggleCart()"><i class="fa-solid fa-basket-shopping"></i> Pedido (<span id="cartCountBadge">0</span>)</div>
            <div class="nav-item" onclick="nav('config', this)"><i class="fa-solid fa-sliders"></i> Configuración</div>
            <div class="backup-section">
                <div class="nav-item backup" onclick="downloadBackup()"><i class="fa-solid fa-cloud-arrow-down"></i> Backup</div>
                <div class="nav-item restore" onclick="document.getElementById('fileRestore').click()"><i class="fa-solid fa-cloud-arrow-up"></i> Restaurar</div>
                <input type="file" id="fileRestore" style="display:none" accept=".json" onchange="restoreBackup(this)">
            </div>
        </div>
        <div class="sys-info"><span id="brandSub">ARIANA & GABRIEL</span></div>
    </aside>

    <!-- MAIN -->
    <main>
        <header>
            <div class="search-wrap">
                <i class="fa-solid fa-magnifying-glass"></i>
                <input type="text" id="searchInput" placeholder="Buscar modelo o código..." onkeyup="renderPOS()">
            </div>
            <div class="filter-group">
                <div class="chip active" onclick="filterCat('all', this)">Todo</div>
                <div class="chip" onclick="filterCat('Niño/Niña', this)">Infantil</div>
                <div class="chip" onclick="filterCat('Dama', this)">Dama</div>
                <div class="chip" onclick="filterCat('Caballero', this)">Caballero</div>
            </div>
        </header>

        <!-- VIEW POS -->
        <div id="view-pos" class="view-panel active">
            <h2 style="margin-top:0">Catálogo de Productos</h2>
            <div class="grid" id="posGrid"></div>
        </div>

        <!-- VIEW HISTORIAL (MEJORADA) -->
        <div id="view-history" class="view-panel">
            <div style="display:flex; justify-content:space-between; align-items:center">
                <h2 style="margin:0">Historial de Ventas</h2>
                <div style="font-size:1.1rem; font-weight:bold; color:var(--dark);">Total Ventas: <span id="grandTotalHistory">$0.00</span></div>
            </div>
            <div class="table-wrap" style="margin-top:20px;">
                <table>
                    <thead>
                        <tr>
                            <th>Fecha</th>
                            <th>Cliente</th>
                            <th>Detalle de Productos</th>
                            <th>Total</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="histBody"></tbody>
                </table>
            </div>
            <div style="margin-top:20px; text-align:center;">
                <button class="btn btn-danger" onclick="clearHistory()">Borrar Todo el Historial</button>
            </div>
        </div>

        <!-- VIEW INVENTARIO -->
        <div id="view-inv" class="view-panel">
            <div style="display:flex; justify-content:space-between; margin-bottom:20px;">
                <h2 style="margin:0">Inventario</h2>
                <button class="btn btn-success" onclick="openModalProd()">+ Nuevo</button>
            </div>
            <div class="table-wrap">
                <table>
                    <thead>
                        <tr>
                            <th width="60">Img</th>
                            <th>Código</th>
                            <th>Modelo / Cat</th>
                            <th>P. Docena</th>
                            <th>Stock</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="invBody"></tbody>
                </table>
            </div>
        </div>

        <!-- VIEW CONFIG -->
        <div id="view-config" class="view-panel">
            <h2>Configuración</h2>
            <div class="config-card">
                <div class="form-row"><label>Nombre Empresa</label><input type="text" id="cfgName"></div>
                <div class="form-row"><label>Subtítulo</label><input type="text" id="cfgSub"></div>
                <div class="form-row"><label>Teléfono</label><input type="text" id="cfgTel"></div>
                <div class="form-row"><label>Moneda ($/Bs)</label><input type="text" id="cfgCurrency" value="$"></div>
                <div class="form-row"><label>Pie de Página Factura</label><input type="text" id="cfgFooter"></div>
                <div class="form-row"><label>Logo</label>
                    <div class="upload-logo-box">
                        <img id="cfgLogoPreview" src="">
                        <div style="flex:1;">
                            <input type="file" accept="image/*" onchange="encodeLogo(this)">
                            <input type="hidden" id="cfgLogoData">
                        </div>
                    </div>
                </div>
                <div class="form-row"><label>Color Principal</label><div class="color-picker-wrap"><input type="color" id="cfgColor" onchange="previewColor(this.value)"></div></div>
                <button class="btn btn-primary w-100" onclick="saveConfig()">Guardar Configuración</button>
            </div>
        </div>
    </main>

    <!-- CART -->
    <div id="cartDrawer" class="cart-drawer">
        <div style="padding:20px; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center;">
            <h2 style="margin:0"><i class="fa-solid fa-cart-shopping"></i> Pedido</h2>
            <button onclick="toggleCart()" style="background:none; border:none; font-size:1.5rem; cursor:pointer;">&times;</button>
        </div>
        <div class="cart-items" id="cartContainer"></div>
        <div class="cart-total-bar">
            <div class="client-inputs">
                <label style="font-size:0.85rem; font-weight:bold;">Datos del Cliente:</label>
                <input type="text" id="cartClientName" placeholder="Nombre Completo (Obligatorio)">
                <input type="text" id="cartClientPhone" placeholder="Teléfono (Opcional)">
            </div>
            <div style="display:flex; justify-content:space-between; font-size:1.2rem; font-weight:800; margin-bottom:15px;">
                <span>TOTAL:</span>
                <span id="cartTotalDisplay" style="color:var(--primary)">$0.00</span>
            </div>
            <button class="btn btn-primary w-100" onclick="processSale()">PROCESAR VENTA</button>
        </div>
    </div>

    <!-- MODAL VENTA -->
    <div id="modalSale" class="modal">
        <div class="modal-box">
            <h3 id="saleTitle" style="margin-top:0">Agregar</h3>
            <input type="hidden" id="saleId">
            <div style="margin:20px 0">
                <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px;">
                    <button class="btn btn-primary" id="btn-doc" onclick="setSaleType('doc')">DOCENA</button>
                    <button class="btn" style="background:#eee" id="btn-half" onclick="setSaleType('half')">1/2 DOC</button>
                    <button class="btn" style="background:#eee" id="btn-unit" onclick="setSaleType('unit')">PAR</button>
                </div>
                <div id="unitPriceDisplay" style="text-align:center; font-size:0.8rem; margin-top:5px; font-weight:bold; color:#666;"></div>
            </div>
            <div style="display:flex; gap:10px; margin-bottom:20px;">
                <button class="btn" style="background:#eee" onclick="adjQty(-1)">-</button>
                <input type="number" id="saleQty" value="1" min="1" style="flex:1; text-align:center; border:1px solid #ddd; font-weight:bold;" onchange="updateCalc()">
                <button class="btn" style="background:#eee" onclick="adjQty(1)">+</button>
            </div>
            <div style="text-align:right; font-size:1.5rem; font-weight:bold; margin-bottom:20px;">Total: <span id="saleTotalCalc">$0.00</span></div>
            <div style="display:flex; gap:10px;">
                <button class="btn" style="background:#eee; flex:1" onclick="closeModal('modalSale')">Cancelar</button>
                <button class="btn btn-success" style="flex:2" onclick="confirmAdd()">AGREGAR</button>
            </div>
        </div>
    </div>

    <!-- MODAL PRODUCTO -->
    <div id="modalProd" class="modal">
        <div class="modal-box">
            <h3 id="modalProdTitle" style="margin-top:0">Producto</h3>
            <input type="hidden" id="prodId"><input type="hidden" id="prodImgBase64">
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                <div><label>Código</label><input type="text" id="pCode"></div>
                <div><label>Modelo</label><input type="text" id="pModel"></div>
                <div><label>Categoría</label><select id="pCat"><option>Dama</option><option>Caballero</option><option>Niño/Niña</option></select></div>
                <div><label>Precio Docena</label><input type="number" id="pPrice"></div>
      <div><label>Precio Par (Opcional)</label><input type="number" id="pPriceUnit" placeholder="Si vacío = Auto"></div>
                <div><label>Stock</label><input type="number" id="pStock"></div>
                <div><label>Tallas</label><input type="text" id="pSize"></div>
            </div>
            <div class="file-upload" id="dropZone" onclick="document.getElementById('fileInput').click()">
                <span>Subir Foto</span>
                <img id="imgPreview">
                <input type="file" id="fileInput" accept="image/*" style="display:none" onchange="handleImageUpload(this)">
            </div>
            <div style="margin-top:20px; display:flex; justify-content:end; gap:10px;">
                <button class="btn btn-danger" onclick="closeModal('modalProd')">Cancelar</button>
                <button class="btn btn-success" onclick="saveProduct()">Guardar</button>
            </div>
        </div>
    </div>

    <!-- PRINT LAYOUT (Para factura nueva o reimpresión) -->
    <div id="print-layer">
        <div style="width:800px; margin:0 auto; font-family:sans-serif; color:black;">
            <table style="width:100%; border-bottom:2px solid #000; padding-bottom:10px; margin-bottom:20px;">
                <tr>
                    <td valign="top">
                        <img id="printLogoDisplay" style="height:70px; display:none; margin-bottom:5px;">
                        <h1 id="printBrand" style="margin:0; font-size:24px;"></h1>
                        <p id="printSub" style="margin:2px 0;"></p>
                        <p id="printTel" style="margin:0; font-size:12px;"></p>
                    </td>
                    <td align="right" valign="top">
                        <h2 style="color:var(--primary); margin:0;">NOTA DE ENTREGA</h2>
                        <p>Fecha: <span id="printDate"></span></p>
                    </td>
                </tr>
            </table>
            <!-- Info Cliente -->
            <div id="printClientBlock" style="margin-bottom:20px; border:1px solid #ddd; padding:10px; border-radius:5px;"></div>
            
            <table style="width:100%; border-collapse:collapse; margin-bottom:30px;">
                <thead>
                    <tr style="background:#eee;">
                        <th align="left" style="padding:8px; border-bottom:1px solid #999;">Cant.</th>
                        <th align="left" style="padding:8px; border-bottom:1px solid #999;">Descripción</th>
                        <th align="right" style="padding:8px; border-bottom:1px solid #999;">Unitario</th>
                        <th align="right" style="padding:8px; border-bottom:1px solid #999;">Total</th>
                    </tr>
                </thead>
                <tbody id="printBody"></tbody>
            </table>
            <div style="text-align:right;"><h2 style="margin:0;">TOTAL: <span id="printTotal"></span></h2></div>
            <div style="text-align:center; margin-top:50px; border-top:1px dashed #999; padding-top:10px; color:#555;" id="printFooter"></div>
        </div>
    </div>

    <script>
        // DATA MANAGER
        const DataManager = {
            save: (k, d) => { try { localStorage.setItem(k, JSON.stringify(d)); return true; } catch(e) { alert("Error guardando datos (Memoria llena?)"); return false; } },
            load: (k, def) => { try { const d = localStorage.getItem(k); return d ? JSON.parse(d) : def; } catch(e) { return def; } }
        };

        const Toast = {
            show: (msg, type='info') => {
                const c = document.getElementById('toast-container');
                const t = document.createElement('div'); t.className=`toast ${type}`;
                t.innerHTML = `<i class="fa-solid fa-info-circle"></i> ${msg}`;
                c.appendChild(t);
                setTimeout(()=> t.remove(), 3000);
            }
        };

        // DB V6.5
        const masterDB = [
            {c:"W 15",m:"Crocs Clásico Baby",d:46,cat:"Dama",t:"36-40"},{c:"LC W72-3",m:"Crocs Pastel",d:32,cat:"Dama",t:"35-40"},
            {c:"LC W99-1",m:"Sandalia Peluche",d:48,cat:"Dama",t:"36-40"},{c:"LC W-801",m:"Plataforma Barbie",d:35,cat:"Dama",t:"36-40"},
            {c:"LC M14-2",m:"Slide Gato/Vaca",d:38,cat:"Dama",t:"36-40"},{c:"HY 047-1",m:"Croc Banda",d:42,cat:"Dama",t:"36-40"},
            {c:"HY 047-2",m:"Croc Bicolor",d:42,cat:"Dama",t:"36-40"},{c:"HY 047-3",m:"Croc Peluche",d:47,cat:"Dama",t:"36-40"},
            {c:"HY 040-1",m:"Croc Kuromi",d:32,cat:"Dama",t:"36-40"},{c:"HY 040-3",m:"Croc Dijes Color",d:33,cat:"Dama",t:"36-40"},
            {c:"HY 040-4",m:"Croc Joyas",d:34,cat:"Dama",t:"36-40"},{c:"HY 040-6",m:"Croc Perlas",d:36,cat:"Dama",t:"36-40"},
            {c:"HY 077",m:"Croc Flor 3D",d:34,cat:"Dama",t:"36-40"},{c:"RS 111",m:"Croc Cadena",d:43,cat:"Dama",t:"36-41"},
            {c:"RS 110",m:"Plat. Chunky",d:50,cat:"Dama",t:"36-41"},{c:"RS 109",m:"Croc Diamante",d:39,cat:"Dama",t:"36-41"},
            {c:"RS 112",m:"Croc Reptil",d:31,cat:"Dama",t:"36-41"},{c:"RS 107",m:"Nike Style Liso",d:44,cat:"Dama",t:"36-41"},
            {c:"RS 202",m:"Hebilla Cuadro",d:35,cat:"Dama",t:"36-41"},{c:"HY 056",m:"Concha Shell",d:35,cat:"Dama",t:"36-40"},
            {c:"RS 123",m:"Slide Nike",d:35,cat:"Dama",t:"36-41"},{c:"HY 032",m:"Plat. Arrugada",d:43,cat:"Dama",t:"36-40"},
            {c:"HY 032-1",m:"Arruga con Lazo",d:47,cat:"Dama",t:"36-40"},{c:"HY 011-2",m:"Marmoleada",d:41,cat:"Dama",t:"36-40"},
            {c:"RS A9",m:"Diamante Slide",d:34,cat:"Dama",t:"36-41"},{c:"HY 006-1",m:"Cadena Plata",d:42,cat:"Dama",t:"36-40"},
            {c:"LB-03",m:"Chancla Acolchada",d:35,cat:"Dama",t:"36-40"},{c:"HY 006-2",m:"Cadena Conejo",d:42,cat:"Dama",t:"36-40"},
            {c:"HY 011-1",m:"Flor Plataforma",d:47,cat:"Dama",t:"36-40"},{c:"HY 002-1",m:"Vaca Lola",d:36,cat:"Dama",t:"36-40"},
            {c:"HY 002-3",m:"Love Gatos",d:40,cat:"Dama",t:"36-40"},{c:"HY 001",m:"Nube Confort",d:41,cat:"Dama",t:"36-40"},
            {c:"LC W99",m:"Tornasol",d:48,cat:"Dama",t:"36-40"},{c:"RS A2",m:"Nike SB Retro",d:36,cat:"Dama",t:"36-41"},
            {c:"RS A2-1",m:"Lazo Nice",d:34,cat:"Dama",t:"36-41"},{c:"LC B-2426-1",m:"Pata Gallo Chunky",d:30,cat:"Dama",t:"36-40"},
            {c:"HY 028-4",m:"Pata Gallo Flores",d:30,cat:"Dama",t:"36-40"},{c:"PW 33-1",m:"Flip Flop Flora",d:30,cat:"Dama",t:"36-41"},
            {c:"HY 022",m:"Prada Cruzada",d:42,cat:"Dama",t:"36-40"},{c:"HY 058-1",m:"Plat. Moño G",d:45,cat:"Dama",t:"36-40"},
            {c:"HY 029",m:"Trekking",d:56,cat:"Dama",t:"36-40"},{c:"LC W-15",m:"Sport Linea",d:46,cat:"Dama",t:"36-40"},
            {c:"W-06",m:"Confort Dedo",d:28,cat:"Dama",t:"36-40"},{c:"LC B-2426",m:"Chunky Liso",d:30,cat:"Dama",t:"36-40"},
            {c:"W-99-2",m:"3 Rayas",d:36,cat:"Dama",t:"36-40"},
            {c:"LC M-15D",m:"Croc Camuflaje",d:52,cat:"Caballero",t:"40-45"},{c:"M-15",m:"Croc Largo Liso",d:50,cat:"Caballero",t:"40-45"},
            {c:"LA-08",m:"Adidas Old School",d:38,cat:"Caballero",t:"40-45"},{c:"SM 99-3",m:"Adidas Trefoil",d:45,cat:"Caballero",t:"40-45"},
            {c:"LC M-76",m:"Agnetig Magnet",d:35,cat:"Caballero",t:"40-45"},{c:"LC M-75",m:"M Logo Sport",d:34,cat:"Caballero",t:"40-45"},
            {c:"M-60",m:"Adidas Slide",d:38,cat:"Caballero",t:"40-45"},{c:"LC M-99-1",m:"Velcro Doble",d:48,cat:"Caballero",t:"40-45"},
            {c:"SM 99-8",m:"Adidas Banda",d:45,cat:"Caballero",t:"40-45"},{c:"SM 99-5",m:"Sport Label",d:45,cat:"Caballero",t:"40-45"},
            {c:"SM 99-4",m:"Just Do It",d:45,cat:"Caballero",t:"40-45"},{c:"M99-2",m:"Adidas Largo",d:38,cat:"Caballero",t:"40-45"},
            {c:"RS 108",m:"Nike Cerrado",d:51,cat:"Caballero",t:"40-45"},{c:"HY 060-1",m:"Splash Paint",d:45,cat:"Caballero",t:"36-40"},
            {c:"HY 076",m:"Hong Yuan Sport",d:34,cat:"Caballero",t:"40-45"},{c:"HY 045",m:"Croc Basico",d:31,cat:"Caballero",t:"40-45"},
            {c:"RS A3",m:"Adidas Retro Logo",d:41,cat:"Caballero",t:"40-45"},{c:"HY 016",m:"Yeezy Liso",d:36,cat:"Caballero",t:"40-45"},
            {c:"HY 049-1",m:"Sport Letras",d:48,cat:"Caballero",t:"40-45"},{c:"LC A-2402",m:"Surf Style",d:36,cat:"Caballero",t:"40-45"},
            {c:"HY 016-1",m:"Yeezy Camu",d:46,cat:"Caballero",t:"40-45"},{c:"HY 037",m:"Franja Malla",d:38,cat:"Caballero",t:"40-45"},
            {c:"HY 010",m:"Futurista",d:36,cat:"Caballero",t:"40-45"},{c:"LC AM14-1",m:"Tejido",d:34,cat:"Caballero",t:"40-45"},
            {c:"HY 033",m:"Ranuras",d:35,cat:"Caballero",t:"40-45"},{c:"LC A-2403",m:"Largo Basic",d:29,cat:"Caballero",t:"40-45"},
            {c:"LC A-2402D",m:"Selva Camu",d:45,cat:"Caballero",t:"40-45"},{c:"LC M99",m:"Jordan 23",d:50,cat:"Caballero",t:"40-45"},
            {c:"HY 007",m:"Cuadros",d:30,cat:"Caballero",t:"40-45"},{c:"HY 049",m:"Velcro Lateral",d:50,cat:"Caballero",t:"40-45"},
            {c:"RS 101",m:"Basket",d:34,cat:"Caballero",t:"40-45"},{c:"HY 042",m:"Pata Gallo Gruesa",d:30,cat:"Caballero",t:"40-45"},
            {c:"HY 027",m:"Pata Gallo Fina",d:30,cat:"Caballero",t:"40-45"},{c:"HY 031-4",m:"Senderismo",d:56,cat:"Caballero",t:"40-45"},
            {c:"B-2404",m:"Magnetig M",d:32,cat:"Caballero",t:"36-40"},{c:"HY 040-2",m:"Sport Lines",d:31,cat:"Caballero",t:"36-40"},
            {c:"HY 060",m:"Perforado",d:44,cat:"Caballero",t:"36-40"},
            {c:"LC C-09D",m:"Animales 3D",d:44,cat:"Niño/Niña",t:"30-35"},{c:"LC C-02-1",m:"Hello/Bear",d:32,cat:"Niño/Niña",t:"30-35"},
            {c:"LC D-55-1",m:"Peppa Slide",d:32,cat:"Niño/Niña",t:"24-29"},{c:"LC C-55-1",m:"Pizza/Hello",d:33,cat:"Niño/Niña",t:"30-35"},
            {c:"LC C-07-1",m:"Jirafa",d:30,cat:"Niño/Niña",t:"30-35"},{c:"LC C-04",m:"Labubu",d:33,cat:"Niño/Niña",t:"30-35"},
            {c:"LC 05",m:"Nike Kid",d:32,cat:"Niño/Niña",t:"30-35"},{c:"RS 106",m:"Mickey",d:35,cat:"Niño/Niña",t:"25-30"},
            {c:"RS 133",m:"Kiss",d:31,cat:"Niño/Niña",t:"30-35"},{c:"HY 038-1",m:"Dino/Niña",d:27,cat:"Niño/Niña",t:"24-29"},
            {c:"HY 039-1",m:"Coco",d:29,cat:"Niño/Niña",t:"30-35"},{c:"RS 119",m:"Garra",d:27,cat:"Niño/Niña",t:"25-30"},
            {c:"RS 113",m:"Deportes",d:33,cat:"Niño/Niña",t:"30-35"},{c:"HY 009-1",m:"Bebidas",d:33,cat:"Niño/Niña",t:"30-35"},
            {c:"HY 017-1",m:"Baby Flores",d:27,cat:"Niño/Niña",t:"19-24"},{c:"HY 018-1",m:"Cohete",d:30,cat:"Niño/Niña",t:"24-29"},
            {c:"HY 003-1",m:"Vaca Kid",d:32,cat:"Niño/Niña",t:"30-35"},{c:"LC D-08-1",m:"Pata Oso",d:29,cat:"Niño/Niña",t:"24-29"},
            {c:"LO 024",m:"Bob Esponja",d:33,cat:"Niño/Niña",t:"30-35"},{c:"RS A1",m:"Yeezy Kid",d:28,cat:"Niño/Niña",t:"30-35"},
            {c:"LO 020",m:"Kitty Face",d:26,cat:"Niño/Niña",t:"30-35"},{c:"HY 055-4",m:"Bota Lazo",d:36,cat:"Niño/Niña",t:"24-29"},
            {c:"HY 055-7",m:"Bota Gato",d:40,cat:"Niño/Niña",t:"30-35"},{c:"HY 019",m:"Sand. Vaca",d:39,cat:"Niño/Niña",t:"18-23"},
            {c:"HY 013-1",m:"Croc Fashion",d:27,cat:"Niño/Niña",t:"19-24"},{c:"HY 020-3",m:"Velcro Pastel",d:50,cat:"Niño/Niña",t:"24-29"},
            {c:"HY 015-1",m:"Hebilla",d:29,cat:"Niño/Niña",t:"25-30"},{c:"HY 030-3",m:"Princesa",d:55,cat:"Niño/Niña",t:"30-35"},
            {c:"HY 020-1",m:"Sport Velcro",d:31,cat:"Niño/Niña",t:"24-29"},{c:"HY 026",m:"Love Osos",d:40,cat:"Niño/Niña",t:"30-35"},
            {c:"LO 078-5",m:"Cadena Oro",d:35,cat:"Niño/Niña",t:"24-29"},{c:"LC 01",m:"Mario",d:31,cat:"Niño/Niña",t:"30-35"},
            {c:"C-07",m:"Palta",d:29,cat:"Niño/Niña",t:"30-35"},{c:"LC C-09",m:"Borde Color",d:44,cat:"Niño/Niña",t:"24-29"},
            {c:"LC C-02",m:"Kaws",d:32,cat:"Niño/Niña",t:"30-35"},{c:"LC D-08",m:"Pata Joy",d:29,cat:"Niño/Niña",t:"24-29"},
            {c:"HY 017-2",m:"Baby Star",d:27,cat:"Niño/Niña",t:"19-24"},{c:"HY 018-2",m:"Croc Zanahoria",d:30,cat:"Niño/Niña",t:"24-29"},
            {c:"HY 038-2",m:"Dino Grey",d:27,cat:"Niño/Niña",t:"24-29"},{c:"HY 009-2",m:"Poker",d:33,cat:"Niño/Niña",t:"30-35"},
            {c:"LO 043",m:"London",d:31,cat:"Niño/Niña",t:"24-29"},{c:"G 008B",m:"Golfer",d:31,cat:"Niño/Niña",t:"30-35"},{c:"LC D-55",m:"Rubik",d:32,cat:"Niño/Niña",t:"24-29"},{c:"LC C-55",m:"Pizza Slide",d:33,cat:"Niño/Niña",t:"30-35"},
            {c:"HY 055-5",m:"Bota Dino",d:36,cat:"Niño/Niña",t:"24-29"},{c:"HY 055-6",m:"Bota Husky",d:40,cat:"Niño/Niña",t:"30-35"},
            {c:"HY 013",m:"Bucle Baby",d:27,cat:"Niño/Niña",t:"19-24"},{c:"HY 015",m:"Sport F",d:29,cat:"Niño/Niña",t:"25-30"},
            {c:"HY 020-5",m:"Gris Naranja",d:52,cat:"Niño/Niña",t:"24-29"},{c:"HY 030-4",m:"Trekking Boy",d:55,cat:"Niño/Niña",t:"30-35"},
            {c:"HY 030-5",m:"Sand. Sport",d:55,cat:"Niño/Niña",t:"30-35"}
        ];

        // INIT
        let db = DataManager.load('ws_db_v6', masterDB.map((p,i)=>({...p, id: Date.now()+i, stock: 72, img:null})));
        let history = DataManager.load('ws_hist_v6', []);
        let config = DataManager.load('ws_config', { name: "WORLD STORE", sub: "ARIANA / GABRIEL", tel: "0424-7125937", color: "#C62828", logo: null, currency: "$", footer:"Gracias por su compra" });
        let cart = [];
        let curFilter = 'all';
        let saleItem = null;
        let saleMode = 'doc';

        // MAIN FUNCTIONS
        window.onload = () => { applyConfig(); renderPOS(); renderInv(); renderHistory(); };

        function applyConfig() {
            document.documentElement.style.setProperty('--primary', config.color);
            document.getElementById('brandName').innerText = config.name;
            document.getElementById('brandSub').innerText = config.sub;
            
            // FORM INPUTS
            document.getElementById('cfgName').value = config.name;
            document.getElementById('cfgSub').value = config.sub;
            document.getElementById('cfgTel').value = config.tel;
            document.getElementById('cfgColor').value = config.color;
            document.getElementById('cfgCurrency').value = config.currency || "$";
            document.getElementById('cfgFooter').value = config.footer;

            // LOGOS
            const l1=document.getElementById('displayLogo'), l2=document.getElementById('printLogoDisplay'), l3=document.getElementById('cfgLogoPreview');
            if(config.logo){
                l1.src = config.logo; l1.style.display="block";
                l2.src = config.logo; l2.style.display="block";
                l3.src = config.logo; document.getElementById('cfgLogoData').value = config.logo;
            } else {
                l1.style.display="none"; l2.style.display="none";
            }
            
            // PRINT TXT
            document.getElementById('printBrand').innerText = config.name;
            document.getElementById('printSub').innerText = config.sub;
            document.getElementById('printTel').innerText = "Tel: "+config.tel;
            document.getElementById('printFooter').innerText = config.footer;
        }

        // --- POS SYSTEM ---
        function renderPOS() {
            const g = document.getElementById('posGrid');
            const txt = document.getElementById('searchInput').value.toLowerCase();
            g.innerHTML = "";
            const list = db.filter(p => {
                const matchTxt = p.c.toLowerCase().includes(txt) || p.m.toLowerCase().includes(txt);
                const matchCat = curFilter==='all' || p.cat === curFilter;
                return matchTxt && matchCat;
            });
            const cur = config.currency || "$";
            
            list.forEach(p => {
                const img = p.img || `https://placehold.co/400x300/f0f0f0/999?text=${encodeURIComponent(p.c)}`;
                const bg = p.cat==='Dama'?'#E91E63':(p.cat==='Caballero'?'#455A64':'#2196F3');
                g.innerHTML += `
                <div class="card" onclick="openSale(${p.id})">
                    <div class="card-img-wrap"><img src="${img}"><span class="badge-cat" style="background:${bg}">${p.cat}</span></div>
                    <div class="card-content">
                        <div><h4>${p.c}</h4><p>${p.m}</p></div>
                        <div class="card-footer"><span class="stock">Stock: ${p.stock}</span><span class="price">${cur}${p.d}</span></div>
                    </div>
                </div>`;
            });
        }

        function filterCat(c, el) { curFilter=c; document.querySelectorAll('.chip').forEach(e=>e.classList.remove('active')); el.classList.add('active'); renderPOS(); }

        // --- SALE PROCESS ---
        function openSale(id) {
            saleItem = db.find(x => x.id === id);
            document.getElementById('saleTitle').innerText = `${saleItem.c} - ${saleItem.m}`;
            document.getElementById('saleId').value = id;
            document.getElementById('saleQty').value = 1;
            setSaleType('doc');
            document.getElementById('modalSale').style.display='flex';
        }

        function setSaleType(t) {
            saleMode = t;
            ['doc','half','unit'].forEach(type => {
                const b = document.getElementById('btn-'+type);
                if(t === type) { b.className = 'btn btn-primary'; b.style.background='var(--primary)'; } 
                else { b.className = 'btn'; b.style.background='#eee'; }
            });
            updateCalc();
        }

        function updateCalc() {
    const q = parseInt(document.getElementById('saleQty').value) || 1;
    const cur = config.currency || "$";
    let p = 0, txt = "";
    
    if (saleMode === 'doc') { 
        p = saleItem.d; 
        txt = `${cur}${p} /pq`; 
    }
    else if (saleMode === 'half') { 
        // Media docena es precio docena / 2 exacto
        p = (saleItem.d / 2); 
        txt = `${cur}${p.toFixed(2)} /md`; 
    }
    else { 
        // VENTA POR PAR (UNITARIO)
        // Si existe un precio manual (p_unit) y es mayor a 0, usarlo. Si no, calcular auto.
        if (saleItem.p_unit && saleItem.p_unit > 0) {
            p = saleItem.p_unit;
        } else {
            p = (saleItem.d / 12) * 1.6; // Cálculo automático (si no hay manual)
        }
        txt = `${cur}${p.toFixed(2)} /ud`; 
    }
    
    document.getElementById('unitPriceDisplay').innerText = txt;
    document.getElementById('saleTotalCalc').innerText = `${cur}${(p*q).toFixed(2)}`;
}

        function adjQty(n) { let v=parseInt(document.getElementById('saleQty').value)+n; if(v<1)v=1; document.getElementById('saleQty').value=v; updateCalc(); }

        function confirmAdd() {
            const q = parseInt(document.getElementById('saleQty').value);
            const total = parseFloat(document.getElementById('saleTotalCalc').innerText.replace(/[^\d.-]/g, ''));
            
            // Texto para factura
            let label = "";
            if(saleMode==='doc') label = "Docena";
            if(saleMode==='half') label = "Media Doc";
            if(saleMode==='unit') label = "Par";

            cart.push({
                pId: saleItem.id, c: saleItem.c, m: saleItem.m, img: saleItem.img,
                qtyTxt: `${q} ${label}`,
                total: total
            });
            
            closeModal('modalSale');
            renderCart();
            toggleCart(); // open drawer
            Toast.show("Agregado al carrito", "success");
        }

        // --- CART LOGIC ---
        function toggleCart() {
            const d = document.getElementById('cartDrawer');
            if(d.classList.contains('open')) { d.classList.remove('open'); document.querySelector('.overlay').classList.remove('active'); }
            else { d.classList.add('open'); document.querySelector('.overlay').classList.add('active'); renderCart(); }
        }

        function renderCart() {
            const c = document.getElementById('cartContainer');
            c.innerHTML = "";
            let t = 0;
            const cur = config.currency || "$";
            
            if(cart.length===0) c.innerHTML = `<div class="empty-cart"><i class="fa-solid fa-cart-shopping" style="font-size:30px"></i><p>Carrito Vacío</p></div>`;
            
            cart.forEach((i, idx) => {
                t += i.total;
                const img = i.img || `https://placehold.co/50?text=IMG`;
                c.innerHTML += `
                <div class="c-item">
                    <img src="${img}" class="c-img">
                    <div style="flex:1">
                        <div style="font-weight:700">${i.c}</div>
                        <small>${i.m}</small><br>
                        <small style="background:#eee;padding:2px 5px;border-radius:4px">${i.qtyTxt}</small>
                    </div>
                    <div style="text-align:right">
                        <b>${cur}${i.total.toFixed(2)}</b><br>
                        <i class="fa-solid fa-trash" style="color:red;cursor:pointer" onclick="cart.splice(${idx},1);renderCart()"></i>
                    </div>
                </div>`;
            });
            document.getElementById('cartTotalDisplay').innerText = `${cur}${t.toFixed(2)}`;
            document.getElementById('cartCountBadge').innerText = cart.length;
        }

        function processSale() {
            if(cart.length===0) return Toast.show("Carrito vacío", "error");
            
            const cName = document.getElementById('cartClientName').value.trim();
            const cPhone = document.getElementById('cartClientPhone').value.trim();
            if(!cName) return alert("⚠️ Nombre del cliente obligatorio.");

            let total = 0;
            let descItems = "";
            const tbody = document.getElementById('printBody');
            tbody.innerHTML = "";
            const cur = config.currency || "$";

            // Loop cart to save details
            cart.forEach(i => {
                total += i.total;
                // Descripcion más detallada para historial
                descItems += `<b>${i.qtyTxt}</b> ${i.c} (${i.m})<br>`;
                
                const prod = db.find(x=>x.id === i.pId);
                if(prod) { 
                    let d = 1; 
                    if(i.qtyTxt.includes('Doc')) d=12; 
                    if(i.qtyTxt.includes('Media')) d=6;
                    if(i.qtyTxt.includes('Par')) d=1;
                    prod.stock -= (parseInt(i.qtyTxt)*d); 
                }

                tbody.innerHTML += `<tr><td style="padding:8px;border-bottom:1px solid #ccc">${i.qtyTxt}</td><td style="padding:8px;border-bottom:1px solid #ccc"><strong>${i.c}</strong><br>${i.m}</td><td style="padding:8px;border-bottom:1px solid #ccc;text-align:right">-</td><td style="padding:8px;border-bottom:1px solid #ccc;text-align:right">${cur}${i.total.toFixed(2)}</td></tr>`;
            });

            const newHist = {
                id: Date.now(),
                date: new Date().toLocaleString(),
                client: cName,
                phone: cPhone,
                items_snapshot: JSON.parse(JSON.stringify(cart)),
                desc_html: descItems, // New HTML detail format
                total: total
            };
            history.unshift(newHist);
            DataManager.save('ws_hist_v6', history);
            DataManager.save('ws_db_v6', db); 

            // PDF Footer Info
            document.getElementById('printTotal').innerText = `${cur}${total.toFixed(2)}`;
            document.getElementById('printDate').innerText = new Date().toLocaleDateString();
            document.getElementById('printClientBlock').innerHTML = `<strong>CLIENTE:</strong> ${cName} <br> <strong>TLF:</strong> ${cPhone}`;

            renderHistory();
            renderPOS();
            renderInv();
            
            cart = [];
            document.getElementById('cartClientName').value = "";
            document.getElementById('cartClientPhone').value = "";
            renderCart();
            toggleCart();

            Toast.show("Procesado. Imprimiendo...", "success");
            setTimeout(() => window.print(), 500);
        }

        // --- HISTORY & REPRINT ---
        function renderHistory() {
            const tb = document.getElementById('histBody');
            tb.innerHTML = "";
            const cur = config.currency || "$";
            let gTotal = 0;

            history.forEach(h => {
                gTotal += h.total;
                // Uso desc_html nuevo o desc antiguo como fallback
                let details = h.desc_html || h.desc || "Sin detalles"; 
                
                tb.innerHTML += `
                <tr>
                    <td style="font-size:0.85rem">${h.date}</td>
                    <td><strong>${h.client}</strong></td>
                    <td style="font-size:0.8rem; line-height:1.4">${details}</td>
                    <td><b style="color:var(--primary)">${cur}${h.total.toFixed(2)}</b></td>
                    <td>
                        <button class="btn btn-primary btn-icon" style="background:#2196F3" onclick="reprintOrder(${h.id})" title="Imprimir Copia"><i class="fa-solid fa-print"></i></button>
                        <button class="btn btn-danger btn-icon" onclick="delHist(${h.id})"><i class="fa-solid fa-trash"></i></button>
                    </td>
                </tr>`;
            });
            document.getElementById('grandTotalHistory').innerText = `${cur}${gTotal.toFixed(2)}`;
        }

        // FUNCION REIMPRIMIR UNIVERSAL
        function reprintOrder(id) {
            const order = history.find(h => h.id === id);
            const cur = config.currency || "$";
            const tbody = document.getElementById('printBody');
            tbody.innerHTML = "";

            if(order.items_snapshot) {
                // Nuevo formato: tenemos datos completos
                order.items_snapshot.forEach(i => {
                    tbody.innerHTML += `<tr><td style="padding:8px;border-bottom:1px solid #ccc">${i.qtyTxt}</td><td style="padding:8px;border-bottom:1px solid #ccc"><strong>${i.c}</strong><br>${i.m}</td><td style="padding:8px;border-bottom:1px solid #ccc;text-align:right">-</td><td style="padding:8px;border-bottom:1px solid #ccc;text-align:right">${cur}${i.total.toFixed(2)}</td></tr>`;
                });
            } else {
                // Antiguo formato: solo texto plano
                tbody.innerHTML += `<tr><td colspan="3" style="padding:10px;border-bottom:1px solid #ccc">${order.desc}</td><td style="padding:10px;border-bottom:1px solid #ccc;text-align:right">${cur}${order.total.toFixed(2)}</td></tr>`;
            }

            document.getElementById('printTotal').innerText = `${cur}${order.total.toFixed(2)}`;
            document.getElementById('printDate').innerText = order.date;
            document.getElementById('printClientBlock').innerHTML = `<strong>CLIENTE:</strong> ${order.client || 'N/A'} <br> <strong>TLF:</strong> ${order.phone || ''} <span style="float:right;color:red;border:1px solid red;padding:2px 5px;border-radius:4px;font-size:10px;">COPIA REIMPRESA</span>`;

            setTimeout(() => window.print(), 200);
        }

        function delHist(id) { 
            if(confirm("¿Borrar registro?")) { history=history.filter(h=>h.id!==id); DataManager.save('ws_hist_v6', history); renderHistory(); }
        }
        function clearHistory() {
            if(confirm("¿Borrar TODO el historial?")) { history=[]; DataManager.save('ws_hist_v6', history); renderHistory(); }
        }

        // --- INV CRUD ---
        function renderInv() {
            const tb = document.getElementById('invBody');
            tb.innerHTML = "";
            const cur = config.currency || "$";
            db.forEach(p => {
                const img = p.img || "https://placehold.co/50?text=IMG";
                tb.innerHTML += `<tr>
                    <td><img src="${img}" class="thumb"></td>
                    <td><b>${p.c}</b></td><td>${p.m}<br><small>${p.cat}</small></td>
                    <td>${cur}${p.d}</td><td style="${p.stock<12?'color:red':''}">${p.stock}</td>
                    <td><button class="btn btn-primary btn-icon" onclick="editProd(${p.id})"><i class="fa-solid fa-pen"></i></button> <button class="btn btn-danger btn-icon" onclick="delProd(${p.id})"><i class="fa-solid fa-trash"></i></button></td>
                </tr>`;
            });
        }

        function openModalProd() { 
            ['prodId','pCode','pModel','pPrice','pPriceUnit','pStock','pSize','prodImgBase64'].forEach(k=>document.getElementById(k).value="");
            document.getElementById('pStock').value=72;
            document.getElementById('imgPreview').src="";
            document.getElementById('modalProdTitle').innerText="Nuevo Producto";
            document.getElementById('modalProd').style.display='flex';
        }

        function editProd(id) {
            const p = db.find(x=>x.id===id);
            document.getElementById('prodId').value=p.id;
            document.getElementById('pCode').value=p.c;
            document.getElementById('pModel').value=p.m;
            document.getElementById('pPrice').value=p.d;
            document.getElementById('pPriceUnit').value = p.p_unit || ""; 
            document.getElementById('pStock').value=p.stock;
            document.getElementById('pSize').value=p.t || "";
            document.getElementById('pCat').value=p.cat;
            if(p.img) { document.getElementById('imgPreview').src=p.img; document.getElementById('prodImgBase64').value=p.img; }
            document.getElementById('modalProdTitle').innerText="Editar Producto";
            document.getElementById('modalProd').style.display='flex';
        }

        function saveProduct() {
            const id = document.getElementById('prodId').value;
            const obj = {
                c: document.getElementById('pCode').value, m: document.getElementById('pModel').value, cat: document.getElementById('pCat').value,
                d: parseFloat(document.getElementById('pPrice').value), stock: parseInt(document.getElementById('pStock').value),
                p_unit: parseFloat(document.getElementById('pPriceUnit').value) || 0, // <--- LINEA NUEVA
                t: document.getElementById('pSize').value, img: document.getElementById('prodImgBase64').value || null
            };
            if(id) { const i = db.findIndex(x=>x.id==id); db[i] = {...db[i], ...obj}; } 
            else { db.unshift({...obj, id:Date.now()}); }
            DataManager.save('ws_db_v6', db);
            closeModal('modalProd'); renderPOS(); renderInv();
        }

        function delProd(id) { if(confirm("Eliminar?")) { db=db.filter(x=>x.id!==id); DataManager.save('ws_db_v6', db); renderPOS(); renderInv(); } }

        function handleImageUpload(i) {
            if(i.files[0]) {
                if(i.files[0].size>300000) return alert("Imagen muy pesada (max 300kb)");
                const r = new FileReader();
                r.onload = e => { document.getElementById('imgPreview').src=e.target.result; document.getElementById('prodImgBase64').value=e.target.result; };
                r.readAsDataURL(i.files[0]);
            }
        }

        // --- BACKUP ---
        function downloadBackup() {
            const d = JSON.stringify({db, history, config});
            const a = document.createElement('a'); a.href = `data:text/json;charset=utf-8,${encodeURIComponent(d)}`;
            a.download = `Copia_${new Date().toISOString().slice(0,10)}.json`; a.click();
        }
        function restoreBackup(i) {
            if(i.files[0]) {
                const r = new FileReader();
                r.onload = e => {
                    try {
                        const d = JSON.parse(e.target.result);
                        if(confirm("Sobrescribir datos?")) {
                            if(d.db) DataManager.save('ws_db_v6', d.db);
                            if(d.history) DataManager.save('ws_hist_v6', d.history);
                            if(d.config) DataManager.save('ws_config', d.config);
                            location.reload();
                        }
                    } catch(x){ alert("Archivo invalido"); }
                }; r.readAsText(i.files[0]);
            }
        }

        // --- CONFIG ---
        function encodeLogo(i) { 
            if(i.files[0]) { 
                const r = new FileReader(); r.onload=e=>{ document.getElementById('cfgLogoData').value=e.target.result; document.getElementById('cfgLogoPreview').src=e.target.result; }; 
                r.readAsDataURL(i.files[0]); 
            } 
        }
        function saveConfig() {
            config.name = document.getElementById('cfgName').value; config.sub = document.getElementById('cfgSub').value;
            config.tel = document.getElementById('cfgTel').value; config.color = document.getElementById('cfgColor').value;
            config.currency = document.getElementById('cfgCurrency').value; config.footer = document.getElementById('cfgFooter').value;
            const ld = document.getElementById('cfgLogoData').value; if(ld) config.logo = ld;
            DataManager.save('ws_config', config); applyConfig(); Toast.show("Configuración guardada", "success");
        }

        // --- UI ---
        function nav(v, el) { document.querySelectorAll('.view-panel').forEach(x=>x.classList.remove('active')); document.querySelectorAll('.nav-item').forEach(x=>x.classList.remove('active')); document.getElementById('view-'+v).classList.add('active'); el.classList.add('active'); }
        function closeModal(id) { document.getElementById(id).style.display='none'; }
        function previewColor(c) { document.documentElement.style.setProperty('--primary', c); }
        window.onclick = e => { if(e.target.className==='modal') e.target.style.display='none'; }

    </script>
</body>
</html>
