<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>World Store System - Enterprise v10</title>

    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;600;700;800&display=swap" rel="stylesheet">

    <style>
        :root {
            /* Palette Profesional */
            --primary: #D32F2F; 
            --primary-light: #FFEBEE;
            --dark: #1e1e2d;
            --dark-light: #2d2d44;
            --bg: #f3f5f9;
            --text-main: #3F4254;
            --text-muted: #B5B5C3;
            --white: #ffffff;
            --sidebar-width: 270px;
            --radius: 12px;
            --shadow-soft: 0 5px 20px rgba(0,0,0,0.03);
            --shadow-hover: 0 10px 25px rgba(0,0,0,0.06);
        }

        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }

        body { 
            margin: 0; font-family: 'Montserrat', sans-serif; background: var(--bg); color: var(--text-main); 
            height: 100vh; height: 100dvh; overflow: hidden; display: flex; 
        }

        /* --- SIDEBAR --- */
        aside { 
            width: var(--sidebar-width); background: var(--dark); color: white; display: flex; flex-direction: column; 
            height: 100%; z-index: 50; transition: 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
        }
        .brand { padding: 35px 20px; text-align: center; }
        .brand img { width: 80px; height: 80px; object-fit: contain; border-radius: 50%; margin: 0 auto 15px auto; background: white; border: 4px solid rgba(255,255,255,0.1); display: none; padding: 5px; }
        .brand h1 { margin: 0; font-size: 1.3rem; font-weight: 800; letter-spacing: 0.5px; text-transform: uppercase;}
        .brand small { color: rgba(255,255,255,0.5); font-size: 0.75rem; letter-spacing: 1px;}
        .nav-menu { flex: 1; padding: 20px 10px; overflow-y: auto; }
        .nav-item { 
            padding: 16px 20px; cursor: pointer; display: flex; align-items: center; gap: 15px; color: #8c8c9e; 
            transition: all 0.2s; font-size: 0.9rem; border-radius: var(--radius); margin-bottom: 5px; font-weight: 500;
        }
        .nav-item:hover { background: rgba(255,255,255,0.03); color: white; }
        .nav-item.active { background: var(--primary); color: white; font-weight: 600; box-shadow: 0 4px 15px rgba(211, 47, 47, 0.3); }

        /* --- MAIN --- */
        main { flex: 1; position: relative; display: flex; flex-direction: column; overflow: hidden; width: 100%; }
        header { 
            height: 80px; background: rgba(255,255,255,0.95); backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(0,0,0,0.05); display: flex; align-items: center; 
            justify-content: space-between; padding: 0 30px; gap: 20px; flex-shrink: 0; z-index: 40;
        }

        .search-wrap { position: relative; flex: 1; max-width: 450px; }
        .search-wrap input { 
            width: 100%; padding: 12px 20px 12px 45px; border-radius: 50px; border: 2px solid transparent; 
            background: #eef0f8; color: var(--dark); transition: 0.2s; font-weight: 600;
        }
        .search-wrap input:focus { background: white; border-color: var(--primary); }
        .search-wrap i { position: absolute; left: 18px; top: 50%; transform: translateY(-50%); color: #a1a5b7; }
        
        .filter-group { display: flex; gap: 8px; overflow-x: auto; }
        .chip { padding: 8px 18px; border-radius: 50px; font-size: 0.8rem; font-weight: 600; cursor: pointer; background: white; border: 1px solid #e1e3ea; color: #7e8299; transition:0.2s; }
        .chip.active { background: var(--dark); color: white; border-color: var(--dark); }

        .view-panel { padding: 25px 30px; flex: 1; overflow-y: auto; display: none; padding-bottom: 100px; }
        .view-panel.active { display: block; animation: fadeIn 0.4s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- CARDS & GRID --- */
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 20px; }
        .card { 
            background: white; border-radius: 16px; overflow: hidden; border: none; box-shadow: var(--shadow-soft); 
            cursor: pointer; display: flex; flex-direction: column; height: 100%; position: relative; transition: transform 0.2s;
        }
        .card:hover { transform: translateY(-5px); box-shadow: var(--shadow-hover); }
        .card-img-wrap { height: 160px; background: #f9f9f9; display: flex; justify-content: center; align-items: center; position: relative; }
        .card-img-wrap img { width: 100%; height: 100%; object-fit: cover; }
        .badge-cat { position: absolute; top: 10px; right: 10px; padding: 4px 10px; border-radius: 20px; color: white; font-size: 0.65rem; font-weight: 700; text-transform: uppercase; }
        .card-content { padding: 15px; flex: 1; display: flex; flex-direction: column; gap: 8px; }
        .price { color: var(--primary); font-weight: 800; font-size: 1.1rem; }
        .stock { font-size: 0.75rem; background: #E8F5E9; color: #2E7D32; padding: 4px 8px; border-radius: 6px; font-weight: 700; }

        /* --- TABLES --- */
        .table-wrap { background: white; border-radius: 16px; overflow-x: auto; box-shadow: var(--shadow-soft); border: 1px solid rgba(0,0,0,0.02); }
        table { width: 100%; border-collapse: collapse; font-size: 0.9rem; min-width: 600px; }
        th { padding: 15px 20px; text-align: left; background: #f9f9f9; color: var(--text-muted); font-size: 0.75rem; text-transform: uppercase; font-weight: 700; }
        td { padding: 15px 20px; border-bottom: 1px solid #f0f0f0; }
        tr:hover td { background: #fbfbfb; }

        /* --- COMPONENTS --- */
        .btn { padding: 12px 20px; border-radius: 10px; border:none; cursor: pointer; font-weight: 700; width: 100%; display: inline-flex; justify-content: center; align-items: center; gap: 8px; transition: 0.2s; }
        .btn-primary { background: var(--dark); color: white; }
        .btn-success { background: #2E7D32; color: white; }
        .btn-blue { background: #1565C0; color: white; }
        .btn-danger { background: #c62828; color: white; }
        
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 900; display: none; backdrop-filter: blur(3px); }
        .overlay.active { display: block; }

        /* CART DRAWER */
        .cart-drawer { position: fixed; top: 0; right: -500px; width: 450px; height: 100%; background: white; z-index: 1100; transition: transform 0.4s ease; display: flex; flex-direction: column; box-shadow: -10px 0 40px rgba(0,0,0,0.15); }
        .cart-drawer.open { transform: translateX(-500px); }
        .cart-items { flex: 1; overflow-y: auto; padding: 20px; }
        .c-item { display: flex; justify-content: space-between; align-items: center; padding: 15px; border-bottom: 1px solid #eee; }

        /* MODAL */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 2000; display: none; align-items: center; justify-content: center; padding: 20px; }
        .modal-box { background: white; width: 500px; max-width: 100%; padding: 30px; border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); max-height: 90vh; overflow-y: auto; }

        input, select { width: 100%; padding: 12px; border: 1px solid #e1e3ea; border-radius: 8px; margin-bottom: 10px; font-family: inherit; }
        .file-upload { border: 2px dashed #d1d4db; padding: 20px; text-align: center; border-radius: 12px; cursor: pointer; margin-bottom: 15px; background: #fafafa; }
        
        .toast { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); background: #333; color: white; padding: 12px 24px; border-radius: 50px; z-index: 10000; display:flex; align-items:center; gap:10px; box-shadow: 0 5px 20px rgba(0,0,0,0.3); }

        @media (max-width: 768px) {
            body { flex-direction: column; }
            aside { position: fixed; bottom: 0; left: 0; width: 100%; height: 70px; flex-direction: row; padding: 0 10px; z-index: 1000; box-shadow: 0 -5px 20px rgba(0,0,0,0.05); }
            .brand, .sys-info { display: none; }
            .nav-menu { display: flex; flex-direction: row; width: 100%; padding: 0; justify-content: space-between; align-items: center; }
            .nav-item { flex-direction: column; padding: 8px 5px; flex: 1; border-radius: 10px; margin: 0; background: transparent; font-size: 0.7rem; gap: 5px; }
            .nav-item i { font-size: 1.2rem; }
            .nav-item.active { background: var(--primary-light); color: var(--primary); box-shadow: none; }
            main { height: calc(100vh - 70px); }
            header { padding: 10px 15px; flex-wrap: wrap; height: auto; gap: 10px; }
            .search-wrap { order: 3; width: 100%; max-width: none; }
            .filter-group { order: 4; width: 100%; padding-bottom: 5px; }
            .grid { grid-template-columns: 1fr 1fr; gap: 15px; }
            .cart-drawer { width: 100%; right: -100%; }
            .cart-drawer.open { transform: translateX(-100%); }
        }

        #print-layer { display: none; }
        @media print { body > *:not(#print-layer) { display: none !important; } #print-layer { display: block !important; position: absolute; top:0; left:0; width: 100%; } }
    </style>
</head>

<body>
    <!-- LOGIN SCREEN -->
    <div id="loginOverlay" style="position:fixed; top:0; left:0; width:100%; height:100%; background:var(--dark); z-index:10000; display:flex; flex-direction:column; align-items:center; justify-content:center; color:white;">
        <div style="background:white; padding:10px; border-radius:50%; margin-bottom:20px;">
            <img id="loginLogo" src="https://placehold.co/100?text=WS" style="width:80px; height:80px; object-fit:contain; border-radius:50%;">
        </div>
        <h2 style="margin:0 0 30px 0; letter-spacing:2px; text-transform:uppercase;">Acceso Seguro</h2>
        <div style="background:white; padding:30px; border-radius:16px; width:320px; max-width:90%;">
            <input type="email" id="txtEmail" placeholder="Correo" style="color:#333; background:#f5f5f5;">
            <input type="password" id="txtPass" placeholder="Contrase침a" style="color:#333; background:#f5f5f5; margin-bottom:20px;">
            <button class="btn btn-primary" onclick="appLogin()" id="btnLogin">ENTRAR</button>
            <p id="loginError" style="color:#d32f2f; font-size:0.8rem; margin-top:15px; display:none; text-align:center; font-weight:bold;"></p>
        </div>
    </div>

    <div id="loader" style="position:fixed;top:0;left:0;width:100%;height:100%;background:white;z-index:9999;display:flex;align-items:center;justify-content:center;flex-direction:column;">
        <i class="fa-solid fa-circle-notch fa-spin" style="font-size:3rem; color:var(--primary)"></i><p style="margin-top:20px;color:#555;">Cargando Sistema...</p>
    </div>
    
    <div id="toast-container"></div>
    <div class="overlay" id="mainOverlay" onclick="toggleCart()"></div>

    <!-- SIDEBAR -->
    <aside>
        <div class="brand">
            <img id="displayLogoSidebar" src="" alt="Logo">
            <h1 id="brandName">WORLD STORE</h1>
            <small>SISTEMA v10.0</small>
        </div>
        <div class="nav-menu">
            <div class="nav-item active" onclick="nav('pos', this)"><i class="fa-solid fa-store"></i> <span>Cat치logo</span></div>
            <div class="nav-item" onclick="nav('history', this)"><i class="fa-solid fa-receipt"></i> <span>Ventas</span></div>
            <div class="nav-item" onclick="nav('profit', this)"><i class="fa-solid fa-chart-line"></i> <span>Ganancias</span></div>
            <div class="nav-item" onclick="nav('inv', this)"><i class="fa-solid fa-boxes-stacked"></i> <span>Inventario</span></div>
            <div class="nav-item" onclick="toggleCart()"><i class="fa-solid fa-cart-shopping"></i> <span>Carrito <b id="cartCountBadge" style="background:var(--primary);color:white;padding:1px 6px;border-radius:10px;font-size:0.7em;">0</b></span></div>
            <div class="nav-item" onclick="nav('config', this)"><i class="fa-solid fa-sliders"></i> <span>Ajustes</span></div>
        </div>
    </aside>

    <main>
        <header>
            <div style="font-weight:800; font-size:1.2rem; color:var(--dark);">PUNTO DE VENTA</div>
            <div class="search-wrap">
                <i class="fa-solid fa-magnifying-glass"></i>
                <input type="text" id="searchInput" placeholder="Buscar producto..." onkeyup="searchDelay()">
            </div>
            <div class="filter-group">
                <div class="chip active" onclick="filterCat('all', this)">Todo</div>
                <div class="chip" onclick="filterCat('Dama', this)">Dama</div>
                <div class="chip" onclick="filterCat('Caballero', this)">Caballero</div>
            </div>
        </header>

        <!-- VIEW: POS -->
        <div id="view-pos" class="view-panel active">
            <div class="grid" id="posGrid"></div>
        </div>

        <!-- VIEW: HISTORY -->
        <div id="view-history" class="view-panel">
            <!-- PANEL TOTALIZADOR HIST칍RICO REAL -->
            <div style="background:linear-gradient(135deg, var(--dark) 0%, #2d2d44 100%); color:white; padding:25px; border-radius:12px; margin-bottom:20px; display:flex; justify-content:space-between; align-items:center; box-shadow:0 10px 30px rgba(0,0,0,0.15);">
                <div>
                    <small style="text-transform:uppercase; letter-spacing:1px; opacity:0.7;">Ventas Totales (Hist칩rico)</small>
                    <div id="historyTotalRevenue" style="font-size:2rem; font-weight:800; margin-top:5px;">$0.00</div>
                </div>
                <div style="text-align:right;">
                     <small style="opacity:0.7;">N췈 Transacciones</small>
                     <div id="historyCount" style="font-size:1.4rem; font-weight:bold;">0</div>
                </div>
            </div>

            <div style="margin-bottom:15px; display:flex; justify-content:space-between; align-items:center;">
                <small id="historyStatusLabel" style="color:#777; font-weight:bold;">Mostrando Recientes</small>
                <button class="btn btn-blue" id="btnLoadAllHist" onclick="forceLoadAllHistory()" style="width:auto; font-size:0.8rem; padding:8px 15px;">
                    <i class="fa-solid fa-cloud-arrow-down"></i> Cargar Lista Completa
                </button>
            </div>

            <div class="table-wrap">
                <table>
                    <thead><tr><th>Fecha</th><th>Cliente</th><th>Items</th><th>Total</th><th>Acci칩n</th></tr></thead>
                    <tbody id="histBody"></tbody>
                </table>
            </div>
        </div>

        <!-- VIEW: INVENTORY -->
        <div id="view-inv" class="view-panel">
            <div style="display:flex; justify-content:space-between; margin-bottom:20px; align-items:center;">
                <h3>Inventario</h3>
                <button class="btn btn-success" style="width:auto;" onclick="openModalProd()">+ Nuevo Producto</button>
            </div>
            <div class="table-wrap">
                <table>
                    <thead><tr><th>Foto</th><th>Detalle</th><th>Precio</th><th>Stock</th><th>Acciones</th></tr></thead>
                    <tbody id="invBody"></tbody>
                </table>
            </div>
        </div>

        <!-- VIEW: PROFIT -->
        <div id="view-profit" class="view-panel">
            <div style="background:white; padding:20px; border-radius:16px; margin-bottom:20px; box-shadow:var(--shadow-soft); display:flex; justify-content:space-between; align-items:center;">
                <div><h3 style="margin:0;">Ganancias Estimadas</h3></div>
                <div style="text-align:right;"><div style="font-size:0.8rem;color:#777">Total Utilidad</div><div style="font-size:1.8rem;font-weight:800;color:#2E7D32" id="totalProfitDisplay">$0.00</div></div>
            </div>
            <div class="table-wrap">
                <table><thead><tr><th>Fecha</th><th>Cliente</th><th>Total Venta</th><th style="color:#2E7D32">Utilidad</th></tr></thead><tbody id="profitBody"></tbody></table>
            </div>
        </div>

        <!-- VIEW: CONFIG -->
        <div id="view-config" class="view-panel">
            <h3>Configuraci칩n</h3>
            <div style="background:white; padding:25px; border-radius:16px; margin-bottom:20px;">
                <label>Nombre Empresa</label><input id="cfgName">
                <label>Color Tema</label><input type="color" id="cfgColor" style="height:40px; cursor:pointer;" oninput="previewColor(this.value)">
                <label>Logo</label>
                <div style="display:flex; gap:10px; align-items:center; background:#f9f9f9; padding:10px; border-radius:8px;">
                    <img id="cfgLogoPreview" src="" style="width:50px;height:50px;object-fit:contain;">
                    <input type="file" id="logoUploader" accept="image/*" style="display:none" onchange="compressAndPreview(this.files[0], 'cfgLogoPreview', 'cfgLogoData')">
                    <button class="btn btn-blue" onclick="document.getElementById('logoUploader').click()" style="width:auto;">Subir</button>
                    <input type="hidden" id="cfgLogoData">
                </div>
                <label style="display:flex;align-items:center;gap:10px;margin-top:15px;">
                    <input type="checkbox" id="cfgMaintenance" style="width:20px;"> Mantenimiento (Ocultar POS)
                </label>
            </div>
            <button class="btn btn-primary" onclick="saveConfig()">GUARDAR CAMBIOS</button>
        </div>
    </main>

    <!-- DRAWER: CART -->
    <div id="cartDrawer" class="cart-drawer">
        <div style="padding:15px; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center;">
            <h3>游 Pedido</h3>
            <button onclick="toggleCart()" style="background:none; border:none; font-size:1.5rem;">&times;</button>
        </div>
        <div class="cart-items" id="cartContainer"></div>
        <div style="padding:20px; border-top:1px solid #eee;">
            <input type="text" id="cartClientName" placeholder="Nombre Cliente *" style="margin-bottom:10px;">
            <input type="tel" id="cartClientPhone" placeholder="Tel칠fono" style="margin-bottom:15px;">
            <div style="display:flex; justify-content:space-between; margin-bottom:15px; font-size:1.2rem; font-weight:bold;"><span>Total</span><span id="cartTotalDisplay" style="color:var(--primary)">$0.00</span></div>
            <button class="btn btn-success" id="btnProcessSale" onclick="processSale()" style="padding:15px;">CONFIRMAR VENTA</button>
        </div>
    </div>

    <!-- MODAL: SALE -->
    <div id="modalSale" class="modal">
        <div class="modal-box">
            <h3 id="saleTitle" style="margin-top:0;">Producto</h3>
            <input type="hidden" id="saleId">
            <div style="background:#f9f9f9; padding:15px; border-radius:8px; margin:10px 0; text-align:center;">
                <label style="display:block;margin-bottom:5px;font-weight:bold;font-size:0.8rem;">Modo de Venta:</label>
                <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:5px;">
                    <button class="btn" style="padding:8px;font-size:0.7rem;" id="btn-doc" onclick="setSaleType('doc')">DOCENA</button>
                    <button class="btn" style="padding:8px;font-size:0.7rem;background:#eee;color:#333;" id="btn-half" onclick="setSaleType('half')">MEDIA</button>
                    <button class="btn" style="padding:8px;font-size:0.7rem;background:#eee;color:#333;" id="btn-unit" onclick="setSaleType('unit')">PAR</button>
                </div>
                <div id="unitPriceDisplay" style="margin-top:10px; font-weight:600; color:#555;"></div>
            </div>
            <div style="display:flex; gap:10px; margin-bottom:20px; align-items:center;">
                <button class="btn" style="background:#eee;color:#333;width:50px;font-size:1.2rem;" onclick="adjQty(-1)">-</button>
                <input type="number" id="saleQty" value="1" readonly style="text-align:center; font-weight:bold; font-size:1.2rem; border:none; background:transparent;">
                <button class="btn" style="background:#eee;color:#333;width:50px;font-size:1.2rem;" onclick="adjQty(1)">+</button>
            </div>
            <div style="text-align:right; font-size:2rem; font-weight:800; color:var(--primary); margin-bottom:20px;" id="saleTotalCalc">$0.00</div>
            <div style="display:flex; gap:10px;">
                <button class="btn btn-danger" onclick="closeModal('modalSale')">Cancelar</button>
                <button class="btn btn-success" onclick="confirmAdd()">AGREGAR</button>
            </div>
        </div>
    </div>

    <!-- MODAL: PRODUCT -->
    <div id="modalProd" class="modal">
        <div class="modal-box">
            <h3 id="modalProdTitle">Gesti칩n Producto</h3>
            <input type="hidden" id="prodId"><input type="hidden" id="prodImgBase64">
            <input type="text" id="pModel" placeholder="Nombre/Modelo">
            <input type="text" id="pCode" placeholder="C칩digo">
            <select id="pCat"><option>Dama</option><option>Caballero</option><option>Ni침o/Ni침a</option></select>
            <input type="number" id="pPrice" placeholder="Precio Docena">
            <input type="number" id="pStock" placeholder="Stock (Pares Totales)">
            <input type="text" id="pSize" placeholder="Tallas">
            <div class="file-upload" onclick="document.getElementById('fileInput').click()">
                <i class="fa-solid fa-camera"></i> Foto
                <img id="imgPreview" style="display:none;max-width:100%;height:100px;object-fit:contain;margin-top:10px;">
                <input type="file" id="fileInput" accept="image/*" style="display:none" onchange="compressAndPreview(this.files[0], 'imgPreview', 'prodImgBase64')">
            </div>
            <div style="display:flex; gap:10px; margin-top:20px;">
                <button class="btn btn-danger" onclick="closeModal('modalProd')">Cancelar</button>
                <button class="btn btn-success" onclick="saveProduct()">GUARDAR</button>
            </div>
        </div>
    </div>

    <!-- PRINT LAYOUT -->
    <div id="print-layer">
        <div style="font-family:monospace; padding:20px;">
            <center><h2 id="printBrand"></h2><p id="printDate"></p></center>
            <div id="printClientBlock" style="border-bottom:1px dashed #000; padding:10px 0; margin-bottom:10px;"></div>
            <table style="width:100%">
                <thead><tr><th align="left">Cant.</th><th align="left">Desc.</th><th align="right">Total</th></tr></thead>
                <tbody id="printBody"></tbody>
            </table>
            <h3 align="right" style="margin-top:20px;">Total: <span id="printTotal"></span></h3>
        </div>
    </div>

    <!-- FIREBASE -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>

    <script>
        // 1. CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyB5ygJIoEgpJPKY0qMULocohmzXGc7UWFE",
            authDomain: "worldstoresystem.firebaseapp.com",
            databaseURL: "https://worldstoresystem-default-rtdb.firebaseio.com",
            projectId: "worldstoresystem",
            storageBucket: "worldstoresystem.firebasestorage.app",
            messagingSenderId: "460628958914",
            appId: "1:460628958914:web:95da76852bedecbdcf255b"
        };
        try { firebase.initializeApp(firebaseConfig); } catch(e) { console.error("Firebase Error", e); }
        const dbRef = firebase.database();
        const auth = firebase.auth();

        // 2. STATE
        let db = [], historyPartial = [], fullHistoryCache = null;
        let cart = [], curFilter = 'all', saleItem = null, saleMode = 'doc';
        let config = { name:"WORLD STORE", color:"#D32F2F", currency:"$" };
        const PROFIT_DB_LOCAL = { "HY 001": 5.5 }; // Backup
        let PROFIT_DB = PROFIT_DB_LOCAL;

        // 3. STARTUP
        auth.onAuthStateChanged(u => {
            if(u) { document.getElementById('loginOverlay').style.display='none'; startSystem(); Toast.show("Sistema En L칤nea"); }
            else { document.getElementById('loginOverlay').style.display='flex'; }
        });

        window.appLogin = () => {
            const e = document.getElementById('txtEmail').value, p = document.getElementById('txtPass').value;
            const b = document.getElementById('btnLogin');
            if(!e||!p) return alert("Ingrese credenciales");
            b.innerText="Conectando..."; b.disabled=true;
            auth.signInWithEmailAndPassword(e,p).catch(err=>{ b.innerText="ENTRAR"; b.disabled=false; alert("Error de Acceso"); });
        }

        function startSystem() {
            // Config Load
            dbRef.ref('config').on('value', s => { if(s.val()) { config=s.val(); applyConfig(); } });

            // Inventory Load (Optimized)
            dbRef.ref('inventory').once('value').then(s => {
                db = s.val() || [];
                document.getElementById('loader').style.display='none';
                updateAllViews();
                
                // Realtime small updates
                const r = dbRef.ref('inventory');
                r.on('child_changed', s=>{ if(db[s.key]) db[s.key]=s.val(); renderPOS(); });
                r.on('child_added', s=>{ if(!db.find(x=>x.id===s.val().id)) db.push(s.val()); renderPOS(); });
                r.on('child_removed', s=>{ db=db.filter(x=>x.id!==s.val().id); renderPOS(); });
            });

            // History Load (Lazy - Partial)
            dbRef.ref('history').limitToLast(50).on('value', s => { 
                if(s.val()) historyPartial = Object.values(s.val()).sort((a,b) => b.id - a.id);
                if(document.getElementById('view-history').classList.contains('active')) {
                    renderHistoryUI();
                    refreshHistorySummary(); // Calcula total en segundo plano
                }
            });
        }

        // 4. RENDERING ENGINE
        let searchTimer;
        window.searchDelay = () => { clearTimeout(searchTimer); searchTimer = setTimeout(updateAllViews, 300); }

        window.updateAllViews = () => {
            if(document.getElementById('view-pos').classList.contains('active')) renderPOS();
            if(document.getElementById('view-inv').classList.contains('active')) renderInv();
        }

        function renderPOS() {
            if(config.maintenance) { document.getElementById('posGrid').innerHTML="<h3>Mantenimiento Activo</h3>"; return; }
            const g = document.getElementById('posGrid');
            const txt = document.getElementById('searchInput').value.toLowerCase();
            const list = db.filter(p => (curFilter==='all'||p.cat===curFilter) && (p.c.toLowerCase().includes(txt)||p.m.toLowerCase().includes(txt)));
            
            // Limit render to avoid crash
            const limit = 50; 
            let html = list.slice(0,limit).map(p => {
                const low = p.stock<12;
                return `<div class="card" onclick="openSale(${p.id})">
                    <div class="card-img-wrap"><img src="${p.img||'https://placehold.co/200'}" loading="lazy"><span class="badge-cat" style="background:${p.cat==='Dama'?'#E91E63':'#455A64'}">${p.cat.substr(0,3)}</span></div>
                    <div class="card-content">
                        <div><div style="font-weight:700">${p.c}</div><small>${p.m}</small></div>
                        <div style="margin-top:auto;display:flex;justify-content:space-between;align-items:center">
                            <span class="stock" style="color:${low?'red':'green'}">${p.stock}</span>
                            <span class="price">${config.currency}${p.d}</span>
                        </div>
                    </div>
                </div>`;
            }).join('');
            if(list.length>limit) html += `<div style="grid-column:1/-1;text-align:center;padding:20px;">... busque para ver m치s (${list.length-limit} ocultos) ...</div>`;
            g.innerHTML = html || "<div style='text-align:center;padding:40px'>Sin Resultados</div>";
        }

        function renderInv() {
            const t = document.getElementById('invBody');
            const txt = document.getElementById('searchInput').value.toLowerCase();
            // L칤mite tabla
            t.innerHTML = db.filter(p=>p.c.toLowerCase().includes(txt)).slice(0,100).map(p => `<tr>
                <td><img src="${p.img||''}" style="width:40px;height:40px;object-fit:cover;border-radius:4px;"></td>
                <td><b>${p.c}</b><br><small>${p.m}</small></td>
                <td>${p.d}</td>
                <td><b>${p.stock}</b></td>
                <td>
                    <button class="btn" style="width:auto;padding:5px 10px;background:#eee;color:#333" onclick="openEdit(${p.id})"><i class="fa-solid fa-pen"></i></button>
                    <button class="btn" style="width:auto;padding:5px 10px;background:var(--primary);color:#fff" onclick="delProd(${p.id})"><i class="fa-solid fa-trash"></i></button>
                </td>
            </tr>`).join('');
        }

        // 5. TRANSACTIONAL SALES CORE
        window.openSale = (id) => {
            saleItem = db.find(x => x.id === id); if(!saleItem) return;
            document.getElementById('saleTitle').innerText = saleItem.c;
            document.getElementById('saleQty').value=1; setSaleType('doc');
            document.getElementById('modalSale').style.display='flex';
        }

        window.setSaleType = (t) => {
            saleMode = t; updateCalc();
            ['doc','half','unit'].forEach(k => { 
                const b=document.getElementById('btn-'+k); 
                b.style.background = k===t?config.color:'#eee'; b.style.color=k===t?'#fff':'#333'; 
            });
        }

        window.updateCalc = () => {
            const q = parseInt(document.getElementById('saleQty').value)||1;
            let u = saleItem.d; 
            if(saleMode==='half') u=saleItem.d/2; if(saleMode==='unit') u=saleItem.d/12;
            document.getElementById('saleTotalCalc').innerText = `${config.currency}${(u*q).toFixed(2)}`;
            document.getElementById('unitPriceDisplay').innerText = `Base: ${u.toFixed(2)}`;
        }
        
        window.adjQty = (n) => { let v=parseInt(document.getElementById('saleQty').value)+n; if(v<1)v=1; document.getElementById('saleQty').value=v; updateCalc(); }

        window.confirmAdd = () => {
            const q = parseInt(document.getElementById('saleQty').value);
            const deduct = (saleMode==='doc'?12:(saleMode==='half'?6:1)) * q;
            const total = parseFloat(document.getElementById('saleTotalCalc').innerText.replace(/[^0-9.]/g,''));
            cart.push({ pId:saleItem.id, c:saleItem.c, qtyTxt:`${q} ${saleMode}`, deduct, total });
            closeModal('modalSale'); renderCart(); toggleCart(); Toast.show("Agregado");
        }

        window.processSale = () => {
            if(cart.length===0 || !document.getElementById('cartClientName').value) return alert("Revise carrito y cliente.");
            const btn = document.getElementById('btnProcessSale'); btn.disabled=true; btn.innerText="Procesando...";
            
            // TRANSACCI칍N AT칍MICA
            dbRef.ref('inventory').transaction(inv => {
                if(!inv) return inv;
                for(let item of cart) {
                    const idx = inv.findIndex(p => p.id === item.pId);
                    if(idx === -1) throw "Producto borrado"; 
                    if(inv[idx].stock < item.deduct) throw `Stock bajo: ${inv[idx].c}`;
                    inv[idx].stock -= item.deduct;
                }
                return inv;
            }, (err, ok) => {
                btn.disabled=false; btn.innerText="CONFIRMAR VENTA";
                if(err) return alert("Error: "+(err.message||"Fallo Inventario"));
                if(ok) {
                    const rec = { 
                        id:Date.now(), date:new Date().toLocaleString(), client:document.getElementById('cartClientName').value,
                        total: cart.reduce((a,b)=>a+b.total,0), items:cart, 
                        desc: cart.map(x=>x.qtyTxt+" "+x.c).join(', ')
                    };
                    dbRef.ref('history').push(rec);
                    printFromData(rec);
                    cart=[]; document.getElementById('cartClientName').value="";
                    renderCart(); toggleCart(); Toast.show("Venta Registrada Correctamente");
                }
            });
        }

        // 6. HISTORY & PROFIT ENGINE (Surgical Logic)
        
        // Suma en segundo plano para el Dashboard
        window.refreshHistorySummary = function() {
            // Si ya cargamos todo, usa memoria. Si no, fetch ligero solo de valores.
            const uiList = fullHistoryCache || historyPartial;
            
            if(!fullHistoryCache) {
                // C치lculo as칤ncrono "Quiet fetch"
                dbRef.ref('history').once('value').then(s => {
                    const val = s.val(); 
                    if(val) {
                        const all = Object.values(val);
                        const totalMoney = all.reduce((a,b)=>a+(parseFloat(b.total)||0), 0);
                        document.getElementById('historyTotalRevenue').innerText = config.currency + totalMoney.toFixed(2);
                        document.getElementById('historyCount').innerText = all.length;
                    }
                });
            } else {
                const totalMoney = fullHistoryCache.reduce((a,b)=>a+(parseFloat(b.total)||0), 0);
                document.getElementById('historyTotalRevenue').innerText = config.currency + totalMoney.toFixed(2);
                document.getElementById('historyCount').innerText = fullHistoryCache.length;
            }
        }

        // Carga forzada de la tabla completa
        window.forceLoadAllHistory = function() {
            const b = document.getElementById('btnLoadAllHist'); b.innerHTML="Cargando..."; b.disabled=true;
            dbRef.ref('history').once('value').then(s => {
                const val = s.val();
                fullHistoryCache = val ? Object.values(val).sort((a,b)=>b.id-a.id) : [];
                renderHistoryUI(); refreshHistorySummary();
                b.style.display='none'; document.getElementById('historyStatusLabel').innerText="Registro Completo";
            });
        }

        function renderHistoryUI() {
            const list = fullHistoryCache || historyPartial;
            document.getElementById('histBody').innerHTML = list.map(h => `<tr>
                <td>${h.date.split(',')[0]}</td><td><b>${h.client}</b></td><td><small>${h.items.length} sku</small></td>
                <td><b>${config.currency}${parseFloat(h.total).toFixed(2)}</b></td>
                <td>
                    <i class="fa-solid fa-print" onclick="reprint(${h.id})" style="margin-right:10px;cursor:pointer"></i>
                    <i class="fa-solid fa-rotate-left" onclick="delHist(${h.id})" style="color:red;cursor:pointer" title="Devolver"></i>
                </td>
            </tr>`).join('');
        }

        function renderProfit() {
            // Profit usa full cache si existe
            const list = fullHistoryCache || historyPartial; 
            let gt = 0;
            const rows = list.map(h => {
                let p = 0;
                h.items.forEach(i => {
                     const base = PROFIT_DB[i.c] || 5.5; // Default Utility
                     p += (base/12)*i.deduct; 
                });
                gt += p;
                return `<tr><td>${h.date.split(' ')[0]}</td><td>${h.client}</td><td>${h.total.toFixed(2)}</td><td style="color:green">+${p.toFixed(2)}</td></tr>`;
            });
            document.getElementById('profitBody').innerHTML = rows.join('');
            document.getElementById('totalProfitDisplay').innerText = config.currency + gt.toFixed(2);
        }

        // DEVOLUCI칍N SEGURA
        window.delHist = (id) => {
            if(!confirm("쮻evolver venta y retornar stock?")) return;
            // Fetch de la venta espec칤fica primero
            dbRef.ref('history').orderByChild('id').equalTo(id).once('value').then(snap => {
                if(!snap.exists()) return alert("Error: No encontrada");
                const k = Object.keys(snap.val())[0]; const sale = snap.val()[k];
                
                // Transacci칩n inversa
                dbRef.ref('inventory').transaction(inv => {
                    if(!inv) return inv;
                    sale.items.forEach(i => {
                        const x = inv.findIndex(p => p.id === i.pId);
                        if(x!==-1) inv[x].stock += i.deduct; 
                    });
                    return inv;
                }, (err, ok) => {
                    if(ok) {
                        dbRef.ref('history/'+k).remove();
                        if(fullHistoryCache) fullHistoryCache = fullHistoryCache.filter(x=>x.id!==id);
                        renderHistoryUI(); Toast.show("Devoluci칩n Exitosa");
                    }
                });
            });
        }

        // 7. PRODUCT MANAGEMENT & HELPERS
        window.openEdit = (id) => {
            const p = db.find(x => x.id === id); if(!p) return;
            // Mapping de campos seguro
            document.getElementById('prodId').value=p.id;
            document.getElementById('pModel').value=p.m; document.getElementById('pCode').value=p.c;
            document.getElementById('pCat').value=p.cat; document.getElementById('pPrice').value=p.d;
            document.getElementById('pStock').value=p.stock; document.getElementById('pSize').value=p.t||"";
            document.getElementById('imgPreview').src=p.img||""; document.getElementById('imgPreview').style.display=p.img?'block':'none';
            document.getElementById('prodImgBase64').value=p.img||"";
            document.getElementById('modalProdTitle').innerText="Editar Producto";
            document.getElementById('modalProd').style.display='flex';
        }

        window.saveProduct = () => {
            const id = document.getElementById('prodId').value;
            const dat = {
                c: document.getElementById('pCode').value, m: document.getElementById('pModel').value,
                cat: document.getElementById('pCat').value, d: parseFloat(document.getElementById('pPrice').value)||0,
                stock: parseInt(document.getElementById('pStock').value)||0, t: document.getElementById('pSize').value,
                img: document.getElementById('prodImgBase64').value
            };
            dbRef.ref('inventory').transaction(arr => {
                if(!arr) arr = [];
                if(id) { const i=arr.findIndex(x=>x.id==id); if(i!==-1) arr[i]={...arr[i],...dat}; }
                else { arr.unshift({...dat, id:Date.now()}); }
                return arr;
            }, (e,s) => { if(s) { closeModal('modalProd'); Toast.show("Producto Guardado"); } });
        }
        
        window.delProd = (id) => { if(confirm("쮼liminar?")) dbRef.ref('inventory').transaction(a => a?a.filter(x=>x.id!=id):a); }

        window.nav = (v,e) => {
            document.querySelectorAll('.view-panel').forEach(x=>x.classList.remove('active'));
            document.getElementById('view-'+v).classList.add('active');
            if(e) { document.querySelectorAll('.nav-item').forEach(x=>x.classList.remove('active')); e.classList.add('active'); }
            
            if(v==='pos') updateAllViews();
            if(v==='history') { renderHistoryUI(); refreshHistorySummary(); }
            if(v==='profit') { if(!fullHistoryCache) forceLoadAllHistory(); else renderProfit(); } // Auto load on profit view
        }

        // Utils
        window.closeModal = (id) => document.getElementById(id).style.display='none';
        window.openModalProd = () => { 
            ['pCode','pModel','pPrice','pStock','pSize','prodId','prodImgBase64'].forEach(k=>document.getElementById(k).value="");
            document.getElementById('imgPreview').style.display='none';
            document.getElementById('modalProdTitle').innerText="Nuevo Producto";
            document.getElementById('modalProd').style.display='flex'; 
        }
        window.filterCat = (c,e) => { curFilter=c; document.querySelectorAll('.chip').forEach(x=>x.classList.remove('active')); e.classList.add('active'); renderPOS(); }
        window.renderCart = () => {
            const c = document.getElementById('cartContainer');
            c.innerHTML = cart.length ? cart.map((i,x)=>`<div class="c-item"><div><b>${i.c}</b> <small>x${i.qtyTxt}</small></div><div style="text-align:right"><b>${config.currency}${i.total.toFixed(2)}</b><br><small onclick="cart.splice(${x},1);renderCart()" style="color:red;cursor:pointer">Quitar</small></div></div>`).join('') : '<p align="center" style="color:#aaa">Vac칤o</p>';
            document.getElementById('cartTotalDisplay').innerText = config.currency+cart.reduce((a,b)=>a+b.total,0).toFixed(2);
            document.getElementById('cartCountBadge').innerText = cart.length;
        }
        window.toggleCart = () => { document.getElementById('cartDrawer').classList.toggle('open'); document.getElementById('mainOverlay').classList.toggle('active'); }
        window.saveConfig = () => {
            config.name = document.getElementById('cfgName').value;
            config.color = document.getElementById('cfgColor').value;
            config.maintenance = document.getElementById('cfgMaintenance').checked;
            config.logo = document.getElementById('cfgLogoData').value;
            dbRef.ref('config').set(config).then(()=>Toast.show("Ajustes Guardados"));
        }
        window.applyConfig = () => {
            document.documentElement.style.setProperty('--primary', config.color);
            document.getElementById('brandName').innerText = config.name;
            if(config.logo) document.querySelectorAll('#displayLogoSidebar, #loginLogo, #cfgLogoPreview').forEach(x=>{x.src=config.logo; x.style.display='block'});
            document.getElementById('cfgName').value=config.name; document.getElementById('cfgColor').value=config.color;
            document.getElementById('cfgMaintenance').checked=config.maintenance||false;
        }
        
        window.compressAndPreview = (f, img, inp) => {
            if(!f) return; const r = new FileReader();
            r.onload = e => { 
                const i=new Image(); 
                i.onload = () => { 
                    const c=document.createElement('canvas'); 
                    let w=i.width, h=i.height, m=350; // Compress
                    if(w>h&&w>m){h*=m/w;w=m} else if(h>m){w*=m/h;h=m}
                    c.width=w;c.height=h; c.getContext('2d').drawImage(i,0,0,w,h);
                    const d=c.toDataURL('image/jpeg',0.5); 
                    document.getElementById(img).src=d; document.getElementById(img).style.display='block';
                    document.getElementById(inp).value=d;
                }; i.src=e.target.result; 
            }; r.readAsDataURL(f);
        }

        window.reprint = (id) => { const h=(fullHistoryCache||historyPartial).find(x=>x.id==id); if(h) printFromData(h); }
        window.printFromData = (rec) => {
            document.getElementById('printBrand').innerText = config.name; document.getElementById('printDate').innerText = rec.date;
            document.getElementById('printClientBlock').innerText = `Cliente: ${rec.client} | ID: ${rec.id}`;
            document.getElementById('printBody').innerHTML = rec.items.map(i=>`<tr><td>${i.qtyTxt}</td><td>${i.c}</td><td align="right">${config.currency}${i.total.toFixed(2)}</td></tr>`).join('');
            document.getElementById('printTotal').innerText = config.currency+rec.total.toFixed(2);
            setTimeout(()=>window.print(), 300);
        }
        window.previewColor = (v) => document.documentElement.style.setProperty('--primary', v);

        const Toast = { show: (m) => { const d=document.createElement('div'); d.className='toast'; d.innerHTML=`<i class="fa-solid fa-check"></i> ${m}`; document.body.appendChild(d); setTimeout(()=>d.remove(), 3000); } }
    </script>
</body>
</html>
